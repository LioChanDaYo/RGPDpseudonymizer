# Story 6.4.1: Validation UI Visual Feedback Fixes - Bug Fix

## Status

**Ready for Implementation**

---

## Story

**As a** user reviewing entities in the validation interface,
**I want** clear visual feedback when selecting and accepting entities in both light and dark modes,
**So that** I can effectively use the multi-select checkboxes and see which entities I've already reviewed.

---

## Story Context

**Defect Source:** Discovered during user testing of Story 6.4 (Visual Entity Validation Interface)

**Existing System Integration:**
- Integrates with: `EntityPanel` widget ([entity_panel.py](../../gdpr_pseudonymizer/gui/widgets/entity_panel.py)), `EntityEditor` widget ([entity_editor.py](../../gdpr_pseudonymizer/gui/widgets/entity_editor.py))
- Technology: PySide6 (Qt6), QListWidget with ItemIsUserCheckable, QTextEdit with setExtraSelections
- Follows pattern: Existing entity highlighting pattern from Story 6.4 (lines 106-149 of entity_editor.py)
- Touch points: QSS stylesheet (gui/styles.qss or inline styles), `_apply_highlights()` method in EntityEditor

**Root Causes:**

1. **BUG-UX-002 (CRITICAL):** Qt native checkbox indicators in `QListWidget` blend with light-mode background, making checkboxes invisible. Checkboxes work correctly in dark mode due to sufficient contrast. This makes the multi-select bulk action feature completely unusable in light mode (the default theme).

2. **BUG-UX-003 (MEDIUM):** When user accepts an entity (○ → ✓ status change), the sidebar icon updates but the document view highlighting remains unchanged. Users cannot see at a glance which entities they've reviewed in the document itself, requiring constant cross-reference with the sidebar. The UX spec (Story 6.4 line 111) shows precedent for state-based color changes ("Known entities: 50% opacity") but doesn't apply to manually accepted entities.

---

## Acceptance Criteria

### Functional Requirements

1. **AC1 - Checkbox Visibility (Light Mode):** In light theme, checkboxes are clearly visible next to each entity in the sidebar with:
   - Unchecked: visible border/outline (e.g., 2px solid #666 border, white background)
   - Checked: visually distinct (e.g., blue background #1976D2 with checkmark)
   - Minimum size: 16px × 16px for touch-friendly interaction

2. **AC2 - Checkbox Visibility (Dark Mode):** In dark theme, checkboxes maintain current visibility and contrast (already working, verify no regression)

3. **AC3 - Accepted Entity Visual Feedback:** When an entity is accepted (status: CONFIRMED), its highlight in the document view shows a **2px solid green border** (#2E7D32 in light mode, #66BB6A in dark mode) around the entity text, in addition to the existing background color
   - Pending entities (○): background color only (existing behavior)
   - Accepted entities (✓): background color + 2px green border (new)
   - Rejected entities (✗): red background + strikethrough (existing, unchanged)
   - Known entities (auto-accepted): background color + 2px green border (consistent with manual accept)

4. **AC4 - State Synchronization:** When user accepts/rejects an entity via context menu or bulk actions, the document view highlight updates immediately (within 100ms perceived instant response)

### Integration Requirements

5. **AC5 - Existing Functionality Preserved:** All existing validation features continue to work unchanged:
   - Bulk selection via checkboxes
   - "Accepter la sélection" / "Rejeter la sélection" buttons
   - Context menu actions (accept, reject, modify, etc.)
   - Keyboard navigation (Enter to accept, Delete to reject)
   - Undo/redo functionality

6. **AC6 - Pattern Consistency:** Visual styling follows existing entity color scheme and theming patterns from Story 6.4

### Quality Requirements

7. **AC7 - Test Coverage:** New/updated tests verify:
   - Checkbox rendering in both themes (visual regression test or manual verification)
   - Accepted entity border rendering in document view
   - State synchronization (accept → border appears, undo → border removed)

8. **AC8 - No Performance Regression:** Entity highlighting performance remains <100ms for 100+ entities (existing AC8 from Story 6.4)

9. **AC9 - Cross-Platform Verification:** Checkbox visibility verified on Windows (primary), macOS (if available), Linux (if available)

---

## Technical Notes

### Fix Approach - Checkbox Visibility

**Recommended Solution:** Add explicit QSS stylesheet rules to override Qt native checkbox rendering:

```css
/* Light mode checkbox styling */
QListWidget::indicator:unchecked {
    border: 2px solid #666;
    background: white;
    width: 16px;
    height: 16px;
    border-radius: 2px;
}

QListWidget::indicator:checked {
    border: 2px solid #1976D2;
    background: #1976D2;
    width: 16px;
    height: 16px;
    border-radius: 2px;
    image: url(:/icons/checkmark-white.png); /* or use unicode ✓ */
}

/* Dark mode checkbox styling */
QListWidget[theme="dark"]::indicator:unchecked {
    border: 2px solid #AAA;
    background: #424242;
}

QListWidget[theme="dark"]::indicator:checked {
    border: 2px solid #64B5F6;
    background: #1976D2;
}
```

**Implementation Location:**
- If global stylesheet exists: add to `gui/styles.qss` or similar
- If inline styles: add to `EntityPanel.__init__()` via `self._list_widget.setStyleSheet()`

**Alternative (if QSS doesn't work):** Replace native checkboxes with custom `QCheckBox` widgets added to each list item via `setItemWidget()` (more complex, fallback option)

### Fix Approach - Accepted Entity Visual Feedback

**Implementation:** Modify `EntityEditor._apply_highlights()` ([entity_editor.py:147-200](../../gdpr_pseudonymizer/gui/widgets/entity_editor.py#L147-L200))

**Current logic:**
```python
def _apply_highlights(self) -> None:
    # ... existing code ...
    for review in all_entities:
        fmt = QTextCharFormat()
        if review.state.value == "rejected" and not self._hide_rejected:
            # Red + strikethrough
        else:
            # Apply type-based background color
```

**Updated logic:**
```python
def _apply_highlights(self) -> None:
    # ... existing code ...
    for review in all_entities:
        fmt = QTextCharFormat()

        if review.state.value == "rejected" and not self._hide_rejected:
            # Red + strikethrough (existing)
            bg, fg = _REJECTED_LIGHT if not self._dark_theme else _REJECTED_DARK
            fmt.setBackground(QColor(bg))
            fmt.setForeground(QColor(fg))
            fmt.setFontStrikeOut(True)
        else:
            # Apply type-based background color (existing)
            colors = _DARK_COLORS if self._dark_theme else _LIGHT_COLORS
            bg, fg = colors.get(review.entity.entity_type, ("#EEE", "#333"))
            fmt.setBackground(QColor(bg))
            fmt.setForeground(QColor(fg))

            # NEW: Add green border for accepted/known entities
            if review.state.value in ("confirmed", "added") or self._validation_state.is_entity_known(review.entity_id):
                border_color = "#2E7D32" if not self._dark_theme else "#66BB6A"
                fmt.setProperty(QTextFormat.OutlinePen, QPen(QColor(border_color), 2))
                # NOTE: QTextCharFormat doesn't support outline directly
                # May need to use TextBlockFormat or draw border via custom painting
```

**Challenge:** `QTextCharFormat` doesn't natively support borders. **Workaround options:**
1. Use `QTextCharFormat.setTextOutline()` with `QPen` (Qt 6.x feature, verify availability)
2. Use underline with thick green line: `fmt.setUnderlineStyle(QTextCharFormat.UnderlineStyle.SingleUnderline)` + `fmt.setUnderlineColor(QColor("#2E7D32"))`
3. Custom painting via `QSyntaxHighlighter` or `paintEvent()` override (more complex)

**Recommended:** Start with option 2 (thick underline) as a simple, reliable solution. If underline doesn't provide the desired visual effect, escalate to custom painting.

### Existing Pattern Reference

- Entity highlighting: [entity_editor.py:147-200](../../gdpr_pseudonymizer/gui/widgets/entity_editor.py#L147-L200)
- Color scheme: [entity_editor.py:26-41](../../gdpr_pseudonymizer/gui/widgets/entity_editor.py#L26-L41)
- Known entity opacity handling (precedent): Story 6.4 line 111 (50% opacity for known entities)

### Key Constraints

- Must work in both PySide6 light and dark themes
- No breaking changes to existing entity highlighting architecture
- Performance: <100ms highlight refresh for 100+ entities (existing AC8)
- Cross-platform compatibility: Windows (primary), macOS, Linux

---

## Definition of Done

- [x] **AC1:** Checkboxes clearly visible in light mode (border + background styling)
- [x] **AC2:** Checkboxes maintain visibility in dark mode (no regression)
- [x] **AC3:** Accepted entities show green border/underline in document view
- [x] **AC4:** State changes reflect immediately in document view (<100ms)
- [x] **AC5:** All existing validation functionality works unchanged
- [x] **AC6:** Visual styling follows existing theme patterns
- [x] **AC7:** Tests updated/added for new visual states
- [x] **AC8:** No performance regression (<100ms for 100+ entities)
- [x] **AC9:** Checkbox visibility verified on primary platform (Windows)
- [x] Code follows existing patterns and coding standards
- [x] Full test suite passes (no regressions)
- [x] Manual testing confirms fixes in both themes

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** QSS stylesheet conflicts or Qt version differences cause checkbox styling to fail on some platforms

**Mitigation:**
- Test on target Qt version (current project PySide6 version)
- Fallback to custom `QCheckBox` widgets if QSS approach fails
- Manual verification on Windows (primary platform)

**Rollback:**
- Checkbox fix: Remove QSS rules (reverts to native rendering, dark mode still works)
- Border fix: Remove green border logic from `_apply_highlights()` (reverts to original behavior)
- Git revert commit if needed (isolated changes)

### Compatibility Verification

- [x] No breaking changes to existing APIs (only internal widget styling changes)
- [x] No database changes
- [x] UI changes follow existing design patterns (entity highlighting, theming)
- [x] Performance impact negligible (adding border/underline to existing highlight loop)

---

## Tasks / Subtasks

- [ ] **Task 1: Fix checkbox visibility in light mode** (AC1, AC2, AC9)
  - [ ] Add QSS stylesheet rules for light mode checkbox styling (unchecked: border #666, checked: blue #1976D2)
  - [ ] Add QSS stylesheet rules for dark mode checkbox styling (verify no regression)
  - [ ] Apply stylesheet to `EntityPanel._list_widget` in `_build_ui()`
  - [ ] Manual verification: open validation screen in light mode, verify checkboxes visible and clickable
  - [ ] Manual verification: switch to dark mode, verify checkboxes still visible
  - [ ] If QSS fails: implement fallback with custom `QCheckBox` widgets via `setItemWidget()`

- [ ] **Task 2: Add green border for accepted entities** (AC3, AC4, AC6)
  - [ ] Update `EntityEditor._apply_highlights()` to detect accepted/known entities
  - [ ] Apply green underline (option 2) or border (option 1) to accepted entity highlights
    - Light mode: `#2E7D32` (green)
    - Dark mode: `#66BB6A` (light green)
  - [ ] Verify state synchronization: accept entity → border appears immediately
  - [ ] Verify undo: undo accept → border removed immediately
  - [ ] Test with known entities (auto-accepted) → should also show green border

- [ ] **Task 3: Update tests** (AC7)
  - [ ] Update `tests/unit/gui/test_entity_editor.py`:
    - [ ] Add test: accepted entity shows green underline/border in highlight
    - [ ] Add test: pending entity has no border
    - [ ] Add test: rejected entity has red strikethrough (existing, verify unchanged)
    - [ ] Add test: known entity shows green underline/border
  - [ ] Update `tests/unit/gui/test_entity_panel.py`:
    - [ ] Add test: verify checkbox stylesheet applied (check `_list_widget.styleSheet()` not empty)
  - [ ] Optional: Add visual regression test (screenshot comparison) if tooling available

- [ ] **Task 4: Quality gates** (AC5, AC8, AC9)
  - [ ] Run full existing test suite: `poetry run pytest tests/`
  - [ ] Manual end-to-end test: validation screen → select entities → bulk accept → verify checkboxes and borders
  - [ ] Performance test: load validation screen with 100+ entities → verify <500ms load, <100ms highlight refresh
  - [ ] `poetry run black --check gdpr_pseudonymizer/ tests/`
  - [ ] `poetry run ruff check gdpr_pseudonymizer/`
  - [ ] `poetry run mypy gdpr_pseudonymizer/`
  - [ ] Cross-platform verification (Windows required, macOS/Linux if available)

---

## Validation Checklist

### Scope Validation
- [x] Story can be completed in one development session (2-4 hours estimated)
- [x] Integration approach is straightforward (modify existing widgets, add QSS rules)
- [x] Follows existing patterns exactly (entity highlighting, theming)
- [x] No design or architecture work required (visual polish only)

### Clarity Check
- [x] Story requirements are unambiguous (checkbox visibility + green border)
- [x] Integration points are clearly specified (EntityPanel, EntityEditor)
- [x] Success criteria are testable (visual verification + automated tests)
- [x] Rollback approach is simple (remove QSS rules / revert border logic)

---

## File List

### Modified Files
- `gdpr_pseudonymizer/gui/widgets/entity_panel.py` — Add QSS stylesheet for checkbox visibility
- `gdpr_pseudonymizer/gui/widgets/entity_editor.py` — Add green border/underline for accepted entities in `_apply_highlights()`
- `tests/unit/gui/test_entity_editor.py` — Add tests for accepted entity border
- `tests/unit/gui/test_entity_panel.py` — Add test for checkbox stylesheet

### New Files
- None (bug fix only)

---

## Dev Notes

### Qt Checkbox Styling References

- [Qt QListWidget Styling Documentation](https://doc.qt.io/qt-6/stylesheet-examples.html#customizing-qlistview)
- Known issue: Qt native checkboxes can blend with background on some platforms/themes
- QSS `::indicator` pseudo-element allows full checkbox customization

### QTextCharFormat Border Workarounds

Since `QTextCharFormat` doesn't natively support borders in Qt 5.x/6.x:

1. **Underline approach (recommended):**
   ```python
   fmt.setUnderlineStyle(QTextCharFormat.UnderlineStyle.SingleUnderline)
   fmt.setUnderlineColor(QColor("#2E7D32"))
   ```
   - Simple, reliable, built-in Qt feature
   - Visual effect: green line under entity text (not a full border, but clear indicator)

2. **TextOutline approach (if available in Qt 6.x):**
   ```python
   pen = QPen(QColor("#2E7D32"), 2)
   fmt.setTextOutline(pen)  # May not exist in all Qt versions
   ```
   - Check Qt version compatibility first

3. **Custom painting (fallback if needed):**
   - Override `paintEvent()` or use `QSyntaxHighlighter`
   - More complex, only if simpler approaches fail

**Recommendation:** Start with underline (option 1). If user feedback prefers full border, escalate to custom painting in a follow-up story.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-19 | 1.0 | Initial bug-fix story creation from user testing feedback on Story 6.4 | John (Product Manager Agent) |
