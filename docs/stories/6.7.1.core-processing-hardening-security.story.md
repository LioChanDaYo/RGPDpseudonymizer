# Story 6.7.1: Core Processing Hardening & Security

## Status

**Done**

---

## Story

**As a** GDPR compliance officer relying on this tool,
**I want** the core processing pipeline to sanitize error messages, eliminate code duplication, use typed exception handling, and have comprehensive test coverage,
**so that** no PII can leak through error logs/audit records, the codebase is maintainable, and regressions are caught before release.

---

## Acceptance Criteria

### Security Hardening

1. **AC1 — PII Sanitization in Error Messages (SEC-001):**
   - Error messages logged to the audit database (`_log_failed_operation`) MUST NOT contain entity text or any other PII
   - Error messages emitted to structlog (`logger.error`) MUST NOT contain PII
   - A sanitization function strips known PII patterns (entity names, file content fragments) from exception strings before logging
   - The sanitization function is unit-tested with representative NLP exception messages

2. **AC2 — Typed Exception Handling (EXC-001):**
   - `_build_pseudonym_assigner` catches specific exceptions (`ValueError`, `RuntimeError`) instead of bare `except Exception`
   - `_get_model_version` catches specific exceptions (`OSError`, `AttributeError`) instead of bare `except Exception`
   - Top-level `process_document` and `finalize_document` continue to catch `Exception` (by design — top-level workflow must not crash) but log the exception **type** for diagnostics
   - No silent `pass` in any except block — all caught exceptions produce at least a `logger.warning`

### Code Quality

3. **AC3 — DRY: Entity Text Normalization (DRY-001):**
   - The repeated strip_titles + strip_prepositions pattern (currently in `_build_pseudonym_assigner`, `_run_validation`, `_resolve_pseudonyms`) is extracted to a single `_normalize_entity_text(ctx, entity)` helper method
   - All three call sites use the new helper
   - No behavioral change — pure refactoring

### Test Coverage

4. **AC4 — GUI-Phase Method Tests (TEST-001):**
   - Unit tests cover `DocumentProcessor.detect_entities()`
   - Unit tests cover `DocumentProcessor.build_pseudonym_previews()`
   - Unit tests cover `DocumentProcessor.finalize_document()`
   - Each method tested with at least: happy path, empty input, error case

5. **AC5 — Error Case Tests (TEST-002):**
   - Test: database corruption / `EncryptionError` during processing
   - Test: `save_batch` failure (database write error)
   - Test: `KeyboardInterrupt` during validation propagates correctly
   - Test: invalid passphrase produces clean failure result

6. **AC6 — Integration Test with Real Repository (TEST-003):**
   - At least one integration test uses a real `SQLiteMappingRepository` with an in-memory SQLite database (`:memory:`)
   - Test exercises the full `process_document` workflow: detection → pseudonym assignment → DB save → output write
   - Validates actual data flow end-to-end, not mock wiring

### Carry-Forward

7. **AC7 — DATA-001 Fix (Entity Type Count Query):**
   - `ProcessingWorker` entity type count query (`processing_worker.py:198-205`) is fixed to count only entities from the current document, not cumulative DB totals
   - Options: filter to current-document entities via the `ProcessingResult`, or add per-type counts to `ProcessingResult` / `GUIProcessingResult` directly
   - Results screen displays correct per-document counts

### Regression

8. **AC8 — No Regression:**
   - All existing tests pass (CLI + GUI)
   - Quality gates pass (Black, Ruff, mypy)
   - Coverage >= 86%

---

## Tasks / Subtasks

### Phase 1 — Security Hardening (AC: 1, 2)

- [x] **Task 1: Implement PII sanitization for error messages** (AC: 1)
  - [x] 1.1: Create `_sanitize_error_message(error: Exception) -> str` method on `DocumentProcessor` (or a standalone utility in `utils/`)
  - [x] 1.2: Strip entity text patterns from exception messages (regex-based: remove quoted strings, known entity patterns)
  - [x] 1.3: Replace `str(error)` / `f"{type(error).__name__}: {error}"` in `_handle_processing_error` with sanitized version
  - [x] 1.4: Audit **all** `logger.error(...)` calls in `document_processor.py` for PII leakage — apply sanitization where needed. Known PII leak vectors beyond `_handle_processing_error`:
    - Line 509: `logger.error("batch_save_failed", error=str(e), ...)` in `_resolve_pseudonyms` — database exception may contain entity text
    - Line 881: `logger.error("audit_logging_failed", error=str(e))` in `_log_failed_operation` — same risk
  - [x] 1.5: Write unit tests for sanitization function with NLP-style exception messages (e.g., `ValueError: Cannot parse entity 'Jean Dupont'`)

- [x] **Task 2: Replace broad exception handlers with typed exceptions** (AC: 2)
  - [x] 2.1: In `_build_pseudonym_assigner` (line 233): replace `except Exception` with `except (ValueError, RuntimeError)` — log warning instead of silent fallback
  - [x] 2.2: In `_get_model_version` (line 845): replace `except Exception: pass` with `except (OSError, AttributeError) as e: logger.warning(...)`. **Note:** verify that `_get_detector()` cannot also raise `ModelNotFoundError` or `ImportError` — if it can, add those to the catch list
  - [x] 2.3: Verify `process_document` and `finalize_document` top-level catches log `type(error).__name__` for diagnostics
  - [x] 2.4: Scan for any other bare `except Exception` in `document_processor.py` — tighten where safe. Full inventory of bare catches:
    - Line 233: `_build_pseudonym_assigner` — **Task 2.1**
    - Line 506: `_resolve_pseudonyms` `save_batch` failure — keep broad (re-raises), but apply PII sanitization to logger at line 509
    - Line 780: `finalize_document` top-level — keep broad by design (AC2)
    - Line 827: `process_document` top-level — keep broad by design (AC2)
    - Line 845: `_get_model_version` — **Task 2.2**
    - Line 879: `_log_failed_operation` audit logging — keep broad (non-fatal fallback), but apply PII sanitization to logger at line 881

### Phase 2 — Code Quality (AC: 3)

- [x] **Task 3: Extract entity text normalization helper** (AC: 3)
  - [x] 3.1: Add `_normalize_entity_text(self, ctx: _ProcessingContext, entity: DetectedEntity) -> str` method to `DocumentProcessor`
  - [x] 3.2: Refactor `_build_pseudonym_assigner` to use `_normalize_entity_text`
  - [x] 3.3: Refactor `_run_validation` to use `_normalize_entity_text`
  - [x] 3.4: Refactor `_resolve_pseudonyms` to use `_normalize_entity_text`
  - [x] 3.5: Run existing tests — verify no behavioral change

### Phase 3 — Test Coverage (AC: 4, 5, 6)

- [x] **Task 4: Add unit tests for GUI-phase methods** (AC: 4)
  - [x] 4.1: Test `detect_entities()` — happy path with mocked detector, empty document, entity type filter
  - [x] 4.2: Test `build_pseudonym_previews()` — happy path with existing mappings, new entities, title preservation
  - [x] 4.3: Test `finalize_document()` — happy path, error during processing

- [x] **Task 5: Add error case tests** (AC: 5)
  - [x] 5.1: Test `process_document` with database corruption (mock `open_database` to raise `EncryptionError`)
  - [x] 5.2: Test `process_document` with `save_batch` failure (mock repo raises `DatabaseError`)
  - [x] 5.3: Test `_run_validation` propagates `KeyboardInterrupt`
  - [x] 5.4: Test `process_document` with invalid passphrase (mock `open_database` raises `ValueError`)

- [x] **Task 6: Add integration test with real SQLite repository** (AC: 6)
  - [x] 6.1: Create `tests/integration/test_document_processor_integration.py`
  - [x] 6.2: Set up real SQLite database with `init_database(tmp_path, passphrase)`
  - [x] 6.3: Write end-to-end test: create real repos → process real document text → verify entities saved → verify output contains pseudonyms
  - [x] 6.4: Test idempotency: process same document twice → verify reuse, no duplicates

### Phase 4 — Carry-Forward Fix (AC: 7)

- [x] **Task 7: Fix DATA-001 — Entity type count in ProcessingWorker** (AC: 7)
  - [x] 7.1: Add `entity_type_counts: dict[str, int] | None = None` field to core `ProcessingResult` (populated during `_resolve_pseudonyms` from the actual entities processed). Uses `None` default so existing CLI code paths aren't broken.
  - [x] 7.2: Update `ProcessingWorker._run_processing()` to read counts from `ProcessingResult` instead of querying `repo.find_all(entity_type=...)` on the entire DB
  - [x] 7.3: Remove the `repo.find_all(entity_type=...)` loop at `processing_worker.py:198-205`
  - [x] 7.4: Update `GUIProcessingResult` construction to use the new counts
  - [x] 7.5: Write unit test verifying per-document counts are correct (not cumulative)

### Phase 5 — Regression Verification (AC: 8)

- [x] **Task 8: Run full regression suite** (AC: 8)
  - [x] 8.1: Run `poetry run pytest tests/unit/cli/ tests/integration/` — 486 passed, 7 skipped
  - [x] 8.2: Run `poetry run pytest tests/unit/gui/` — 307 passed
  - [x] 8.3: Run `poetry run black --check .` + `poetry run ruff check .` + `poetry run mypy gdpr_pseudonymizer/` — all pass
  - [x] 8.4: Verify coverage >= 86% — 1613 passed, 9 skipped, all quality gates pass

---

## Dev Notes

### Source File Locations

| File | Role |
|------|------|
| `gdpr_pseudonymizer/core/document_processor.py` | Primary target — security hardening, DRY refactoring, typed exceptions |
| `gdpr_pseudonymizer/exceptions.py` | Custom exceptions: `DatabaseError`, `EncryptionError`, `FileProcessingError`, `ValidationError` — use these in typed catches |
| `gdpr_pseudonymizer/pseudonym/assignment_engine.py` | `CompositionalPseudonymEngine` — `strip_titles()`, `strip_prepositions()` methods referenced by normalization helper |
| `gdpr_pseudonymizer/gui/workers/processing_worker.py` | DATA-001 fix location — lines 196-208 (try-except block; inner loop at 198-205) |
| `tests/unit/test_document_processor.py` | Existing test file — add new tests here |

### SEC-001: PII Leak Details

The vulnerability is in `_handle_processing_error` (document_processor.py:648-654):
```python
error_message = (
    str(error)
    if isinstance(error, FileProcessingError)
    else f"{type(error).__name__}: {error}"
)
logger.error("processing_error", error=error_message)
self._log_failed_operation(input_path, error_message, ...)
```

If an NLP exception contains entity text (e.g., `ValueError: Cannot parse entity 'Jean Dupont'`), the PII ends up in:
1. The structlog output (`logger.error`)
2. The audit database `Operation.error_message` field (via `_log_failed_operation`)

**Mitigating factor:** The audit database is encrypted (`open_database` context manager). The primary risk vector is structlog output to console/file.

**Additional PII leak sites (same file):**
3. Line 509: `logger.error("batch_save_failed", error=str(e), ...)` in `_resolve_pseudonyms`
4. Line 881: `logger.error("audit_logging_failed", error=str(e))` in `_log_failed_operation`

**Fix approach:** Create a sanitizer that strips quoted strings, entity-like patterns, and file content fragments from error messages. Replace **all** raw `str(error)` / `str(e)` calls in `logger.error(...)` with sanitized versions. Preserve exception type name and generic error structure for diagnostics.

### DRY-001: Duplicated Pattern (3 locations)

The exact same 4-line block appears at:
- `_build_pseudonym_assigner` (line 212-216)
- `_run_validation` (line 261-265)
- `_resolve_pseudonyms` (line 462-466)

```python
entity_text_stripped = ctx.compositional_engine.strip_titles(entity.text)
if entity.entity_type == "LOCATION":
    entity_text_stripped = ctx.compositional_engine.strip_prepositions(
        entity_text_stripped
    )
```

Extract to:
```python
def _normalize_entity_text(self, ctx: _ProcessingContext, entity: DetectedEntity) -> str:
    text = ctx.compositional_engine.strip_titles(entity.text)
    if entity.entity_type == "LOCATION":
        text = ctx.compositional_engine.strip_prepositions(text)
    return text
```

**Excluded from refactor:** `_get_entity_prefix()` (lines 384, 390) also calls `strip_titles`/`strip_prepositions` but serves a different purpose — it extracts the *prefix string* (e.g., "M. ", "de ") rather than normalizing for lookup. Do NOT refactor those calls into `_normalize_entity_text`.

### DATA-001: Entity Count Bug

`ProcessingWorker` (processing_worker.py:198-205) queries `repo.find_all(entity_type=...)` which returns ALL entities in the DB, not just the current document's. The results screen therefore shows cumulative DB totals rather than per-document counts.

**Fix:** Add entity type counts to `ProcessingResult` (populated during `_resolve_pseudonyms` which already iterates all entities), then read from the result object in the worker instead of re-querying the DB.

### Previous Story Insights

- **CODE-003 Pattern:** Never use UI text for state logic — use boolean flags or enums. [Source: Story 6.6]
- **Quality Gates:** Black, Ruff, mypy, pytest must all pass. [Source: Story 6.7]
- **Poetry:** All commands must use `poetry run`. [Source: architecture/19-coding-standards.md]

### Testing

**Test File Locations:**
- `tests/unit/test_document_processor.py` — existing unit tests (extend here)
- `tests/integration/test_document_processor_integration.py` — new integration test file
- `tests/unit/gui/test_processing_worker.py` — for DATA-001 fix test (if it exists, otherwise create)

**Testing Framework and Patterns:**
- pytest, `unittest.mock` for unit tests
- Real SQLite `:memory:` database for integration tests — use `init_database` + `open_database` with test passphrase. Import from: `from gdpr_pseudonymizer.data.database import init_database, open_database`
- Follow existing conftest patterns in `tests/conftest.py`
- For integration tests: use actual `SQLiteMappingRepository`, actual `AuditRepository`, mock only NLP detector (heavy dependency)

**Specific Testing Requirements:**
- PII sanitization: test with exception messages containing French names, addresses, organization names
- Error cases: use project's custom exceptions from `exceptions.py` (`DatabaseError`, `EncryptionError`, `FileProcessingError`)
- DATA-001 fix: verify entity counts come from `ProcessingResult`, not from DB query

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug issues encountered — all implementations passed on first attempt.

### Completion Notes List

- SEC-001: `_sanitize_error_message()` strips single/double-quoted strings and capitalized name sequences (French accent aware) from exception messages. Applied to all 3 PII leak sites.
- EXC-001: `_build_pseudonym_assigner` now catches `(ValueError, RuntimeError)` with warning log; `_get_model_version` catches `(OSError, AttributeError, ImportError)` with warning log.
- DRY-001: Extracted `_normalize_entity_text()` as static method, replaced 3 identical code blocks. `_compute_replacement_prefix` and `_get_entity_prefix` left as-is per story exclusion.
- TEST-001: 10 new unit tests for GUI-phase methods (detect_entities, build_pseudonym_previews, finalize_document).
- TEST-002: 4 new error case tests (EncryptionError, DatabaseError save_batch, KeyboardInterrupt, invalid passphrase).
- TEST-003: 2 integration tests with real SQLiteMappingRepository (full workflow + idempotency).
- DATA-001: Added `entity_type_counts` to `ProcessingResult` and `_ResolveResult`, populated during `_resolve_pseudonyms`. `ProcessingWorker` now reads counts from result instead of re-querying entire DB. Removed `open_database`/`SQLiteMappingRepository` imports from worker.
- Updated existing test assertion for sanitized error message format (`FileProcessingError:` prefix).

### File List

| File | Action |
|------|--------|
| `gdpr_pseudonymizer/core/document_processor.py` | Modified — PII sanitization, typed exceptions, DRY refactor, entity_type_counts |
| `gdpr_pseudonymizer/gui/workers/processing_worker.py` | Modified — DATA-001 fix, removed DB query loop |
| `tests/unit/test_document_processor.py` | Modified — 24 new tests (sanitization, GUI-phase, error cases) |
| `tests/unit/gui/test_processing_worker.py` | Modified — 2 new DATA-001 tests |
| `tests/unit/test_document_processor_internals.py` | Modified — updated test assertion for sanitized error format |
| `tests/integration/test_document_processor_integration.py` | Created — 2 integration tests with real SQLite |

---

## QA Results

### Review Date: 2026-02-26

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Deep review triggered** by multiple escalation factors:
- Security files touched (PII sanitization, exception hardening)
- Story has 8 acceptance criteria (>5 threshold)
- Security-classified work (SEC-001, EXC-001)

### Code Quality Assessment

**Overall: Excellent.** The implementation is clean, well-structured, and security-conscious.

- **SEC-001 (PII Sanitization):** `_sanitize_error_message()` is correctly implemented as a `@staticmethod` with three complementary regex patterns (single-quoted strings, double-quoted strings, capitalized name sequences with French accent support). Applied to all 3 PII leak vectors: `_handle_processing_error` (L698), `_resolve_pseudonyms` (L526), and `_log_failed_operation` (L931). The regex deliberately errs toward over-redaction — correct security posture.
- **EXC-001 (Typed Exceptions):** `_build_pseudonym_assigner` catches `(ValueError, RuntimeError)` with `logger.warning` (L251). `_get_model_version` catches `(OSError, AttributeError, ImportError)` with `logger.warning` (L892). Top-level catches in `process_document` and `finalize_document` remain broad by design. No silent `pass` blocks anywhere.
- **DRY-001 (Normalization Helper):** `_normalize_entity_text()` extracted as `@staticmethod`, used in all 3 call sites (L234, L284, L482). `_compute_replacement_prefix` and `_get_entity_prefix` correctly excluded per story spec. Pure refactoring with no behavioral change.
- **DATA-001 Fix:** `entity_type_counts` added to `ProcessingResult` and `_ResolveResult`, populated during `_resolve_pseudonyms` from actual entities processed. `ProcessingWorker` reads counts from result object. Old `repo.find_all(entity_type=...)` DB loop removed. Clean separation — worker no longer imports `open_database` or `SQLiteMappingRepository`.

### Requirements Traceability

| AC | Criteria | Tests | Status |
|----|----------|-------|--------|
| AC1 | PII Sanitization (SEC-001) | `TestSanitizeErrorMessage` — 10 tests covering quotes, accented names, org names, addresses, empty messages, multiple PII strings | ✓ Covered |
| AC2 | Typed Exception Handling (EXC-001) | `TestBuildPseudonymAssigner.test_fallback_on_assignment_error` + code inspection of `_get_model_version` typed catches | ✓ Covered |
| AC3 | DRY: Entity Text Normalization (DRY-001) | Transitively tested through all `_build_pseudonym_assigner`, `_run_validation`, and `_resolve_pseudonyms` test suites | ✓ Covered |
| AC4 | GUI-Phase Method Tests (TEST-001) | `TestDetectEntities` (4 tests), `TestBuildPseudonymPreviews` (3 tests), `TestFinalizeDocument` (3 tests) — each with happy path + empty + error | ✓ Covered |
| AC5 | Error Case Tests (TEST-002) | `TestErrorCases` — EncryptionError, DatabaseError save_batch, KeyboardInterrupt propagation, invalid passphrase (4 tests) | ✓ Covered |
| AC6 | Integration Test (TEST-003) | `TestDocumentProcessorIntegration` — full workflow + idempotency with real SQLite DB (2 tests, uses `tmp_path` file DB — more rigorous than `:memory:`) | ✓ Covered |
| AC7 | DATA-001 Fix | `TestProcessingWorkerEntityCounts` — counts from result (not DB) + None fallback (2 tests) | ✓ Covered |
| AC8 | No Regression | Dev reports: 1613 passed, 9 skipped, Black/Ruff/mypy all pass | ✓ Verified by dev |

### Refactoring Performed

None — implementation quality is high; no refactoring needed during review.

### Compliance Check

- Coding Standards: ✓ Absolute imports, no sensitive data in `logger.error` calls, type hints on public methods, Poetry build system
- Project Structure: ✓ Files in correct locations per unified structure (core/, gui/workers/, tests/unit/, tests/integration/)
- Testing Strategy: ✓ Unit tests with mocks, integration tests with real DB, error scenarios covered, proper fixture usage
- All ACs Met: ✓ All 8 acceptance criteria verified with test coverage

### Improvements Checklist

- [x] PII sanitization applied to all 3 error logging sites (SEC-001) — done by dev
- [x] Typed exceptions in `_build_pseudonym_assigner` and `_get_model_version` (EXC-001) — done by dev
- [x] `_normalize_entity_text` extracted and used in 3 call sites (DRY-001) — done by dev
- [x] Entity type counts flow through ProcessingResult → GUIProcessingResult (DATA-001) — done by dev
- [ ] **Future:** Populate `entity_mappings` in `ProcessingWorker` and `FinalizationWorker` from `ProcessingResult` to restore pseudonym highlighting in results screen (pre-existing gap in both workers — not a regression from this story)
- [ ] **Future:** Consider sanitizing DEBUG-level log statements that reference `entity.text` (`_resolve_pseudonyms` L477-479) and `parsed_first`/`full_name` (`_check_component_match` L366-380) — low risk since DEBUG is disabled in production, but defense-in-depth

### Security Review

**PASS.** All `logger.error()` paths in `document_processor.py` now use `_sanitize_error_message()`. The three regex patterns cover the primary PII vectors (quoted strings, capitalized name sequences with French accents). The sanitizer errs toward over-redaction, which is the correct approach for GDPR compliance.

**Minor observation (not a finding):** Four `logger.debug()` calls still reference entity text directly (L366, L374, L477, L565). These are disabled in production and are out of scope for SEC-001, but noted for future hardening.

### Performance Considerations

**PASS.** No performance concerns. `_normalize_entity_text` extraction is a zero-cost refactoring. `entity_type_counts` accumulation adds trivial O(n) dict increments. Regex sanitization is bounded and non-recursive (no ReDoS risk).

### Files Modified During Review

None — no files were modified during QA review.

### Gate Status

Gate: **PASS** → docs/qa/gates/6.7.1-core-processing-hardening-security.yml

### Recommended Status

✓ **Ready for Done** — All 8 ACs met with comprehensive test coverage. Security hardening is solid. No blocking issues found.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 1.0 | Initial story draft — consolidates external code review feedback + DATA-001 carry-forward | Sarah (Product Owner) |
| 2026-02-25 | 1.1 | Validation fixes: expanded SEC-001 scope to lines 509/881, added `except Exception` inventory, clarified DRY-001 exclusions, fixed processing_worker line refs, added integration test import path, added Dev Agent Record + QA Results stubs | Sarah (Product Owner) |
| 2026-02-25 | 2.0 | Implementation complete — all 8 tasks done, 69 story tests pass, 1613 total tests pass (9 skipped), all quality gates pass | James (Dev Agent, Claude Opus 4.6) |
