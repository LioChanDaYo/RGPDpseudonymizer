# Story 5.5: PDF/DOCX Input Format Support

## Status

**Done**

---

## Story

**As a** user with documents in PDF or DOCX format,
**I want** to pseudonymize these documents directly without manual conversion to .txt,
**so that** I can process my real-world documents without extra steps.

---

## Acceptance Criteria

1. **AC1:** PDF text extraction implemented using `pdfplumber`:
   - Extract text content from PDF pages
   - Handle multi-page documents
   - Graceful handling of scanned PDFs (warn: "This PDF appears to be scanned/image-based. Text extraction may be incomplete.")
2. **AC2:** DOCX text extraction implemented using `python-docx`:
   - Extract paragraph text from DOCX
   - Handle headers, footers, tables (best-effort text extraction)
3. **AC3:** `process` and `batch` commands accept `.pdf` and `.docx` files:
   - Auto-detect format from file extension
   - Extract text -> run existing NER + validation + pseudonymization pipeline
4. **AC4:** Output format options:
   - Default: pseudonymized `.txt` output (extracted text with replacements)
   - Future consideration: preserve original format (`.pdf` -> `.pdf`, `.docx` -> `.docx`) -- document as v1.2+ enhancement if complex
5. **AC5:** New dependencies added as **optional extras** in `pyproject.toml`: `pip install gdpr-pseudonymizer[pdf]` and `pip install gdpr-pseudonymizer[docx]` (or combined `[formats]`). Base install remains lightweight; clear error message if user tries to process PDF/DOCX without the extra installed.
6. **AC6:** Unit tests: PDF extraction, DOCX extraction, format detection, error handling (corrupt files, password-protected PDFs)
7. **AC7:** Integration test: process PDF and DOCX documents end-to-end
8. **AC8:** Documentation updated: supported formats section, installation notes for new dependencies
9. **AC9:** No regression in existing `.txt`/`.md` processing

---

## Context

This is the **fifth story of Epic 5** (v1.1 -- Quick Wins & GDPR Compliance). Stories 5.1 (GDPR Right to Erasure), 5.2 (Gender-Aware Pseudonym Assignment), 5.3 (NER Accuracy & Annotation Quality), and 5.4 (French Documentation Translation) are completed. This story addresses backlog item FB-004 with **MEDIUM** priority -- the second most requested alpha feature.

**Why this matters:** v1.0 only supports `.txt` and `.md` input formats. Real-world users have documents in PDF (academic papers, legal documents) and DOCX (HR files, interview transcripts). Manual conversion loses formatting and creates friction. Adding format extraction at the file handler level enables the existing NLP/pseudonymization pipeline to process these formats transparently.

**Current file handling architecture:**
- `file_handler.py`: `read_file()` opens files as UTF-8 plaintext via `f.read()` -- no format-aware extraction
- `process.py`: Validates `allowed_extensions = [".txt", ".md"]` at line 141, rejects other formats
- `batch.py`: `SUPPORTED_EXTENSIONS = [".txt", ".md"]` at line 53, filters `collect_files()`
- `document_processor.py`: Calls `read_file(input_path)` at line 679 -- receives plain text, passes to NLP
- `main.py`: Help text says "Input file path (.txt or .md)" at line 186

**Output file extension behavior (AC4):**
- `process.py` lines 150-155: Default output uses `input_file.suffix` (e.g., `input.txt` -> `input_pseudonymized.txt`)
- For PDF/DOCX input, output MUST default to `.txt` since we only produce plaintext output

**Existing system state:**
- v1.0.7 on PyPI, 1198+ tests, 86%+ coverage, all quality gates passing
- No optional extras currently defined in `pyproject.toml`
- Poetry build system with `packages = [{include = "gdpr_pseudonymizer"}]`

**Prerequisites:**
- Story 5.4 complete (Done -- 2026-02-14)
- All quality gates green

---

## Tasks / Subtasks

### Phase 1 -- Optional Dependencies & pyproject.toml (AC: 5)

- [x] **Task 5.5.1: Add optional dependencies for PDF and DOCX extraction** (AC: 5)
  - [x] Add `pdfplumber` (or `PyMuPDF`) as optional dependency for PDF extraction
  - [x] Add `python-docx` as optional dependency for DOCX extraction
  - [x] Define Poetry extras in `pyproject.toml`:
    ```toml
    [tool.poetry.extras]
    pdf = ["pdfplumber"]
    docx = ["python-docx"]
    formats = ["pdfplumber", "python-docx"]
    ```
  - [x] Run `poetry lock` to update lock file
  - [x] Verify `poetry install --extras formats` installs both libraries
  - [x] Verify `poetry install` (no extras) does NOT install PDF/DOCX libraries
  - [x] Update CI workflow to install extras for test jobs: `poetry install --extras formats` (so PDF/DOCX tests can run in CI)
  - [x] Atomic commit

### Phase 2 -- File Handler Format Extraction (AC: 1, 2)

- [x] **Task 5.5.2: Implement PDF text extraction function** (AC: 1)
  - [x] Add `read_pdf(file_path: str) -> str` function in `file_handler.py`
  - [x] Extract text from all pages, joining with double newline between pages
  - [x] Handle multi-page documents
  - [x] Detect scanned/image-based PDFs: if extracted text is empty or very short relative to page count, log warning: "This PDF appears to be scanned/image-based. Text extraction may be incomplete."
  - [x] Handle password-protected PDFs: raise `FileProcessingError` with clear message
  - [x] Handle corrupt PDF files: raise `FileProcessingError`
  - [x] Guard import with try/except `ImportError` -- set `HAS_PDFPLUMBER = True/False` flag
  - [x] If `pdfplumber` not installed, raise `FileProcessingError`: "PDF support requires 'pdfplumber'. Install with: pip install gdpr-pseudonymizer[pdf]"
  - [x] Atomic commit

- [x] **Task 5.5.3: Implement DOCX text extraction function** (AC: 2)
  - [x] Add `read_docx(file_path: str) -> str` function in `file_handler.py`
  - [x] Extract paragraph text from DOCX body
  - [x] Extract text from headers and footers (best-effort)
  - [x] Extract text from tables (best-effort: row-by-row, cell text joined)
  - [x] Join all text sections with newlines
  - [x] Handle corrupt DOCX files: raise `FileProcessingError`
  - [x] Guard import with try/except `ImportError` -- set `HAS_PYTHON_DOCX = True/False` flag
  - [x] If `python-docx` not installed, raise `FileProcessingError`: "DOCX support requires 'python-docx'. Install with: pip install gdpr-pseudonymizer[docx]"
  - [x] Atomic commit

- [x] **Task 5.5.4: Implement format-aware read dispatcher** (AC: 1, 2, 3)
  - [x] Modify `read_file(file_path: str) -> str` to detect format from extension:
    - `.txt`, `.md`: current behavior (UTF-8 `f.read()`)
    - `.pdf`: delegate to `read_pdf()`
    - `.docx`: delegate to `read_docx()`
  - [x] Use existing `get_file_extension()` helper for format detection
  - [x] Maintain backward compatibility: `.txt`/`.md` behavior unchanged
  - [x] Atomic commit

### Phase 3 -- CLI & Command Layer Integration (AC: 3, 4)

- [x] **Task 5.5.5: Update `process` command for PDF/DOCX support** (AC: 3, 4)
  - [x] Update `allowed_extensions` in `process.py` line 141: add `".pdf"`, `".docx"`
  - [x] Update help text in `main.py` line 186: "Input file path (.txt, .md, .pdf, or .docx)"
  - [x] Fix output file extension logic (process.py lines 150-155): for `.pdf`/`.docx` input, default output to `.txt` instead of reusing input suffix
    - Current: `f"{input_file.stem}_pseudonymized{input_file.suffix}"` -> would produce `.pdf` output (wrong)
    - New: if input suffix in `[".pdf", ".docx"]`, use `.txt` as output suffix
  - [x] Atomic commit

- [x] **Task 5.5.6: Update `batch` command for PDF/DOCX support** (AC: 3)
  - [x] Update `SUPPORTED_EXTENSIONS` in `batch.py` line 53: add `".pdf"`, `".docx"`
  - [x] Verify `collect_files()` picks up PDF/DOCX files from input directory
  - [x] Verify batch output file naming uses `.txt` extension for PDF/DOCX inputs
  - [x] Atomic commit

### Phase 4 -- Unit Tests (AC: 6)

- [x] **Task 5.5.7: Unit tests for PDF extraction** (AC: 6)
  - [x] Test `read_pdf()` with simple single-page PDF
  - [x] Test `read_pdf()` with multi-page PDF
  - [x] Test `read_pdf()` with empty/scanned PDF (warning path)
  - [x] Test `read_pdf()` with password-protected PDF (error path)
  - [x] Test `read_pdf()` with corrupt file (error path)
  - [x] Test `read_pdf()` when `pdfplumber` not installed (mock `HAS_PDFPLUMBER = False`)
  - [x] Atomic commit

- [x] **Task 5.5.8: Unit tests for DOCX extraction** (AC: 6)
  - [x] Test `read_docx()` with simple DOCX (paragraphs only)
  - [x] Test `read_docx()` with DOCX containing headers/footers
  - [x] Test `read_docx()` with DOCX containing tables
  - [x] Test `read_docx()` with corrupt file (error path)
  - [x] Test `read_docx()` when `python-docx` not installed (mock `HAS_PYTHON_DOCX = False`)
  - [x] Atomic commit

- [x] **Task 5.5.9: Unit tests for format detection and dispatcher** (AC: 6)
  - [x] Test `read_file()` dispatches `.pdf` to `read_pdf()`
  - [x] Test `read_file()` dispatches `.docx` to `read_docx()`
  - [x] Test `read_file()` still works for `.txt` and `.md` (regression)
  - [x] Test case-insensitive extension handling (`.PDF`, `.Docx`)
  - [x] Atomic commit

- [x] **Task 5.5.10: Unit tests for CLI command changes** (AC: 6)
  - [x] Test `process` command accepts `.pdf` files
  - [x] Test `process` command accepts `.docx` files
  - [x] Test default output filename uses `.txt` for PDF/DOCX input
  - [x] Test `batch` command `collect_files()` includes `.pdf` and `.docx` files
  - [x] Test error message when PDF/DOCX dependency not installed
  - [x] Atomic commit

### Phase 5 -- Integration Tests (AC: 7)

- [x] **Task 5.5.11: Integration tests for end-to-end PDF/DOCX processing** (AC: 7)
  - [x] Create test PDF fixture with known French text containing PII (names, locations)
  - [x] Create test DOCX fixture with known French text containing PII
  - [x] Integration test: `process` PDF -> verify pseudonymized `.txt` output, entities detected
  - [x] Integration test: `process` DOCX -> verify pseudonymized `.txt` output, entities detected
  - [x] Integration test: `batch` with mixed formats (.txt, .pdf, .docx) -> all processed successfully
  - [x] Verify mapping database contains expected entities from PDF/DOCX sources
  - [x] Atomic commit

### Phase 6 -- Documentation (AC: 8)

- [x] **Task 5.5.12: Update documentation for PDF/DOCX support** (AC: 8)
  - [x] Update `docs/installation.md` (and `docs/installation.fr.md`): add section on optional extras (`pip install gdpr-pseudonymizer[formats]`)
  - [x] Update `docs/tutorial.md` (and `docs/tutorial.fr.md`): add examples for processing PDF/DOCX files
  - [x] Update `docs/CLI-REFERENCE.md`: update supported formats in `process` and `batch` command sections
  - [x] Update `docs/faq.md` (and `docs/faq.fr.md`): add FAQ entry "How do I process PDF/DOCX files?"
  - [x] Update `README.md` (and `README.fr.md`): mention PDF/DOCX support in features section
  - [x] Atomic commit

### Phase 7 -- Regression Validation (AC: 9)

- [x] **Task 5.5.13: Quality gates and regression checks** (AC: 9)
  - [x] `poetry run black --check gdpr_pseudonymizer/ tests/` -- pass
  - [x] `poetry run ruff check .` -- pass
  - [x] `poetry run mypy gdpr_pseudonymizer/` -- pass
  - [x] `poetry run pytest tests/ -v --timeout=120 -p no:benchmark` -- all pass, no regression
  - [x] Verify test count >= 1198 (Story 5.4 baseline) + new tests
  - [x] Verify existing `.txt`/`.md` processing works identically (regression)

---

## Dev Notes

### Story Type

This is a **backend/CLI story** -- adding format-aware file reading to the file handler, updating CLI commands to accept new extensions, and defining optional package extras. No NLP changes, no database schema changes, no pseudonym logic changes.

### Previous Story Insights

**[Source: Story 5.4 Dev Agent Record]**
- v1.0.7 on PyPI, 1198 tests passing (>= 1077 baseline), 938 on Windows-safe subset
- Windows spaCy segfault: CI skips spaCy tests on Windows -- integration tests for PDF/DOCX that use spaCy should follow the same skip pattern
- Quality gates (black, ruff, mypy) all pass
- `mkdocs-static-i18n` added in Story 5.4 -- French docs exist and must be updated alongside English docs
- pyproject.toml currently has NO optional extras section -- this story adds the first one

### File Handler Architecture

**[Source: architecture/12-unified-project-structure.md, actual codebase]**

Current `file_handler.py` (`gdpr_pseudonymizer/utils/file_handler.py`):

```python
def read_file(file_path: str) -> str:
    """Read text file contents."""
    path = Path(file_path)
    # ... validation ...
    with open(path, encoding="utf-8") as f:
        return f.read()
```

**Key integration point:** `document_processor.py` line 679 calls `read_file(input_path)` and receives a plain text string. The entire downstream pipeline (NLP detection, validation, pseudonym assignment, text replacement) works on this string. By making `read_file()` format-aware, the **entire downstream pipeline requires zero changes**.

Available helpers in `file_handler.py`:
- `get_file_extension(file_path) -> str` -- returns lowercase extension with dot
- `validate_file_path(file_path, allowed_extensions) -> bool` -- extension validation
- `ensure_absolute_path(file_path) -> str` -- path resolution
- `write_file(file_path, content) -> None` -- UTF-8 text output

Custom exception: `FileProcessingError` from `gdpr_pseudonymizer/exceptions.py` -- used for all file I/O errors.

### CLI Integration Points

**[Source: actual codebase analysis]**

**`process.py` (gdpr_pseudonymizer/cli/commands/process.py):**
- Line 141: `allowed_extensions = [".txt", ".md"]` -- add `.pdf`, `.docx`
- Lines 150-155: Default output path uses `input_file.suffix` -- must override to `.txt` for PDF/DOCX
- Line 31: Imports `FileProcessingError` -- already available for dependency-missing errors

**`batch.py` (gdpr_pseudonymizer/cli/commands/batch.py):**
- Line 53: `SUPPORTED_EXTENSIONS = [".txt", ".md"]` -- add `.pdf`, `.docx`
- `collect_files()` function (lines ~280-307) filters by `SUPPORTED_EXTENSIONS`

**`main.py` (gdpr_pseudonymizer/cli/main.py):**
- Line 186: Help text `"Input file path (.txt or .md)"` -- update to include `.pdf`, `.docx`

### Optional Dependencies Pattern

**[Source: architecture/3-tech-stack.md, pyproject.toml]**

Poetry extras syntax for optional dependencies:

```toml
# In [tool.poetry.dependencies] section:
pdfplumber = {version = "^0.11.0", optional = true}
python-docx = {version = "^1.1.0", optional = true}

# New section:
[tool.poetry.extras]
pdf = ["pdfplumber"]
docx = ["python-docx"]
formats = ["pdfplumber", "python-docx"]
```

**Installation patterns for users:**
- `pip install gdpr-pseudonymizer` -- base install, no PDF/DOCX
- `pip install gdpr-pseudonymizer[pdf]` -- adds PDF support
- `pip install gdpr-pseudonymizer[docx]` -- adds DOCX support
- `pip install gdpr-pseudonymizer[formats]` -- adds both

**Conditional import pattern:**

```python
try:
    import pdfplumber
    HAS_PDFPLUMBER = True
except ImportError:
    HAS_PDFPLUMBER = False

try:
    import docx  # python-docx
    HAS_PYTHON_DOCX = True
except ImportError:
    HAS_PYTHON_DOCX = False
```

### PDF Library Choice

**[Source: Epic 5 PRD AC1]**

The PRD suggests `pdfplumber` or `PyMuPDF`. Recommended: **`pdfplumber`** because:
- Pure Python (no C compilation required) -- aligns with tech stack rationale for installation reliability
- Good text extraction with layout preservation
- Handles multi-page documents cleanly
- Active maintenance, MIT license (compatible with project MIT license)
- Lighter than PyMuPDF (which requires system libraries on some platforms)

### DOCX Library Choice

**[Source: Epic 5 PRD AC2]**

The PRD specifies `python-docx`. This is the standard library for DOCX handling:
- Pure Python, MIT license
- Read-only access sufficient (we only extract text)
- Handles paragraphs, tables, headers/footers
- Well-maintained, widely used

### Output Format Decision

**[Source: Epic 5 PRD AC4]**

v1.1 outputs **plaintext only** (`.txt`). Format preservation (PDF->PDF, DOCX->DOCX) is explicitly deferred to v1.2+. This is documented in the epic's "Explicitly Deferred" table.

The default output filename logic in `process.py` must be updated: for PDF/DOCX input, the output suffix should be `.txt`, not the input suffix.

### Scanned PDF Handling

**[Source: Epic 5 PRD AC1, Risk Assessment]**

Scanned/image-based PDFs will yield empty or minimal text from `pdfplumber`. The tool should:
1. Detect: if `len(extracted_text.strip()) < threshold` relative to page count (e.g., < 50 chars per page)
2. Warn via structlog: "This PDF appears to be scanned/image-based. Text extraction may be incomplete."
3. Continue processing (don't abort) -- let user see the result and decide
4. OCR is explicitly NOT in scope (deferred)

### Project Structure Notes

**[Source: architecture/12-unified-project-structure.md]**

New/modified files follow existing patterns:
- `gdpr_pseudonymizer/utils/file_handler.py` -- MODIFY: add `read_pdf()`, `read_docx()`, update `read_file()` dispatcher
- `gdpr_pseudonymizer/cli/commands/process.py` -- MODIFY: update allowed extensions, output suffix logic
- `gdpr_pseudonymizer/cli/commands/batch.py` -- MODIFY: update `SUPPORTED_EXTENSIONS`
- `gdpr_pseudonymizer/cli/main.py` -- MODIFY: update help text
- `pyproject.toml` -- MODIFY: add optional dependencies and extras
- `tests/unit/test_file_handler.py` -- MODIFY: add PDF/DOCX extraction tests (or new file)
- `tests/unit/cli/commands/test_process.py` -- MODIFY: add format acceptance tests
- `tests/unit/cli/commands/test_batch.py` -- MODIFY: add collect_files extension tests
- `tests/integration/` -- new integration test file for PDF/DOCX end-to-end

No new directories needed. No architectural changes.

### Typer/Click Compatibility Reminder

**[Source: MEMORY.md, architecture/3-tech-stack.md]**

- Typer 0.9.x + click <8.2.0 pinned
- No new CLI flags needed for this story (format detection is automatic)
- No `Optional[bool]` flag pairs needed
- Standard Typer argument/option patterns only

### Batch Processing Considerations

**[Source: architecture/8-core-workflows.md]**

Batch mode uses `multiprocessing.Pool` with workers. Each worker calls `read_file()` independently. Since `read_file()` is the dispatcher:
- Each worker will import `pdfplumber`/`python-docx` in its own process
- Memory: PDF extraction loads entire PDF into memory per worker -- large PDFs with many workers could cause memory pressure
- No shared state concerns -- each worker extracts independently

### Testing Standards

**[Source: architecture/16-testing-strategy.md, architecture/19-coding-standards.md]**

**Test framework:** pytest 7.4+ with pytest-cov, pytest-mock
**Build system:** `poetry run` for all test commands
**Coverage target:** Maintain >= 86%
**Post-story test target:** >= 1198 (Story 5.4 baseline) + new PDF/DOCX tests

**Test file locations:**
- Unit tests: `tests/unit/test_file_handler.py` (extend or create `tests/unit/test_file_handler_formats.py`)
- CLI tests: `tests/unit/cli/commands/test_process.py`, `tests/unit/cli/commands/test_batch.py`
- Integration tests: `tests/integration/test_pdf_docx_processing.py` (new)

**Test patterns:**
- Use `tmp_path` fixture for temporary test files
- Use `monkeypatch` to mock `HAS_PDFPLUMBER`/`HAS_PYTHON_DOCX` flags for dependency-missing tests
- Use `pytest.raises(FileProcessingError)` for error path tests
- Integration tests that require spaCy must be skipped on Windows (existing pattern)

**Test fixtures needed:**
- Small test PDF with known French PII text (generate programmatically with `pdfplumber` or `reportlab` in test setup)
- Small test DOCX with known French PII text (generate programmatically with `python-docx` in test setup)
- Corrupt/empty test files for error paths
- Note: `pdfplumber` is read-only -- use `fpdf2` or `reportlab` (test-only dev dependency) to generate test PDF fixtures programmatically

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-14 | 1.0 | Initial story draft created from Epic 5 PRD with full architecture analysis, file handler integration plan, optional dependency design, and CLI update specifications | Bob (SM Agent) |
| 2026-02-14 | 1.1 | PO validation pass: fixed AC1 library ambiguity (pdfplumber), corrected line refs (150-155), nested Testing under Dev Notes, added QA Results section, added CI extras note, added test fixture generation clarification | Sarah (PO Agent) |
| 2026-02-15 | 1.2 | Implementation complete: all 13 tasks done, 37 new tests (1235 total), all quality gates pass, documentation updated in EN/FR | James (Dev Agent - Claude Opus 4.6) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References

- Black formatting required on 4 files after initial edits (file_handler.py, process.py, batch.py, test_file_handler_formats.py) -- fixed with `poetry run black`
- mypy found 2 unnecessary `# type: ignore[union-attr]` comments on `pdfplumber.open()` and `docx.Document()` -- removed (mypy already has `ignore_missing_imports = true` for these modules)
- 3 existing batch tests assumed PDF was unsupported format -- changed test fixtures from `.pdf` to `.csv`

### Completion Notes List

- All 9 acceptance criteria (AC1-AC9) met
- 37 new tests added (30 unit + 7 integration), total test count: 1235 (baseline was 1198)
- PDF/DOCX are optional extras -- base install remains lightweight
- Output format is plaintext `.txt` for PDF/DOCX inputs (format preservation deferred to v1.2+)
- Integration tests skip on Windows due to spaCy segfault (consistent with existing CI pattern)
- CI updated to install `--extras formats` and to include new test files in Windows test list
- `fpdf2` added as dev-only dependency for programmatic PDF generation in tests
- Documentation updated in both English and French (9 doc files)

### File List

**Modified:**
- `pyproject.toml` -- Added optional dependencies (pdfplumber, python-docx), extras section, fpdf2 dev dep, mypy overrides
- `poetry.lock` -- Updated lock file
- `gdpr_pseudonymizer/utils/file_handler.py` -- Added `read_pdf()`, `read_docx()`, updated `read_file()` dispatcher
- `gdpr_pseudonymizer/cli/commands/process.py` -- Updated allowed_extensions, output suffix logic for PDF/DOCX
- `gdpr_pseudonymizer/cli/commands/batch.py` -- Updated SUPPORTED_EXTENSIONS, output suffix logic
- `gdpr_pseudonymizer/cli/main.py` -- Updated help text to include .pdf, .docx
- `.github/workflows/ci.yaml` -- Added `--extras formats`, new test files in Windows list
- `tests/unit/cli/commands/test_batch.py` -- Fixed 3 tests that assumed PDF was unsupported (changed to .csv)
- `docs/installation.md` -- Added optional extras section
- `docs/installation.fr.md` -- Added optional extras section (French)
- `docs/CLI-REFERENCE.md` -- Updated INPUT_FILE description, added PDF/DOCX examples
- `docs/faq.md` -- Updated supported formats, added PDF/DOCX FAQ
- `docs/faq.fr.md` -- Updated supported formats, added PDF/DOCX FAQ (French)
- `docs/tutorial.md` -- Updated Known Limitations section
- `docs/tutorial.fr.md` -- Updated Known Limitations section (French)
- `README.md` -- Updated format limitation note
- `README.fr.md` -- Updated format limitation note (French)

**New:**
- `tests/unit/test_file_handler_formats.py` -- 30 unit tests for PDF/DOCX extraction, dispatcher, CLI
- `tests/integration/test_pdf_docx_processing.py` -- 7 integration tests for end-to-end processing

---

## QA Results

### Review Date: 2026-02-15

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review depth: DEEP** (auto-escalated: 9 acceptance criteria > 5 threshold)

Risk signals evaluated:
- Auth/payment/security files touched: No
- No tests added: No (37 new tests)
- Diff > 500 lines: Moderate (~600 lines across implementation + tests)
- Previous gate: N/A (first review)
- Story has > 5 ACs: **Yes (9 ACs)** — triggers deep review

### Code Quality Assessment

**Overall: Excellent.** The implementation is clean, well-structured, and follows established project patterns throughout. Key strengths:

- **Conditional imports** (`HAS_PDFPLUMBER`/`HAS_PYTHON_DOCX`) are the correct pattern for optional dependencies — clean error messages guide users to install the right extras
- **`read_file()` dispatcher** is minimal and elegant — case-insensitive extension matching via `path.suffix.lower()`, delegates to format-specific functions, maintains full backward compatibility for `.txt`/`.md`
- **`read_pdf()`**: Proper multi-page handling with `\n\n` separator, scanned PDF detection via configurable threshold (`_SCANNED_PDF_CHARS_PER_PAGE`), password-protected PDF detection via exception message heuristic, proper exception chaining (`from e`)
- **`read_docx()`**: Correct extraction order (headers → paragraphs → tables → footers), best-effort approach as specified, tab-separated table cell text
- **Output suffix logic** correctly overrides to `.txt` for PDF/DOCX in all three locations (process.py, batch.py parallel mode, batch.py sequential mode)
- **Optional extras** in pyproject.toml follow Poetry best practices with granular (`pdf`, `docx`) and combined (`formats`) groups
- **mypy overrides** added for `pdfplumber` and `docx` modules — correct approach for untyped third-party libraries

### Refactoring Performed

None required. The implementation is clean and follows existing patterns. No refactoring needed.

### Compliance Check

- Coding Standards: ✓ Black/Ruff/mypy all pass per dev agent record
- Project Structure: ✓ All files in expected locations per architecture docs
- Testing Strategy: ✓ Unit + integration tests with proper fixtures, skip patterns, and mock usage
- All ACs Met: ✓ See traceability matrix below

### Requirements Traceability

| AC | Description | Implementation | Tests | Status |
|----|-------------|---------------|-------|--------|
| AC1 | PDF extraction with pdfplumber | `read_pdf()` in file_handler.py:76-134 | TestReadPdf (6 tests) | ✓ |
| AC2 | DOCX extraction with python-docx | `read_docx()` in file_handler.py:137-196 | TestReadDocx (6 tests) | ✓ |
| AC3 | process/batch accept .pdf/.docx | process.py:141, batch.py:53 | TestProcessCommandFormats, TestBatchCommandFormats | ✓ |
| AC4 | Output defaults to .txt | process.py:153-155, batch.py:187-189, batch.py:573-575 | test_default_output_txt_for_pdf/docx (4 tests) | ✓ |
| AC5 | Optional extras in pyproject.toml | pyproject.toml:41-47 | Implicit via import guard tests | ✓ |
| AC6 | Unit tests | test_file_handler_formats.py | 30 unit tests | ✓ |
| AC7 | Integration tests | test_pdf_docx_processing.py | 7 integration tests | ✓ |
| AC8 | Documentation updated | installation.md, CLI-REFERENCE.md, faq.md, tutorial.md, README.md (EN+FR) | Spot-checked: installation.md, CLI-REFERENCE.md | ✓ |
| AC9 | No regression in .txt/.md | test_txt_still_works, test_md_still_works + full suite passes | 1235 total tests passing | ✓ |

### Improvements Checklist

- [x] Update `batch_command` docstring (batch.py:377) — says "Processes all .txt and .md files" but now supports .pdf and .docx too
- [x] Strengthen `test_empty_pdf_warns_scanned` to verify the warning log is actually emitted (currently only checks return type is `str`, not that `logger.warning("scanned_pdf_detected", ...)` was called)
- [x] Consider adding a composite DOCX test (header + footer + table + paragraphs all in one document) for completeness

### Security Review

No security concerns. The implementation:
- Is read-only (text extraction only, no file modification)
- Uses well-known MIT-licensed libraries (pdfplumber, python-docx)
- Does not introduce new attack surfaces (no user input beyond file paths, validated by Typer's `exists=True`)
- Error messages do not leak sensitive information
- Optional dependencies are properly isolated — base install unaffected

### Performance Considerations

No performance concerns for typical usage:
- PDF extraction loads the full PDF into memory per worker — acceptable for document-sized files (< 100MB)
- The dev notes correctly flag potential memory pressure with large PDFs + many workers — acceptable as documented, can be addressed in v1.2 if needed
- No hot path changes — `read_file()` dispatcher is O(1) extension check

### Files Modified During Review

None. No refactoring was necessary.

### Gate Status

Gate: **PASS** → docs/qa/gates/5.5-pdf-docx-input-format-support.yml

### Recommended Status

✓ **Ready for Done** — All 9 ACs fully met, 37 new tests (1235 total), clean implementation following existing patterns. The two unchecked items above (docstring fix, test strengthening) are low-priority improvements that can be addressed in a future pass.

(Story owner decides final status)
