# Story 5.2: Gender-Aware Pseudonym Assignment

## Status

**Ready for Review**

---

## Story

**As a** user pseudonymizing French documents for LLM analysis,
**I want** female names to receive female pseudonyms and male names to receive male pseudonyms,
**so that** pseudonymized documents maintain gender coherence and LLM utility.

---

## Acceptance Criteria

1. **AC1:** French name gender detection implemented using heuristic lookup:
   - Build French first_name -> gender mapping from existing pseudonym library data + INSEE public data
   - **Pre-requisite:** Verify INSEE dataset license compatibility with project license (MIT). If restrictive, build lookup purely from existing pseudonym library data.
   - Coverage target: >=90% of common French first names
   - Fallback: `gender=None` uses combined list (current behavior preserved)
2. **AC2:** Gender detection integrated into pseudonym assignment pipeline:
   - After entity detection, before pseudonym assignment: lookup detected first name -> assign gender
   - Gender stored in `entities` table `gender` column (already exists in schema)
3. **AC3:** Pseudonym selection respects gender:
   - Female entity -> female pseudonym first name
   - Male entity -> male pseudonym first name
   - Unknown gender -> random from combined list (no regression)
4. **AC4:** Compound names handled: "Jean-Pierre" -> male, "Marie-Claire" -> female (first component determines gender)
5. **AC5:** Unit tests: gender lookup, assignment logic, compound names, unknown names, edge cases
6. **AC6:** Integration test: process document -> verify gender-matched pseudonyms
7. **AC7:** No regression: existing test suite passes, existing mappings remain valid
8. **AC8:** Documentation: methodology page updated to describe gender-aware assignment

---

## Context

This is the **second story of Epic 5** (v1.1 -- Quick Wins & GDPR Compliance). Story 5.1 (GDPR Right to Erasure) was completed on 2026-02-11. This story addresses backlog item FE-007 with **MEDIUM** priority -- improves LLM utility score and document readability.

**Why this matters:** Currently `LibraryBasedPseudonymManager.assign_pseudonym()` receives `gender=None` (spaCy doesn't provide gender) and falls back to a combined male+female+neutral first name list. A female name like "Marie Dupont" may receive "Jean Martin" as a pseudonym, breaking gender coherence. The pseudonym libraries already have gender-tagged first names -- only the detection/assignment logic is missing.

**Existing system state:**
- v1.0.6 on PyPI, 1133+ tests, 86%+ coverage, all quality gates passing
- Story 5.1 complete: `delete-mapping`, `list-entities` commands, ERASURE audit logging
- The `Entity.gender` column already exists in the schema (`Mapped[str | None]`, nullable) but is always stored as `None`
- The `_select_first_name(gender)` method in `LibraryBasedPseudonymManager` already respects gender when provided -- it selects from `self.first_names["male"]`, `self.first_names["female"]`, or `self.first_names["neutral"]` based on the `gender` parameter
- The pseudonym library JSON files already have gender-tagged first names (male/female/neutral sections)
- **`gender=None` is hardcoded** in 3 places in `document_processor.py` (lines 228, 407, 424) -- these must be replaced with detected gender
- The `french_names.json` resource file has a flat first_names list (no gender tagging) -- used for regex-based NER detection, NOT for gender lookup
- The INSEE Fichier des prenoms (source of neutral.json data) is under **Open License 2.0 (Etalab)** -- compatible with MIT license

**Prerequisites:**
- Story 5.1 complete (Done -- 2026-02-11)
- All quality gates green
- v1.0.6 published on PyPI

---

## Tasks / Subtasks

### Phase 1 -- Gender Lookup Data & Module (AC: 1, 4)

- [x] **Task 5.2.1: Build gender lookup dictionary data file** (AC: 1)
  - [x] Create `data/french_gender_lookup.json` with structure:
    ```json
    {
      "data_sources": [...],
      "male": ["Gabriel", "Raphael", "Leo", ...],
      "female": ["Emma", "Lea", "Chloe", ...],
      "ambiguous": ["Camille", "Dominique", "Claude", ...]
    }
    ```
  - [x] Populate from existing pseudonym library data: extract all unique first names from `neutral.json` `first_names.male` (411 names) and `first_names.female` (372 names) sections. Note: `first_names.neutral` is currently an empty array -- no names to extract from it
  - [x] Supplement with names from `french_names.json` first_names list, classifying them by gender using the pseudonym library as reference
  - [x] Identify ambiguous/unisex names (e.g., Camille, Dominique, Claude, Sacha, Lou, Eden) -- place in `ambiguous` list
  - [x] Document INSEE Open License 2.0 (Etalab) compatibility with MIT in `data_sources` field
  - [x] Target: >=500 gendered names (>=250 male + >=250 female), matching or exceeding the coverage of common French first names
  - [x] Atomic commit

- [x] **Task 5.2.2: Bundle gender lookup data in package resources** (AC: 1)
  - [x] Copy `data/french_gender_lookup.json` to `gdpr_pseudonymizer/resources/french_gender_lookup.json`
  - [x] Add `FRENCH_GENDER_LOOKUP_PATH` constant to `gdpr_pseudonymizer/resources/__init__.py`
  - [x] Follow existing pattern: `FRENCH_GENDER_LOOKUP_PATH = RESOURCES_DIR / "french_gender_lookup.json"`
  - [x] Atomic commit

- [x] **Task 5.2.3: Create `GenderDetector` module** (AC: 1, 4)
  - [x] Create `gdpr_pseudonymizer/pseudonym/gender_detector.py`
  - [x] Class `GenderDetector`:
    ```python
    class GenderDetector:
        def __init__(self, lookup_path: str | None = None):
            self._male_names: set[str] = set()
            self._female_names: set[str] = set()
            self._ambiguous_names: set[str] = set()
            self._loaded: bool = False

        def load(self) -> None:
            """Load gender lookup dictionary from JSON."""

        def detect_gender(self, first_name: str) -> str | None:
            """Detect gender from first name.

            Returns: "male", "female", or None (unknown/ambiguous)
            """

        def detect_gender_from_full_name(self, full_name: str, entity_type: str) -> str | None:
            """Detect gender from full entity name.

            For PERSON entities: parse first name, detect gender.
            For non-PERSON entities: return None.
            Compound names: first component determines gender.
            """
    ```
  - [x] Case-insensitive matching (normalize with `.capitalize()`)
  - [x] Compound name handling (AC4): split on `-`, use first component
    - "Jean-Pierre" -> lookup "Jean" -> male
    - "Marie-Claire" -> lookup "Marie" -> female
    - "Jean-Marie" -> lookup "Jean" -> male (first component wins)
  - [x] Ambiguous names return `None` (fallback to combined list = no regression)
  - [x] Unknown names return `None` (same fallback)
  - [x] Load lazily on first call to `detect_gender()` or explicitly via `load()`
  - [x] Use `from gdpr_pseudonymizer.resources import FRENCH_GENDER_LOOKUP_PATH` for data path
  - [x] Atomic commit

### Phase 2 -- Pipeline Integration (AC: 2, 3)

- [x] **Task 5.2.4: Integrate gender detection into `CompositionalPseudonymEngine`** (AC: 2, 3)
  - [x] Add `GenderDetector` as an optional dependency to `CompositionalPseudonymEngine.__init__()`:
    ```python
    def __init__(
        self,
        pseudonym_manager: PseudonymManager,
        mapping_repository: MappingRepository,
        gender_detector: GenderDetector | None = None,
    ):
    ```
  - [x] In `assign_compositional_pseudonym()`: if `gender` param is `None` AND `gender_detector` is available, auto-detect gender from `entity_text`
  - [x] Pass detected gender through to `pseudonym_manager.assign_pseudonym(gender=detected_gender)` -- this satisfies **AC3** (female entity -> female pseudonym, male entity -> male pseudonym, unknown -> combined list)
  - [x] **CRITICAL:** Do NOT change `assign_compositional_pseudonym()` signature -- it already accepts `gender: str | None`. The change is internal: auto-detect when `None` is passed.
  - [x] Atomic commit

- [x] **Task 5.2.5: Integrate gender detection into `DocumentProcessor`** (AC: 2)
  - [x] In `_init_processing_context()`: create `GenderDetector()` instance and pass to `CompositionalPseudonymEngine`:
    ```python
    gender_detector = GenderDetector()
    gender_detector.load()
    compositional_engine = CompositionalPseudonymEngine(
        pseudonym_manager=pseudonym_manager,
        mapping_repository=mapping_repo,
        gender_detector=gender_detector,
    )
    ```
  - [x] **No changes needed** to `_build_pseudonym_assigner()`, `_assign_new_pseudonym()`, or `_resolve_pseudonyms()` -- they already pass `gender=None` which triggers auto-detection inside `CompositionalPseudonymEngine`
  - [x] Atomic commit

- [x] **Task 5.2.6: Store detected gender in Entity records** (AC: 2)
  - [x] In `_assign_new_pseudonym()` method of `DocumentProcessor`:
    - After calling `assign_compositional_pseudonym()`, detect gender using the engine's gender detector
    - Store detected gender in `new_entity = Entity(..., gender=detected_gender, ...)`
    - Replace the current hardcoded `gender=None` on line 424
  - [x] For reused entities (existing in DB): gender remains as-is from the existing record
  - [x] **Design Decision:** For entities processed before this story (gender=None in DB), do NOT backfill. Gender will be populated for all new entities going forward. Backfilling would require re-processing documents.
  - [x] Atomic commit

### Phase 3 -- Unit Tests (AC: 5)

- [x] **Task 5.2.7: Unit tests for `GenderDetector`** (AC: 5)
  - [x] Create `tests/unit/pseudonym/test_gender_detector.py`
  - [x] Tests:
    - Load lookup dictionary -- success
    - Load from invalid path -- FileNotFoundError
    - Detect male name: "Jean" -> "male"
    - Detect female name: "Marie" -> "female"
    - Detect unknown name: "Xyzabc" -> None
    - Detect ambiguous name: "Camille" -> None
    - Case insensitive: "MARIE" -> "female", "jean" -> "male"
    - Compound name - male: "Jean-Pierre" -> "male" (AC4)
    - Compound name - female: "Marie-Claire" -> "female" (AC4)
    - Compound name - first component wins: "Jean-Marie" -> "male" (AC4)
    - Detect from full name (PERSON): "Marie Dupont" -> "female"
    - Detect from full name (LOCATION): "Paris" -> None
    - Detect from full name (ORG): "Acme Corp" -> None
    - Full name with title: "Dr. Marie Dupont" -- Note: title stripping is caller's responsibility (engine does it before calling detector)
    - Empty/None input handling
  - [x] Follow existing test patterns with `pytest` fixtures
  - [x] Atomic commit

- [x] **Task 5.2.8: Unit tests for gender-aware pseudonym assignment** (AC: 5)
  - [x] Create `tests/unit/pseudonym/test_gender_aware_assignment.py`
  - [x] Tests:
    - Assign pseudonym with gender=male -> pseudonym from male first names
    - Assign pseudonym with gender=female -> pseudonym from female first names
    - Assign pseudonym with gender=None -> pseudonym from combined list (regression test)
    - CompositionalPseudonymEngine with gender_detector: auto-detects gender from entity text
    - CompositionalPseudonymEngine without gender_detector: gender=None preserved (backward compat)
    - Gender consistency: same real first name always gets same-gender pseudonym
  - [x] Use `LibraryBasedPseudonymManager` with `neutral` library loaded
  - [x] Atomic commit

- [x] **Task 5.2.9: Unit tests for gender storage in Entity** (AC: 5)
  - [x] Extend or create `tests/unit/core/test_document_processor_gender.py`
  - [x] Tests:
    - Process entity with detected gender -> Entity.gender field populated
    - Process entity with unknown gender -> Entity.gender is None
    - Process non-PERSON entity -> Entity.gender is None
    - Reused entity retains existing gender from database
  - [x] Use mock NLP detector and mock pseudonym manager (consistent with existing DocumentProcessor test patterns)
  - [x] Atomic commit

### Phase 4 -- Integration Test (AC: 6)

- [x] **Task 5.2.10: Integration test for gender-aware processing** (AC: 6)
  - [x] Create `tests/integration/test_gender_aware_processing.py`
  - [x] End-to-end test flow:
    1. `init` database with passphrase
    2. Process a document containing known male and female French names
    3. Verify pseudonymized output preserves gender coherence:
       - Female name "Marie Dupont" -> pseudonym uses female first name from library
       - Male name "Jean Martin" -> pseudonym uses male first name from library
    4. Query database entities -> verify `gender` field is populated ("male"/"female")
    5. Verify unknown names get `gender=None` and still get valid pseudonyms
    6. Verify compound names: "Marie-Claire Dubois" -> female pseudonym first name
  - [x] Use `CliRunner` or direct `DocumentProcessor` API
  - [x] Skip if spaCy model not available (Windows CI compatibility)
  - [x] Atomic commit

### Phase 5 -- Documentation (AC: 8)

- [x] **Task 5.2.11: Update methodology documentation** (AC: 8)
  - [x] Update `docs/CLI-REFERENCE.md` or relevant methodology page:
    - Describe gender-aware pseudonym assignment feature
    - Explain detection method (French first name lookup)
    - Document compound name handling
    - Document fallback behavior (unknown names use combined list)
    - Document data sources (pseudonym library + INSEE Open License 2.0)
  - [x] Atomic commit

### Phase 6 -- Regression Validation (AC: 7)

- [x] **Task 5.2.12: Full regression suite** (AC: 7)
  - [x] `poetry run black --check gdpr_pseudonymizer/ tests/`
  - [x] `poetry run ruff check .`
  - [x] `poetry run mypy gdpr_pseudonymizer/`
  - [x] `poetry run pytest tests/ -v --timeout=120 -p no:benchmark`
  - [x] Verify test count >= 1133 baseline (Story 5.1 count)
  - [x] Verify existing `process`, `batch`, `destroy-table` commands unaffected
  - [x] Verify existing mappings with `gender=None` remain valid and queryable
  - [x] Verify `--help` renders correctly

---

## Dev Notes

### Story Type

This is a **backend/pseudonym-engine story** -- new gender detection module, integration into the compositional pseudonym engine, and Entity.gender population. No CLI changes, no new commands, no schema migration, no NLP pipeline changes.

### Previous Story Insights

**[Source: Story 5.1 Dev Agent Record]**
- v1.0.6 released, 1133 tests passing (>= 1077 baseline)
- Windows spaCy segfault: CI skips spaCy tests on Windows -- relevant for integration test (skip decorator needed)
- Typer 0.9.x constraint: Not relevant to this story (no CLI changes)
- Shared test helper `strip_ansi()` in `tests/helpers.py` -- use if needed for CLI output assertions
- `pyproject.toml` has `pythonpath = ["tests"]` for shared helper imports

**[Source: Story 4.6.1 Dev Agent Record]**
- Codebase fully refactored: all quality gates green
- Lazy import pattern critical for CLI startup performance

### Data Models

**Entity Model** -- `gdpr_pseudonymizer/data/models.py`
[Source: architecture/4-data-models.md#4.1, architecture/9-database-schema.md#9.2]

Key fields for this story:
- `gender`: `Mapped[str | None]` -- nullable, values: `"male"`, `"female"`, `"neutral"`, `"unknown"`, or `None`
- Currently always stored as `None` -- this story populates it with detected gender
- **No schema migration needed** -- column already exists and accepts nullable strings
- `first_name`: `str` (encrypted) -- Used to extract first name for gender lookup
- `pseudonym_first`: `str` (encrypted) -- Will be gender-matched after this story

**Pseudonym Library Structure** -- `data/pseudonyms/neutral.json`
[Source: architecture/12-unified-project-structure.md, verified against actual neutral.json]

```json
{
  "first_names": {
    "male": ["Gabriel", "Raphael", "Leo", ...],     // 411 names
    "female": ["Emma", "Lea", "Chloe", ...],        // 372 names
    "neutral": []                                     // 0 names (empty array)
  }
}
```

> **Note:** The `neutral` array in neutral.json is currently empty. Ambiguous/unisex names (Camille, Dominique, etc.) are handled by the `GenderDetector`'s own `ambiguous` list, which returns `None` and triggers the library manager fallback to `male + female` combined list. This is the intended behavior.

All three theme libraries (neutral, star_wars, lotr) have the same gender-tagged `first_names` structure with `male`, `female`, and `neutral` keys. The `_select_first_name(gender)` method already uses these categories. Gender-aware assignment works across all themes, not just `neutral`.

### How Gender Currently Flows (and Where It's Missing)

**Current flow (gender=None everywhere):**
[Source: verified against actual codebase]

1. `DocumentProcessor._build_pseudonym_assigner()` (line 228): `gender=None`
2. `DocumentProcessor._assign_new_pseudonym()` (line 407): `gender=None`
3. `DocumentProcessor._assign_new_pseudonym()` creates `Entity(gender=None)` (line 424)
4. `CompositionalPseudonymEngine.assign_compositional_pseudonym(gender=None)`
5. `LibraryBasedPseudonymManager.assign_pseudonym(gender=None)`
6. `_select_first_name(gender=None)` -> falls back to `male + female + neutral` combined list

**Target flow (gender detected):**
1. `GenderDetector` loaded during `_init_processing_context()`
2. `CompositionalPseudonymEngine` receives `gender_detector` instance
3. `assign_compositional_pseudonym()` auto-detects gender when `gender=None` is passed
4. `_select_first_name(gender="female")` -> selects from `self.first_names["female"]` only
5. `Entity(gender="female")` stored in database

### Gender Lookup Data Strategy

**Primary source: Existing pseudonym library data**
[Source: data/pseudonyms/neutral.json, verified]

The neutral.json `first_names` section already classifies ~500+ names by gender:
- `first_names.male`: ~250+ names (INSEE top male names 2017-2021)
- `first_names.female`: ~250+ names (INSEE top female names 2017-2021)
- `first_names.neutral`: ~20+ unisex names

**Secondary source: `french_names.json` resource**
[Source: gdpr_pseudonymizer/resources/french_names.json, verified]

The `french_names.json` file contains ~400+ first names in a flat list (no gender tags). These names are used for regex-based NER detection. Many overlap with the pseudonym library. Names NOT in the pseudonym library can be classified using:
- Common French naming conventions (names ending in `-e`, `-ette`, `-ine` are typically female)
- Cross-reference with pseudonym library gender tags
- Manual classification of remaining ambiguous names

**INSEE License Compatibility:**
[Source: neutral.json `data_sources[0]`]
- Source: INSEE Fichier des prenoms
- License: **Open License 2.0 (Etalab)** -- explicitly compatible with MIT
- URL: https://www.insee.fr/fr/statistiques/fichier/2540004/nat2021_csv.zip
- This data is already used in the neutral pseudonym library -- no new licensing concerns

### File Locations

[Source: architecture/12-unified-project-structure.md, verified against actual codebase]

| New File | Purpose |
|----------|---------|
| `data/french_gender_lookup.json` | Source gender lookup dictionary (development) |
| `gdpr_pseudonymizer/resources/french_gender_lookup.json` | Bundled gender lookup dictionary (package) |
| `gdpr_pseudonymizer/pseudonym/gender_detector.py` | `GenderDetector` class |
| `tests/unit/pseudonym/test_gender_detector.py` | Unit tests for gender detection |
| `tests/unit/pseudonym/test_gender_aware_assignment.py` | Unit tests for gender-aware assignment |
| `tests/unit/core/test_document_processor_gender.py` | Unit tests for gender storage in Entity |
| `tests/integration/test_gender_aware_processing.py` | Integration test for full gender-aware pipeline |

| Modified File | Changes |
|----------------|---------|
| `gdpr_pseudonymizer/resources/__init__.py` | Add `FRENCH_GENDER_LOOKUP_PATH` constant |
| `gdpr_pseudonymizer/pseudonym/assignment_engine.py` | Add `gender_detector` param to `CompositionalPseudonymEngine.__init__()`, auto-detect gender in `assign_compositional_pseudonym()` |
| `gdpr_pseudonymizer/core/document_processor.py` | Create `GenderDetector` in `_init_processing_context()`, store detected gender in Entity |
| `docs/CLI-REFERENCE.md` (or methodology page) | Document gender-aware pseudonym assignment |

### Technical Constraints

- **No new dependencies:** This feature uses only stdlib + existing `json` loading patterns. No new pip packages required.
[Source: architecture/3-tech-stack.md]
- **No schema migration:** The `Entity.gender` column already exists as `Mapped[str | None]`. No Alembic migration needed.
[Source: architecture/9-database-schema.md#9.2]
- **Backward compatibility:** Existing entities with `gender=None` must remain valid. New entities get detected gender. No backfilling.
- **Encryption:** Gender lookup operates on plaintext first names BEFORE encryption. The first name is available in plaintext during entity processing (before `save_batch()` encrypts it).
[Source: architecture/9-database-schema.md#9.3]
- **Performance:** Gender lookup is O(1) set membership check. No measurable impact on processing time.
- **Windows CI:** Integration test must use `@pytest.mark.skipif` for spaCy-dependent tests (Windows segfault known issue).
[Source: MEMORY.md -- Windows/spaCy Known Issue]

### Design Decisions for Dev Agent

**1. Gender Detection Granularity:** The gender detector returns `"male"`, `"female"`, or `None`. It does NOT return `"neutral"` or `"unknown"` -- those are pseudonym library categories, not detection results. When detection returns `None`, the pseudonym manager falls back to the combined list (which includes neutral names). This preserves current behavior for unrecognized names.

**2. Where to Integrate Gender Detection:** Gender detection is added inside `CompositionalPseudonymEngine`, NOT in `DocumentProcessor`. This keeps the core processor clean and allows the engine to auto-detect gender when `gender=None` is passed. The engine already receives `gender` as a parameter -- the change is purely internal auto-detection.

**3. Compound Name Strategy (AC4):** Use first component of hyphenated names: "Jean-Pierre" -> lookup "Jean" -> male. This is the standard French naming convention. Edge case: "Jean-Marie" (male name with female second component) -> "Jean" -> male. This matches cultural usage.

**4. Ambiguous Names:** Names like "Camille", "Dominique", "Claude" are genuinely unisex in French. These return `None` (not forced to either gender). The pseudonym manager then uses the combined list, which may assign either gender -- this is acceptable and mirrors the real-world ambiguity.

**5. Data File Location:** Following the existing pattern, the gender lookup data is stored in both `data/` (development source) and `gdpr_pseudonymizer/resources/` (bundled with package). The `resources/__init__.py` module provides the path constant, exactly like `FRENCH_NAMES_PATH` and `DETECTION_PATTERNS_PATH`.

### Project Structure Notes

All file locations verified against actual codebase structure:
- Pseudonym modules in `gdpr_pseudonymizer/pseudonym/` (snake_case module names)
- Resources in `gdpr_pseudonymizer/resources/` with path constants in `__init__.py`
- Test files mirror source structure under `tests/unit/` and `tests/integration/`
- Data source files in `data/` (development), bundled copies in `gdpr_pseudonymizer/resources/`
- No structural conflicts identified

---

## Testing

### Testing Standards
**[Source: [architecture/16-testing-strategy.md](../architecture/16-testing-strategy.md), [architecture/19-coding-standards.md](../architecture/19-coding-standards.md)]**

**Test Framework:** pytest 7.4+ with pytest-cov, pytest-mock
**Build System:** `poetry run` for all test commands
**Coverage Target:** Maintain >= 86% (current baseline)

**Test file locations:**
- Unit tests: `tests/unit/pseudonym/` and `tests/unit/core/`
- Integration tests: `tests/integration/`

**Gender detector test pattern:**
```python
class TestGenderDetector:
    def test_detect_male_name(self) -> None:
        detector = GenderDetector()
        detector.load()
        assert detector.detect_gender("Jean") == "male"

    def test_detect_female_name(self) -> None:
        detector = GenderDetector()
        detector.load()
        assert detector.detect_gender("Marie") == "female"

    def test_detect_unknown_name(self) -> None:
        detector = GenderDetector()
        detector.load()
        assert detector.detect_gender("Xyzabc") is None
```

**Integration test pattern** (with spaCy skip):
```python
import pytest
import sys

@pytest.mark.skipif(
    sys.platform == "win32",
    reason="spaCy segfaults on Windows (known issue)"
)
class TestGenderAwareProcessing:
    def test_gender_matched_pseudonyms(self, tmp_path: Path) -> None:
        # ... end-to-end test ...
```

**Expected new test count:** ~20-30 new tests (unit + integration)
**Post-story test target:** >= 1155 total tests
**Baseline note:** Story 5.1 reported 1133 tests via `pytest` (includes parametrized test variants). `grep "def test_"` yields ~1105 test functions -- the difference is normal due to pytest parametrize expanding single functions into multiple test cases.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Initial story draft created from Epic 5 PRD with full architecture context, codebase analysis, gender flow tracing, and design decisions | Bob (SM Agent) |
| 2026-02-12 | 1.1 | PO validation: fixed neutral.json counts (neutral array is empty, male=411, female=372), clarified Task 5.2.1 neutral extraction, added AC3 mapping to Task 5.2.4, noted theme library cross-compatibility, clarified test baseline counts | Sarah (PO Agent) |
| 2026-02-12 | 1.2 | Story approved by PO after validation (score 10/10, high confidence) | Sarah (PO Agent) |
| 2026-02-12 | 1.3 | Implementation complete: all 12 tasks done, 46 new tests (1179 total), all quality gates pass | James (Dev Agent, Claude Opus 4.6) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References
No debug issues encountered. All tasks completed on first attempt.

### Completion Notes
- All 12 tasks completed, all subtasks checked
- 46 new tests added (30 GenderDetector + 8 gender-aware assignment + 5 gender storage + 3 integration)
- Total test count: 1179 collected (exceeds 1133 baseline)
- Quality gates: Black, Ruff, mypy all pass; 1058 tests passed (excl. Windows spaCy segfault + benchmark fixture)
- Gender lookup: 470 male + 457 female + 18 ambiguous = 945 names (exceeds 500 target)
- No new dependencies added
- No schema migration needed (Entity.gender column already exists)
- Backward compatible: existing entities with gender=None remain valid

### File List

| File | Status | Description |
|------|--------|-------------|
| `data/french_gender_lookup.json` | NEW | Source gender lookup dictionary (development) |
| `gdpr_pseudonymizer/resources/french_gender_lookup.json` | NEW | Bundled gender lookup dictionary (package) |
| `gdpr_pseudonymizer/resources/__init__.py` | MODIFIED | Added FRENCH_GENDER_LOOKUP_PATH constant |
| `gdpr_pseudonymizer/pseudonym/gender_detector.py` | NEW | GenderDetector class |
| `gdpr_pseudonymizer/pseudonym/assignment_engine.py` | MODIFIED | Added gender_detector param, auto-detect in assign_compositional_pseudonym() |
| `gdpr_pseudonymizer/core/document_processor.py` | MODIFIED | Create GenderDetector in _init_processing_context(), store gender in Entity |
| `scripts/build_gender_lookup.py` | NEW | One-time script to build gender lookup from existing data |
| `tests/unit/pseudonym/__init__.py` | NEW | Test package init |
| `tests/unit/pseudonym/test_gender_detector.py` | NEW | 30 unit tests for GenderDetector |
| `tests/unit/pseudonym/test_gender_aware_assignment.py` | NEW | 8 unit tests for gender-aware assignment |
| `tests/unit/core/__init__.py` | NEW | Test package init |
| `tests/unit/core/test_document_processor_gender.py` | NEW | 5 unit tests for Entity gender storage |
| `tests/integration/test_gender_aware_processing.py` | NEW | 3 integration tests for gender-aware pipeline |
| `docs/CLI-REFERENCE.md` | MODIFIED | Added Pseudonymization Methodology section |

---

## QA Results
*To be filled by QA agent*
