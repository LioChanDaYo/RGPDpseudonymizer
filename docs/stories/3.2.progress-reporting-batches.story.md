# Story 3.2: Progress Reporting for Large Batches

## Status

**Done**

---

## Story

**As a** user processing large batches (50+ documents),
**I want** real-time progress reporting with visual indicators and time estimates,
**so that** I understand processing status and can estimate completion time.

---

## Context

This story enhances the batch processing progress display implemented in Story 3.1. The current batch command has basic progress tracking (file count, elapsed time) but lacks detailed live feedback that users need when processing large document sets.

**Current State (Story 3.1):**
- Basic progress bar with file count and elapsed time
- Summary report after completion
- Sequential file processing (one file at a time)

**Missing Features:**
- Current file name displayed during processing
- Live entity detection count updates
- Live pseudonym creation count updates
- Estimated time remaining (ETA) calculation
- Per-file entity breakdown in summary

**User Impact:**
Without detailed progress reporting, users processing 50+ documents cannot:
- See which file is currently being processed
- Monitor entity detection progress in real-time
- Estimate when processing will complete
- Identify if processing is stalled

**Dependencies:**
- Story 3.1 (Complete CLI Command Set) - batch command foundation
- No blocking dependencies - can start immediately

---

## Acceptance Criteria

### AC1: Enhanced Progress Bar Display

- Use `rich` library for terminal progress bar (already available)
- Show: current file name, files completed/total, percentage complete
- Update in real-time as files are processed

**Target Display:**
```
Processing Batch...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 47/50 94% [4m 12s < 0m 16s]
Current: interview_48.txt
Entities: 1,124 | New: 456 | Reused: 312
```

### AC2: Live Entity Detection Counter

- Display entities detected count that updates after each file
- Display pseudonyms created (new) count that updates after each file
- Display pseudonyms reused count that updates after each file
- Update counters in progress display (not just final summary)

### AC3: Estimated Time Remaining (ETA)

- Calculate ETA based on average file processing time
- Update ETA dynamically as processing speed changes
- Display format: `[elapsed < remaining]` (e.g., `[4m 12s < 0m 16s]`)
- Handle edge cases: first file (no average yet), very fast/slow files

### AC4: Enhanced Completion Summary

- Final summary maintains current format from Story 3.1
- Add entity breakdown by type (PERSON / LOCATION / ORG) if `DocumentProcessor.process_document()` returns type-specific counts (check `ProcessingResult` dataclass for available fields; if not available, defer to future story)
- Progress bar transitions to "Complete" state with visual indicator (checkmark)
- Summary includes ETA accuracy metric (optional): "Estimated: 5m, Actual: 4m 32s"

### AC5: Testing Coverage

- Unit tests: Progress calculation, ETA estimation logic
- Unit tests: Edge cases (empty batch, single file, all files fail)
- Integration test (manual): Verify progress bar updates correctly during batch processing
- Target: ≥85% coverage for new progress tracking code

---

## Tasks / Subtasks

- [x] **Task 3.2.1: Refactor Progress Display Architecture** (AC: 1, 2)
  - [x] Create `ProgressTracker` class to encapsulate progress state and calculations
  - [x] Move progress tracking logic out of `batch_command()` into dedicated class
  - [x] Define `ProgressState` dataclass with: current_file, files_completed, files_total, entities_detected, pseudonyms_new, pseudonyms_reused, start_time, file_times
  - [x] Add method `update_file_complete(file_name, entities, new_pseudonyms, reused)`
  - [x] Add method `get_display_state()` returning formatted progress info

- [x] **Task 3.2.2: Implement ETA Calculation Logic** (AC: 3)
  - [x] Add method `calculate_eta()` to ProgressTracker
  - [x] Calculate average processing time per file: `total_elapsed / files_completed`
  - [x] Calculate remaining time: `avg_time * files_remaining`
  - [x] Handle edge case: first file (return "calculating..." or use heuristic)
  - [x] Handle edge case: processing speed variance (use rolling average of last 5 files)
  - [x] Return formatted string: "Xm Ys" or "< 1m" for short estimates

- [x] **Task 3.2.3: Create Enhanced Progress Display** (AC: 1, 2, 3)
  - [x] Create custom `rich.progress` columns for live stats display
  - [x] Add `CurrentFileColumn` showing file name being processed
  - [x] Add `EntityStatsColumn` showing "Entities: X | New: Y | Reused: Z"
  - [x] Add `ETAColumn` showing estimated time remaining
  - [x] Integrate columns into batch command progress bar
  - [x] Ensure display fits standard terminal width (80 chars)

- [x] **Task 3.2.4: Update Batch Command Integration** (AC: 1, 2, 3, 4)
  - [x] Instantiate ProgressTracker at start of batch processing
  - [x] Call `progress_tracker.update_file_complete()` after each file
  - [x] Update rich Progress display with tracker state after each file
  - [x] Handle progress display during error scenarios (file failures)
  - [x] Check `ProcessingResult` dataclass for entity type counts; if available, update final summary to include entity type breakdown (PERSON/LOCATION/ORG); if not available, skip this enhancement
  - [x] Add completion transition (progress bar → checkmark)

- [x] **Task 3.2.5: Add Unit Tests for Progress Tracking** (AC: 5)
  - [x] Create `tests/unit/cli/test_progress_tracker.py`
  - [x] `test_progress_tracker_initialization()`: Verify initial state
  - [x] `test_update_file_complete()`: Verify counters update correctly
  - [x] `test_eta_calculation_multiple_files()`: Verify ETA accuracy
  - [x] `test_eta_calculation_first_file()`: Verify edge case handling
  - [x] `test_eta_calculation_variance()`: Verify rolling average works
  - [x] `test_get_display_state()`: Verify formatted output
  - [x] `test_progress_tracker_empty_batch()`: Verify edge case (no files)

- [x] **Task 3.2.6: Add Unit Tests for Progress Display Columns** (AC: 5)
  - [x] `test_current_file_column_render()`: Verify file name display
  - [x] `test_entity_stats_column_render()`: Verify stats formatting
  - [x] `test_eta_column_render()`: Verify time formatting
  - [x] `test_column_width_constraints()`: Verify fits 80-char terminal

- [x] **Task 3.2.7: Integration Testing and Polish** (AC: 4, 5)
  - [x] Manual test with 15+ document test corpus
  - [x] Verify progress updates visually (screenshot/recording)
  - [x] Verify ETA accuracy within ±20% of actual time
  - [x] Run full test suite: `poetry run pytest tests/unit/cli/`
  - [x] Run coverage report: `poetry run pytest tests/unit/cli/ --cov=gdpr_pseudonymizer.cli --cov-report=term-missing`
  - [x] Fix any uncovered code paths

---

## Dev Notes

### Previous Story Insights

**From Story 3.1 (Complete CLI Command Set):**
- Batch command implemented in `gdpr_pseudonymizer/cli/commands/batch.py`
- Uses `rich.progress` for progress bars with existing columns: SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn, TimeElapsedColumn
- `BatchResult` dataclass tracks: total_files, successful_files, failed_files, total_entities, new_entities, reused_entities, total_time_seconds, errors
- Progress display already integrated, just needs enhancement
- Summary report uses `rich.table.Table` for formatted output

**From Story 3.1 Bug Fixes:**
- LOCATION/ORG library exhaustion now uses fallback naming (no crashes)
- Batch excludes `*_pseudonymized.*` files from processing

### Relevant Architecture Context

#### Rich Library Progress Components
**[Source: architecture/3-tech-stack.md]**

**Progress Bars:** rich 13.7+
- Already installed and used in batch command
- Supports custom columns via `rich.progress.ProgressColumn` subclass
- `Progress.update()` accepts arbitrary task data for custom columns
- See: https://rich.readthedocs.io/en/latest/progress.html#custom-columns

**Custom Column Pattern:**
```python
from rich.progress import ProgressColumn, Task
from rich.text import Text

class CurrentFileColumn(ProgressColumn):
    """Display current file being processed."""

    def render(self, task: Task) -> Text:
        current_file = task.fields.get("current_file", "")
        # Truncate long filenames to fit terminal
        if len(current_file) > 30:
            current_file = "..." + current_file[-27:]
        return Text(current_file, style="cyan")
```

#### Project Structure
**[Source: architecture/12-unified-project-structure.md]**

**Relevant File Locations:**
```
gdpr_pseudonymizer/
├── cli/
│   ├── commands/
│   │   └── batch.py           # ⚠️ MODIFY - Add progress tracking
│   ├── progress.py            # ⚠️ CREATE - ProgressTracker class
│   └── formatters.py          # Reference for output formatting

tests/
├── unit/
│   └── cli/
│       ├── test_progress_tracker.py  # ⚠️ CREATE
│       └── commands/
│           └── test_batch.py          # Reference existing patterns
```

#### Coding Standards
**[Source: architecture/19-coding-standards.md]**

**CRITICAL COMMANDS:**
```bash
# Run tests
poetry run pytest tests/unit/cli/

# Run linting
poetry run ruff check gdpr_pseudonymizer/cli/

# Run type checking
poetry run mypy gdpr_pseudonymizer/cli/
```

**Standards:**
- Absolute imports only: `from gdpr_pseudonymizer.cli.progress import ProgressTracker`
- Type hints required on all public methods
- No sensitive data logging (log counts only, never entity names)
- Dataclasses for structured data (like `ProgressState`)

#### Existing Batch Command Structure
**[Source: gdpr_pseudonymizer/cli/commands/batch.py]**

**Current Progress Implementation (lines 236-296):**
```python
with Progress(
    SpinnerColumn(),
    TextColumn("[progress.description]{task.description}"),
    BarColumn(),
    TaskProgressColumn(),
    TimeElapsedColumn(),
    console=console,
) as progress:
    task = progress.add_task("Processing files...", total=len(files))

    for file_path in files:
        # ... process file ...
        progress.advance(task)

    progress.update(task, description="✓ Processing complete")
```

**Enhancement Approach:**
1. Add custom columns (CurrentFileColumn, EntityStatsColumn, ETAColumn)
2. Use `task.fields` to pass dynamic data to columns
3. Call `progress.update(task, current_file=..., entities=..., etc.)` after each file

#### ETA Calculation Algorithm

**Recommended Approach (rolling average for stability):**
```python
def calculate_eta(self) -> str:
    """Calculate estimated time remaining."""
    if self.files_completed == 0:
        return "calculating..."

    # Use rolling average of last N files for stability
    recent_times = self.file_times[-5:] if len(self.file_times) >= 5 else self.file_times
    avg_time = sum(recent_times) / len(recent_times)

    files_remaining = self.files_total - self.files_completed
    eta_seconds = avg_time * files_remaining

    return self._format_duration(eta_seconds)

def _format_duration(self, seconds: float) -> str:
    """Format duration as 'Xm Ys' or '< 1m'."""
    if seconds < 60:
        return "< 1m"
    minutes = int(seconds // 60)
    secs = int(seconds % 60)
    return f"{minutes}m {secs}s"
```

---

## Testing

**[Source: architecture/16-testing-strategy.md]**

### Testing Standards

**Test File Locations:**
- Unit tests: `tests/unit/cli/test_progress_tracker.py`
- Batch command tests: `tests/unit/cli/commands/test_batch.py` (existing, may need updates)

**Coverage Target:** ≥85% for Epic 3

**Testing Frameworks:**
- pytest 7.4+ (primary framework)
- pytest-cov 4.1+ (coverage measurement)
- pytest-mock 3.12+ (mocking)

**Test Execution:**
```bash
# Run all CLI unit tests
poetry run pytest tests/unit/cli/

# Run progress tracker tests
poetry run pytest tests/unit/cli/test_progress_tracker.py -v

# Run with coverage report
poetry run pytest tests/unit/cli/ --cov=gdpr_pseudonymizer.cli --cov-report=term-missing
```

### Test Categories for Story 3.2

**Unit Tests (Primary Focus):**
- ProgressTracker state management
- ETA calculation accuracy
- Duration formatting
- Custom column rendering
- Edge cases (empty batch, single file, all failures)

**Unit Test Patterns:**
```python
# Example: test_progress_tracker.py
from gdpr_pseudonymizer.cli.progress import ProgressTracker

def test_eta_calculation_multiple_files():
    """Test ETA calculation with multiple completed files."""
    tracker = ProgressTracker(total_files=10)

    # Simulate 5 files completed, each taking ~2 seconds
    for i in range(5):
        tracker.update_file_complete(
            file_name=f"file_{i}.txt",
            processing_time=2.0,
            entities_detected=10,
            pseudonyms_new=5,
            pseudonyms_reused=5,
        )

    eta = tracker.calculate_eta()
    # 5 files remaining * 2 seconds avg = ~10 seconds
    assert "10s" in eta or "< 1m" in eta

def test_eta_calculation_first_file():
    """Test ETA returns 'calculating...' before first file completes."""
    tracker = ProgressTracker(total_files=10)

    eta = tracker.calculate_eta()
    assert eta == "calculating..."
```

**Integration Tests (Manual):**
- Visual verification of progress display
- ETA accuracy check (within ±20%)
- Large batch (50+ files) performance

---

## Change Log

| Date       | Version | Description                          | Author         |
|------------|---------|--------------------------------------|----------------|
| 2026-02-03 | 1.0     | Initial story draft created (SM)     | Bob (SM Agent) |
| 2026-02-03 | 1.1     | PO validation: Fixed unverifiable source ref, clarified entity type breakdown dependency, aligned display example with AC2 | Sarah (PO Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No blocking issues encountered during implementation.

### Completion Notes

- **AC1 (Enhanced Progress Bar Display)**: Implemented using `rich.live.Live` with `Group` to display progress bar, current file, and entity stats on separate lines. Progress bar shows file count, percentage, elapsed time, and ETA.

- **AC2 (Live Entity Detection Counter)**: Entity counts update in real-time after each file completes via `ProgressTracker.update_file_complete()`. Stats display shows "Entities: X | New: Y | Reused: Z" with thousands separators.

- **AC3 (Estimated Time Remaining)**: ETA calculation uses rolling average of last 5 files for stability. Handles edge cases: returns "calculating..." before first file, uses "< 1m" for short estimates. Display format: `[elapsed < remaining]`.

- **AC4 (Enhanced Completion Summary)**: Checked `ProcessingResult` dataclass - entity type breakdown (PERSON/LOCATION/ORG) not available, enhancement deferred per story instructions. Completion checkmark transition implemented.

- **AC5 (Testing Coverage)**: 29 unit tests covering ProgressTracker, ProgressState, DisplayState, and custom columns. Progress module achieves **100% test coverage**. CLI module overall at 77.50% coverage.

### File List

| File | Status | Description |
|------|--------|-------------|
| `gdpr_pseudonymizer/cli/progress.py` | **CREATED** | ProgressTracker, ProgressState, DisplayState dataclasses and custom rich columns (CurrentFileColumn, EntityStatsColumn, ETAColumn) |
| `gdpr_pseudonymizer/cli/commands/batch.py` | **MODIFIED** | Integrated ProgressTracker, added rich.live.Live display with current file and entity stats |
| `tests/unit/cli/test_progress_tracker.py` | **CREATED** | 29 unit tests for progress tracking module (100% coverage) |

---

## QA Results

### Review Date: 2026-02-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is well-structured and follows project coding standards. Key strengths:

- **Clean Architecture**: `ProgressTracker` properly encapsulates progress state and ETA calculation logic, separating concerns from the batch command
- **Proper Data Classes**: `ProgressState` and `DisplayState` provide clear, typed state containers
- **Robust ETA Calculation**: Rolling average of last 5 files provides stable estimates even with varying file processing times
- **Edge Case Handling**: Handles empty batches, first file (returns "calculating..."), and failed files appropriately
- **Rich Integration**: Effective use of `rich.live.Live` with `Group` for multi-line progress display

The code adheres to project conventions: absolute imports, type hints on all public methods, no sensitive data logging (only counts), and proper constant definitions.

### Refactoring Performed

None required. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ Absolute imports, type hints, no sensitive data logging, Poetry build system
- Project Structure: ✓ Files in correct locations (`cli/progress.py`, `tests/unit/cli/test_progress_tracker.py`)
- Testing Strategy: ✓ Unit tests with pytest, 100% coverage on new module, edge cases covered
- All ACs Met: ✓ All 5 acceptance criteria fully implemented

### Improvements Checklist

All items complete - no outstanding issues.

- [x] ProgressTracker encapsulates progress state and calculations (AC1, AC2)
- [x] ETA calculation with rolling average for stability (AC3)
- [x] Edge cases handled: empty batch, first file, failed files (AC3, AC5)
- [x] Entity stats displayed with thousands separators (AC2)
- [x] Completion checkmark transition implemented (AC4)
- [x] Entity type breakdown deferred correctly per story instructions (AC4)
- [x] 29 unit tests with 100% coverage on progress module (AC5)

### Security Review

No security concerns. This feature only handles progress display - no sensitive data is logged or exposed. Entity counts (not names) are displayed in the progress UI.

### Performance Considerations

No performance concerns. The rolling average calculation is O(1) (uses last 5 file times). The `rich.live.Live` display refreshes at 10fps, which is appropriate for CLI feedback.

### Files Modified During Review

None. No refactoring was required.

### Gate Status

Gate: **PASS** → `docs/qa/gates/3.2-progress-reporting-batches.yml`

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, no blocking issues.
