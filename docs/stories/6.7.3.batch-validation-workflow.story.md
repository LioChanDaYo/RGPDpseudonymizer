# Story 6.7.3: Batch Validation Workflow (FE-022)

## Status

**Done**

---

## Story

**As a** user processing multiple documents in batch mode,
**I want** the option to validate detected entities per document before pseudonymization proceeds,
**so that** I can review and correct entity detection on each document while still benefiting from batch automation.

---

## Acceptance Criteria

1. **AC1 — Validation Toggle in Batch Setup:**
   - A "Valider les entités par document" toggle (checkbox or switch) is added to the BatchScreen selection phase
   - The toggle defaults to **off** (fully automated batch — backward compatible)
   - Toggle state is persisted in GUI config (`batch_validate_per_document: bool`)
   - Toggle has accessible name/description in French

2. **AC2 — Batch Worker Pauses for Validation:**
   - When the toggle is enabled, `BatchWorker` emits a `validation_required(entities, document_text, doc_index, total_docs)` signal after the detection phase for each document
   - `BatchWorker` pauses processing and waits for a `validation_complete` signal before continuing to the next document
   - The pause/resume mechanism uses `QWaitCondition` + `QMutex`, matching the existing `_pause_condition` / `_mutex` pattern already used by `pause()` / `resume()` in BatchWorker
   - **Cancel during validation:** If the user cancels the batch while the ValidationScreen is open, all processing for the current batch is reverted — no partial output files are written. The BatchWorker's existing `_cancelled` flag is checked after `_validation_condition.wait()` returns; if set, the worker skips finalization for all remaining documents (including the current one) and cleans up any already-written output files from earlier documents in this batch run. Output file paths are tracked via `_written_files: list[Path]` on BatchWorker; cleanup is best-effort (log warnings on deletion failure, do not raise)

3. **AC3 — Validation Screen in Batch Context:**
   - When `validation_required` is emitted, the GUI navigates to the ValidationScreen
   - ValidationScreen detects batch context via `set_context(batch_mode=True, doc_index=X, total_docs=Y)`
   - A "Document X de Y" indicator is displayed prominently in batch mode
   - Navigation buttons "Précédent" / "Suivant" are shown in batch mode (hidden in single-doc mode). "Suivant" is only useful when the user has navigated backward via "Précédent" and wants to move forward through already-validated documents
   - An "Annuler le lot" button is shown in batch mode (hidden in single-doc mode), allowing the user to cancel the entire batch directly from the ValidationScreen without navigating back to BatchScreen first
   - The "Finaliser" button text changes to "Valider et continuer" in batch mode, or "Valider et terminer" for the last document

4. **AC4 — Resume After Validation:**
   - When the user clicks "Valider et continuer" (or "Valider et terminer" for the last document), the ValidationScreen emits `validation_complete` with the validated entity list
   - The BatchScreen receives the validated entities and signals the BatchWorker to resume
   - The worker finalizes the current document with validated entities and moves to the next
   - **Précédent navigation:** Clicking "Précédent" shows the cached validation state (entities as last validated) for a previously validated document. The worker remains paused on the current document. Re-submitting a previous document's validation replaces the stored result but does not re-trigger the worker
   - **Suivant navigation:** "Suivant" navigates forward through already-validated documents when the user has navigated backward via "Précédent". It is disabled on the current (latest) document awaiting validation

5. **AC5 — Skip Validation Toggle Remains Default:**
   - When the toggle is off, batch processing behaves identically to current implementation (fully automated, no validation pause)
   - The toggle can be changed per batch run (not a global-only setting)

6. **AC6 — Batch Validation Progress:**
   - The batch progress dashboard shows the current phase per document: "Détection", "En attente de validation", "Pseudonymisation", "Traité"
   - The step indicator reflects the current batch phase
   - ETA calculation accounts for validation pause time (exclude paused time from average)

7. **AC7 — Unit Tests:**
   - BatchWorker `validation_required` signal emission tested
   - Pause/resume with validation complete tested
   - ValidationScreen batch mode context tested (doc X/Y indicator, navigation buttons)
   - Toggle persistence tested
   - End-to-end batch validation workflow tested (at least 3 documents)

8. **AC8 — No Regression:**
   - Default batch mode (no validation) unchanged
   - All existing tests pass (CLI + GUI)
   - Quality gates pass (Black, Ruff, mypy)
   - Coverage >= 86%

---

## Tasks / Subtasks

### Phase 1 — Batch Worker Validation Support (AC: 2)

- [x] **Task 1: Add validation pause/resume to BatchWorker** (AC: 2)
  - [x] 1.1: Add `validation_required = Signal(object, str, int, int)` to `WorkerSignals` or create a `BatchValidationSignals` subclass — parameters: `(entities, document_text, doc_index, total_docs)`
  - [x] 1.2: Add `validation_complete = Signal(object)` signal for receiving validated entities back
  - [x] 1.3: Add `_validation_condition: QWaitCondition` and reuse the existing `_mutex: QMutex` in `BatchWorker.__init__` — matching the existing `_pause_condition` pattern. Add `_waiting_for_validation: bool = False` flag to track state
  - [x] 1.4: Add `_validated_entities: list | None` field for receiving validation results
  - [x] 1.5: In the per-document processing loop, after detection phase: if `validate_per_document` is True, emit `validation_required`, then `_mutex.lock()`, set `_waiting_for_validation = True`, call `_validation_condition.wait(_mutex)`, set `_waiting_for_validation = False`, `_mutex.unlock()`
  - [x] 1.6: Add `submit_validation_result(entities)` method — acquires `_mutex`, sets `_validated_entities`, calls `_validation_condition.wakeAll()`, releases `_mutex` to unblock the worker
  - [x] 1.7: After resume, use `_validated_entities` instead of auto-accepted entities for finalization
  - [x] 1.8: Add `_written_files: list[Path]` to track output files written during the batch run (for cancel cleanup)

### Phase 2 — Batch Setup UI (AC: 1, 5)

- [x] **Task 2: Add validation toggle to BatchScreen** (AC: 1, 5)
  - [x] 2.1: Add `QCheckBox` "Valider les entités par document" to the selection phase, between the file table and the output directory row
  - [x] 2.2: Set accessible name and description in French
  - [x] 2.3: Default unchecked (backward compatible)
  - [x] 2.4: Read initial state from `self._config.get("batch_validate_per_document", False)`
  - [x] 2.5: Save toggle state to config on change
  - [x] 2.6: Pass `validate_per_document=True/False` to `BatchWorker.__init__`
  - [x] 2.7: Add to `retranslateUi()` for i18n

### Phase 3 — ValidationScreen Batch Mode (AC: 3, 4)

- [x] **Task 3: Add batch mode to ValidationScreen** (AC: 3)
  - [x] 3.1: Update `ValidationScreen.set_context()` to accept `batch_mode`, `doc_index`, `total_docs` kwargs
  - [x] 3.2: Add `_batch_mode: bool`, `_doc_index: int`, `_total_docs: int` fields
  - [x] 3.3: Add "Document X de Y" label — visible only in batch mode, positioned in the header area
  - [x] 3.4: Add "Précédent" and "Suivant" navigation buttons — visible only in batch mode
  - [x] 3.5: Change "Finaliser" button text to "Valider et continuer" when in batch mode, or "Valider et terminer" when `doc_index == total_docs - 1` (via `retranslateUi` check using `_batch_mode` and `_doc_index` fields — never check button text for state, per CODE-003)
  - [x] 3.6: Add "Annuler le lot" button — visible only in batch mode, positioned in the action bar. Emits a `batch_cancel_requested` signal when clicked. Connect in Task 5.8
  - [x] 3.7: Add accessible names/descriptions to all new batch mode widgets (Précédent, Suivant, Annuler le lot, Document X de Y label)
  - [x] 3.8: Update `setup_focus_order_validation()` to include new batch mode widgets when visible (Précédent → Suivant → Annuler le lot → existing order)

- [x] **Task 4: Implement batch navigation and validation completion** (AC: 4)
  - [x] 4.1: Define `validation_complete = Signal(object)` on ValidationScreen (or use existing signal pattern)
  - [x] 4.2: When "Valider et continuer" / "Valider et terminer" is clicked, emit `validation_complete` with validated entity list
  - [x] 4.3: "Précédent" button loads cached validation state from `BatchScreen._validation_results[doc_index]` — displays previously validated entities without re-triggering the worker (worker remains paused on current document). Re-submitting replaces the cached result. **Disabled when `doc_index == 0`** (first document, nothing to go back to)
  - [x] 4.4: "Suivant" button navigates forward through already-validated documents. **Disabled when viewing the current (latest) document awaiting validation** (i.e., when `doc_index >= current_awaiting_index`). Only useful after navigating backward via "Précédent"
  - [x] 4.5: When exiting batch mode (last document validated via "Valider et terminer"), navigate back to BatchScreen processing phase

### Phase 4 — BatchScreen ↔ ValidationScreen Orchestration (AC: 2, 3, 4, 6)

- [x] **Task 5: Wire batch validation signals in BatchScreen** (AC: 2, 3, 4, 6)
  - [x] 5.1: Connect `BatchWorker.signals.validation_required` to `_on_validation_required(entities, document_text, doc_index, total_docs)`
  - [x] 5.2: In `_on_validation_required`: instantiate a `DocumentProcessor(db_path, passphrase)` (using the batch's stored `_db_path` and `_passphrase` from `_launch_worker()` context), call `processor.build_pseudonym_previews(entities)` to generate previews, then call `MainWindow.navigate_to("validation", ...)` assembling the full `set_context()` kwargs by combining signal data (`entities`, `document_text`, `doc_index`, `total_docs`) with batch-level state (`db_path=self._db_path`, `passphrase=self._passphrase`, `document_path=self._files[doc_index]`, `pseudonym_previews=previews`, `batch_mode=True`)
  - [x] 5.3: Connect `ValidationScreen.validation_complete` to `_on_validation_complete(validated_entities)`
  - [x] 5.4: In `_on_validation_complete`: call `self._worker.submit_validation_result(validated_entities)`, navigate back to BatchScreen processing phase
  - [x] 5.5: Store per-document validation results for "Précédent" navigation: `_validation_results: dict[int, list[DetectedEntity]]`
  - [x] 5.6: Update batch progress dashboard to show "En attente de validation" status for current document during validation pause
  - [x] 5.7: Exclude validation pause time from ETA calculation (track cumulative validation time separately)
  - [x] 5.8: Implement cancel-during-validation: connect both BatchScreen's cancel button **and** ValidationScreen's `batch_cancel_requested` signal to the same cancel handler. Handler sets `BatchWorker._cancelled` and calls `_validation_condition.wakeAll()` (unblocks worker). Worker checks `_cancelled` after wait and skips finalization. Iterate `_written_files` and delete each (best-effort, log warnings on failure). Navigate from ValidationScreen back to BatchScreen on cancel

### Phase 5 — Testing (AC: 7, 8)

- [x] **Task 6: Write batch validation unit tests** (AC: 7)
  - [x] 6.1: Create `tests/unit/gui/test_batch_validation.py`
  - [x] 6.2: Test BatchWorker emits `validation_required` when `validate_per_document=True`
  - [x] 6.3: Test BatchWorker pauses and resumes after `submit_validation_result()`
  - [x] 6.4: Test BatchWorker skips validation when `validate_per_document=False` (default)
  - [x] 6.5: Test ValidationScreen batch mode context (doc indicator, navigation buttons visible)
  - [x] 6.6: Test ValidationScreen non-batch mode (doc indicator hidden, navigation buttons hidden)
  - [x] 6.7: Test toggle persistence in config

- [x] **Task 7: Write batch validation integration test** (AC: 7)
  - [x] 7.1: Create `tests/integration/gui/test_batch_validation_workflow.py`
  - [x] 7.2: Test end-to-end: 3 documents → validate each → finalize → verify all outputs written
  - [x] 7.3: Test cancel-during-validation: start 3-document batch with validation enabled, validate document 1, cancel during document 2 validation → verify output file from document 1 is cleaned up, no partial outputs remain, batch status shows cancelled

- [x] **Task 8: Regression verification** (AC: 8)
  - [x] 8.1: Run `poetry run pytest tests/unit/cli/ tests/integration/` — all pass
  - [x] 8.2: Run `poetry run pytest tests/unit/gui/` — all pass (355 tests)
  - [x] 8.3: Run quality gates (Black, Ruff, mypy) — all pass
  - [x] 8.4: Verify coverage >= 86% (covered by existing CI threshold)
  - [x] 8.5: Manual test: batch mode with toggle OFF — verify identical behavior to current implementation (verified via existing test_batch_screen.py regression tests passing)

---

## Dev Notes

### Current Batch Architecture

The batch workflow is a three-phase `QStackedWidget` in `BatchScreen`:
- **Phase 0 — Selection:** File/folder selection, output directory, start button
- **Phase 1 — Processing:** Progress dashboard, per-document table, pause/cancel
- **Phase 2 — Summary:** Result cards, per-document summary, export report

**BatchWorker** (`gui/workers/batch_worker.py`) processes documents sequentially in a background thread. It already supports:
- `pause()` / `resume()` via `QWaitCondition` + `QMutex` (`_pause_condition` / `_mutex`)
- `cancel()` via `_cancelled` flag + `_pause_condition.wakeAll()`
- Per-document progress emission via `DOC_DONE:{index}` messages

The validation pause mechanism must follow the same `QWaitCondition` + `QMutex` pattern — add a `_validation_condition: QWaitCondition` that shares the existing `_mutex`.

### Signal Flow (New)

```
BatchWorker (bg thread)          BatchScreen (GUI thread)           ValidationScreen
       |                                |                                |
       |--validation_required---------->|                                |
       |  (entities, text, idx, total)  |--navigate_to("validation")--->|
       |                                |  set_context(batch_mode=True)  |
       |  [BLOCKED on condition.wait()]  |                                |
       |                                |                                |
       |                                |<---validation_complete---------|
       |                                |  (validated_entities)          |
       |<--submit_validation_result-----|                                |
       |  (wakeAll, unblocks)            |--navigate_to("batch")-------->|
       |                                |  (back to processing phase)    |
       |                                |                                |
       |--[continues to finalize]       |                                |
```

### ValidationScreen API (to be added)

`ValidationScreen` does **not** have a `set_context()` method yet (unlike `BatchScreen` and `DatabaseScreen` which already implement the pattern). This story must add `set_context(**kwargs)` to `ValidationScreen`, following the same `**kwargs` convention used by other screens.

**Required kwargs:**
- `entities: list[DetectedEntity]`
- `document_text: str`
- `document_path: str`
- `pseudonym_previews: dict[str, str]`
- `db_path: str`
- `passphrase: str`
- `batch_mode: bool` (default False)
- `doc_index: int` (0-based, only meaningful when `batch_mode=True`)
- `total_docs: int` (only meaningful when `batch_mode=True`)

### UI Layout for Batch Mode

In batch mode, the ValidationScreen header and action bar should show:

```
Header:   [◀ Précédent]    Document 3 de 5    [Suivant ▶]
Action:   [Annuler le lot]                    [Valider et continuer]
```

- "Précédent" is disabled when `doc_index == 0`
- "Suivant" is disabled when viewing the current (latest) document awaiting validation
- "Finaliser" button becomes "Valider et continuer", or "Valider et terminer" for the last document (`doc_index == total_docs - 1`)
- Button text is determined by `_batch_mode` and `_doc_index` fields, never by inspecting current button text (CODE-003)

### `validate_per_document` vs existing `validation_mode`

BatchWorker already accepts a `validation_mode` parameter (passed through to `DocumentProcessor`), which controls whether the core processing pipeline auto-accepts detected entities. This is a **core-layer** parameter inherited from the CLI.

The new `validate_per_document` parameter is a **GUI-layer** flag that controls whether `BatchWorker` pauses between documents for interactive user validation on the ValidationScreen.

**How they interact:**
- `validate_per_document=False` (default): Batch runs fully automated. `validation_mode` is passed to the processor as-is (current behavior, unchanged).
- `validate_per_document=True`: After detection, the worker pauses and emits `validation_required`. The user validates entities on the ValidationScreen. The worker then finalizes with the user-validated entity list. In this case, the processor's built-in `validation_mode` should be set to skip auto-acceptance (the user is doing validation manually via the GUI).

**Implementation note:** When `validate_per_document=True`, pass `validation_mode="skip"` (or equivalent) to the processor so entities are not auto-accepted before the user sees them. The user's validation on the GUI replaces the processor's validation step entirely.

### Important Constraints

- **Thread safety:** `submit_validation_result()` is called from the GUI thread but modifies state read by the worker thread. The `QMutex` + `QWaitCondition` pair provides the necessary synchronization (same pattern as existing `pause()` / `resume()`).
- **Pseudonym preview regeneration:** When entering validation for a batch document, pseudonym previews must be generated for that document's entities. The `build_pseudonym_previews()` method on `DocumentProcessor` handles this.
- **DB session per document:** Each document's finalization opens its own `open_database` session. No shared session across the batch.
- **CODE-003:** Never use UI text for state logic. Use `self._batch_mode` boolean, not button text checks.

### Previous Story Insights

- **CODE-003 Pattern:** Never use UI text for state logic — use boolean flags or enums. [Source: Story 6.6]
- **Batch pause/cancel pattern:** `BatchWorker` already uses `QWaitCondition` + `QMutex` (`_pause_condition` / `_mutex`) for pause and `_cancelled` bool for cancel. Follow the same pattern for validation pause — add a `_validation_condition` sharing the same `_mutex`. [Source: Story 6.5]
- **Quality Gates:** Black, Ruff, mypy, pytest must all pass. [Source: Story 6.7]
- **i18n:** All new user-facing strings must go through `self.tr()` or `qarg()`. [Source: Story 6.6]
- **Accessibility:** All new widgets need `setAccessibleName()` and `setAccessibleDescription()`. [Source: Story 6.7]

### Story 6.7.2 Coordination Note

Story 6.7.2 (Database Background Threading) also modifies `gui/workers/signals.py`. If Story 6.7.2 is not yet merged when this story begins implementation, prefer **creating a `BatchValidationSignals` subclass** (Task 1.1 option B) rather than modifying `WorkerSignals` directly, to avoid merge conflicts. If 6.7.2 is already merged, either approach (subclass or extending `WorkerSignals`) is acceptable.

### Screen Navigation Model

Batch validation uses **inter-screen navigation** via `MainWindow.navigate_to("validation", ...)`, which switches the top-level `QStackedWidget` in `MainWindow`. This is distinct from the intra-screen phase switching within `BatchScreen`'s own `QStackedWidget`. The flow is:

1. BatchScreen (Phase 1 — Processing) → `MainWindow.navigate_to("validation", ...)` → **top-level stack switches** to ValidationScreen
2. ValidationScreen emits `validation_complete` → BatchScreen calls `MainWindow.navigate_to("batch")` → **top-level stack switches** back to BatchScreen (Phase 1 stays active)

The BatchScreen's internal phase `QStackedWidget` remains on Phase 1 (Processing) throughout validation — it does not switch phases.

### Source File Locations

| File | Role |
|------|------|
| `gdpr_pseudonymizer/gui/screens/batch.py` | Primary modification — add validation toggle, wire signals |
| `gdpr_pseudonymizer/gui/screens/validation.py` | Add batch mode context, doc indicator, navigation buttons |
| `gdpr_pseudonymizer/gui/workers/batch_worker.py` | Add validation_required signal, pause/resume mechanism |
| `gdpr_pseudonymizer/gui/workers/signals.py` | May need new signal definitions (or subclass) |
| `gdpr_pseudonymizer/gui/accessibility/focus_manager.py` | Update focus order for new batch mode widgets |
| `gdpr_pseudonymizer/gui/main_window.py` | May need signal routing between screens |
| `gdpr_pseudonymizer/core/document_processor.py` | `build_pseudonym_previews()` used for per-document previews |

### Testing

**Test File Locations:**
- `tests/unit/gui/test_batch_validation.py` — new file for batch validation unit tests
- `tests/integration/gui/test_batch_validation_workflow.py` — new file for integration tests

**Testing Framework and Patterns:**
- pytest + pytest-qt
- Mock `BatchWorker` for screen-level tests
- Use `QSignalSpy` for signal emission verification
- For integration tests: mock NLP detector, use real repos with `:memory:` DB
- Follow existing patterns in `tests/unit/gui/test_batch_screen.py` (if exists)

**Specific Testing Requirements:**
- Verify validation toggle default is OFF (backward compatibility)
- Verify batch processing is identical with toggle OFF vs current implementation
- Verify `validation_required` signal carries correct parameters
- Verify pause/resume with `submit_validation_result` unblocks the worker
- Verify "Document X de Y" indicator updates correctly
- Verify "Précédent" navigation shows previously validated state

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 1.0 | Initial story draft — extracted from Story 6.7 AC8 (FE-022, deferred from Story 6.5 DEFERRED-001) | Sarah (Product Owner) |
| 2026-02-26 | 1.1 | QA review fixes: clarified Suivant/Précédent navigation semantics, added "Valider et terminer" for last doc, added cancel-during-validation revert behavior (AC2), added pseudonym preview generation to Task 5.2, reframed ValidationScreen.set_context() as new (not existing), redefined Task 7.3 as cancel-revert test, clarified Précédent cached review flow (AC4) | Bob (Scrum Master) |
| 2026-02-26 | 1.2 | PO validation fixes: [CRIT-001] corrected threading.Event → QWaitCondition+QMutex to match actual BatchWorker implementation; [CRIT-002] added validate_per_document vs validation_mode relationship section; [SHOULD-001/004] expanded Task 5.2 with DocumentProcessor instantiation and set_context() kwargs assembly details; [SHOULD-002] added _written_files tracking and best-effort cleanup to AC2 and Task 5.8; [SHOULD-003] added Story 6.7.2 coordination note for signals.py; [NICE-001] added Screen Navigation Model section (inter-screen vs intra-screen); [NICE-002] added "Annuler le lot" cancel button to ValidationScreen in batch mode (AC3, Task 3.6); [NICE-003] specified Précédent/Suivant disable states (Task 4.3/4.4); updated UI layout mockup | Sarah (Product Owner) |
| 2026-02-26 | 2.0 | Implementation complete — all 8 tasks done, 19 unit + 2 integration tests, all quality gates pass | James (Dev Agent) |
| 2026-02-26 | 2.1 | QA fixes applied — FUNC-001 (prev/next content reload via cached contexts), BUG-001 (signal disconnect-before-connect), TYPE-001 (tightened _validated_entities typing), A11Y-001 (checkbox in tab order) | James (Dev Agent) |
| 2026-02-26 | 2.2 | Post-QA manual testing fixes: (1) Précédent/Suivant use setVisible instead of setEnabled; (2) Suivant now checks _validation_contexts instead of _validation_results + set_context calls _update_batch_nav_state; (3) Cancel shows "Annulé"/"Non traité" instead of "Traité", summary title "Traitement annulé", cancel dialog message corrected; (4) "Valider et terminer" fixed by issue 2. Also fixed batch screen reset on "Ouvrir un dossier" after completed batch | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (`claude-opus-4-6`)

### File List

| File | Action | Description |
|------|--------|-------------|
| `gdpr_pseudonymizer/gui/workers/signals.py` | Modified | Added `BatchValidationSignals` subclass with `validation_required` signal |
| `gdpr_pseudonymizer/gui/workers/batch_worker.py` | Modified | Added validation pause/resume via `QWaitCondition`, `_process_with_validation()`, `submit_validation_result()`, `_written_files` cancel cleanup |
| `gdpr_pseudonymizer/gui/screens/batch.py` | Modified | Added validation toggle checkbox, signal wiring (`_on_validation_required`, `_on_validation_complete`, `_do_cancel`), ETA validation-time exclusion, per-document validation result caching, `_reset_selection()` for fresh batch runs, cancel display with "Annulé"/"Non traité" statuses |
| `gdpr_pseudonymizer/gui/screens/validation.py` | Modified | Added batch mode: `set_context()` with `batch_mode`/`doc_index`/`total_docs`, "Document X de Y" header, Précédent/Suivant navigation (visibility-based), "Annuler le lot" button, `validation_complete`/`batch_cancel_requested` signals |
| `gdpr_pseudonymizer/gui/screens/home.py` | Modified | "Ouvrir un dossier" button now passes `reset=True` to batch screen navigation |
| `gdpr_pseudonymizer/gui/accessibility/focus_manager.py` | Modified | Updated `setup_focus_order_validation()` for batch mode widget focus order |
| `tests/unit/gui/test_batch_validation.py` | Created | 19 unit tests covering worker signals, pause/resume, validation screen batch mode, toggle persistence |
| `tests/integration/gui/test_batch_validation_workflow.py` | Created | 2 integration tests: 3-doc end-to-end workflow, cancel-during-validation cleanup |

### Debug Log References

- **Threading challenge**: `QWaitCondition.wait()` blocks indefinitely when `submit_validation_result()` is called from the same thread (signal fires before wait). Fixed by running worker in `threading.Thread` in tests
- **Qt cross-thread signals**: Qt uses `QueuedConnection` for cross-thread signals when no event loop is running. Fixed by using `Qt.DirectConnection` explicitly in test signal connections
- **Multi-doc polling race**: Worker transitions `_waiting_for_validation` True→False→True faster than test polling. Fixed with `_wait_for_nth_validation()` that polls combined condition (waiting AND signal count)
- **`isVisible()` vs `isHidden()`**: `isVisible()` checks full parent chain (fails in tests without shown window). Fixed by using `isHidden()` instead
- **Lazy import patching**: `save_gui_config` is lazy-imported in batch.py, so `monkeypatch.setattr("batch.save_gui_config", ...)` fails. Fixed by patching at source: `gdpr_pseudonymizer.gui.config.save_gui_config`
- **`_cumulative_validation_time` regression**: Attribute only initialized in `_launch_worker()`, not `__init__`. Tests calling `_on_progress` directly hit `AttributeError`. Fixed by adding init in `__init__`
- **Cancel flow regression**: New `if self._cancelled: break` after `process_document` was too aggressive — broke non-validation cancel by skipping result recording. Removed the redundant check (top-of-loop check and `result is None` check are sufficient)
- **mypy type errors**: Used wrong `type: ignore` codes (`[union-attr]` vs `[attr-defined]`), had unnecessary ignores in validation.py. Fixed with proper TYPE_CHECKING imports and correct ignore codes

### Completion Notes

- Created `BatchValidationSignals` as a subclass of `WorkerSignals` (per Story 6.7.2 coordination note) to avoid merge conflicts with signals.py
- All i18n strings use `self.tr()` and `qarg()` per Story 6.6 patterns
- All new widgets have `setAccessibleName()` and `setAccessibleDescription()` per WCAG 2.1 AA (Story 6.7)
- CODE-003 pattern followed: batch mode state uses `_batch_mode` boolean, never button text inspection
- spaCy segfault on Windows (`spacy.ml.staticvectors`) is a known pre-existing issue (Story 4.6.1), not related to this story's changes. CI skips these tests on Windows
- Carry-forward: DATA-001 (Story 6.3) entity type count issue remains unresolved (unrelated to this story)

---

## QA Results

### Review Date: 2026-02-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Solid implementation overall. The story introduces a well-structured batch validation workflow that follows established project patterns. Thread safety is properly handled using `QWaitCondition` + `QMutex` (matching existing `pause()`/`resume()` pattern). The `BatchValidationSignals` subclass approach correctly avoids merge conflicts with Story 6.7.2. Signal flow between `BatchWorker` → `BatchScreen` → `ValidationScreen` is clear and well-documented in Dev Notes. Cancel-during-validation cleanup is thorough with best-effort file removal. Initial review found two medium and two low issues; all four have been addressed in the dev's follow-up pass.

### Refactoring Performed

None by QA — dev addressed all identified issues directly.

### Compliance Check

- Coding Standards: ✓ Absolute imports, no sensitive data logging, type hints on all public methods
- Project Structure: ✓ Files placed in correct locations per architecture
- Testing Strategy: ✓ 19 unit + 2 integration tests using pytest-qt, proper fixture patterns, mock-appropriate boundaries
- All ACs Met: ✓ All 8 ACs verified (AC4 Précédent/Suivant fixed in follow-up)

### Improvements Checklist

- [x] **FUNC-001** (medium): Fix `_on_prev_doc` / `_on_next_doc` to reload cached entity data into editor/panel — added `_validation_contexts` dict caching full set_context kwargs per document; prev/next now call `set_context(**cached_ctx)` to fully reload entities, text, and previews
- [x] **BUG-001** (medium): Prevent signal double-connection in `_launch_worker()` — added disconnect-before-connect pattern with try/except RuntimeError for first-run case
- [x] **TYPE-001** (low): Tighten `_validated_entities` type annotation from `list[object] | None` to `list[DetectedEntity] | None` using a `TYPE_CHECKING` import, also tightened `submit_validation_result()` signature
- [x] **A11Y-001** (low): Add `_validate_checkbox` to the tab order in `setup_focus_order_batch()` — checkbox now in keyboard navigation chain between `_file_table` and `_start_btn`

### Security Review

No security concerns. Passphrase handling follows existing patterns — stored as instance variable for session scope, passed through signals only within the same process. No sensitive data logged. Database session management uses existing `open_database` context manager (per-document sessions, no shared session across batch).

### Performance Considerations

Minor: `_on_validation_required` creates a new `DocumentProcessor(db_path, passphrase)` for each document to call `build_pseudonym_previews()`. Since `DocumentProcessor.__init__` may load the NLP model, consider caching the processor instance across the batch run if this becomes a bottleneck. Current impact is low since model loading is lazy/cached at the spaCy level.

### Files Modified During Review

None — no refactoring performed (issues require dev decisions).

### Gate Status

Gate: PASS → docs/qa/gates/6.7.3-batch-validation-workflow.yml (updated from CONCERNS after fixes)

### Recommended Status

✓ Ready for Done — All 4 identified issues resolved. Quality score 90/100.

(Story owner decides final status)
