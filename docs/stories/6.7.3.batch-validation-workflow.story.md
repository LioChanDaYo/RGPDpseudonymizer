# Story 6.7.3: Batch Validation Workflow (FE-022)

## Status

**Draft**

---

## Story

**As a** user processing multiple documents in batch mode,
**I want** the option to validate detected entities per document before pseudonymization proceeds,
**so that** I can review and correct entity detection on each document while still benefiting from batch automation.

---

## Acceptance Criteria

1. **AC1 — Validation Toggle in Batch Setup:**
   - A "Valider les entités par document" toggle (checkbox or switch) is added to the BatchScreen selection phase
   - The toggle defaults to **off** (fully automated batch — backward compatible)
   - Toggle state is persisted in GUI config (`batch_validate_per_document: bool`)
   - Toggle has accessible name/description in French

2. **AC2 — Batch Worker Pauses for Validation:**
   - When the toggle is enabled, `BatchWorker` emits a `validation_required(entities, document_text, doc_index, total_docs)` signal after the detection phase for each document
   - `BatchWorker` pauses processing and waits for a `validation_complete` signal before continuing to the next document
   - The pause/resume mechanism uses a `threading.Event` (same pattern as the existing pause/cancel)

3. **AC3 — Validation Screen in Batch Context:**
   - When `validation_required` is emitted, the GUI navigates to the ValidationScreen
   - ValidationScreen detects batch context via `set_context(batch_mode=True, doc_index=X, total_docs=Y)`
   - A "Document X of Y" indicator is displayed prominently in batch mode
   - Navigation buttons "Suivant" / "Précédent" are shown in batch mode (hidden in single-doc mode)
   - The "Finaliser" button text changes to "Valider et continuer" in batch mode

4. **AC4 — Resume After Validation:**
   - When the user clicks "Valider et continuer", the ValidationScreen emits `validation_complete` with the validated entity list
   - The BatchScreen receives the validated entities and signals the BatchWorker to resume
   - The worker finalizes the current document with validated entities and moves to the next
   - If the user clicks "Précédent", they can revisit already-validated documents (re-validation replaces previous validation result)

5. **AC5 — Skip Validation Toggle Remains Default:**
   - When the toggle is off, batch processing behaves identically to current implementation (fully automated, no validation pause)
   - The toggle can be changed per batch run (not a global-only setting)

6. **AC6 — Batch Validation Progress:**
   - The batch progress dashboard shows the current phase per document: "Détection", "En attente de validation", "Pseudonymisation", "Traité"
   - The step indicator reflects the current batch phase
   - ETA calculation accounts for validation pause time (exclude paused time from average)

7. **AC7 — Unit Tests:**
   - BatchWorker `validation_required` signal emission tested
   - Pause/resume with validation complete tested
   - ValidationScreen batch mode context tested (doc X/Y indicator, navigation buttons)
   - Toggle persistence tested
   - End-to-end batch validation workflow tested (at least 3 documents)

8. **AC8 — No Regression:**
   - Default batch mode (no validation) unchanged
   - All existing tests pass (CLI + GUI)
   - Quality gates pass (Black, Ruff, mypy)
   - Coverage >= 86%

---

## Tasks / Subtasks

### Phase 1 — Batch Worker Validation Support (AC: 2)

- [ ] **Task 1: Add validation pause/resume to BatchWorker** (AC: 2)
  - [ ] 1.1: Add `validation_required = Signal(object, str, int, int)` to `WorkerSignals` or create a `BatchValidationSignals` subclass — parameters: `(entities, document_text, doc_index, total_docs)`
  - [ ] 1.2: Add `validation_complete = Signal(object)` signal for receiving validated entities back
  - [ ] 1.3: Add `_validation_event: threading.Event` to `BatchWorker.__init__` — initially set (not blocking)
  - [ ] 1.4: Add `_validated_entities: list | None` field for receiving validation results
  - [ ] 1.5: In the per-document processing loop, after detection phase: if `validate_per_document` is True, emit `validation_required`, clear the event, and `_validation_event.wait()`
  - [ ] 1.6: Add `submit_validation_result(entities)` method — sets `_validated_entities` and sets the event to unblock the worker
  - [ ] 1.7: After resume, use `_validated_entities` instead of auto-accepted entities for finalization

### Phase 2 — Batch Setup UI (AC: 1, 5)

- [ ] **Task 2: Add validation toggle to BatchScreen** (AC: 1, 5)
  - [ ] 2.1: Add `QCheckBox` "Valider les entités par document" to the selection phase, between the file table and the output directory row
  - [ ] 2.2: Set accessible name and description in French
  - [ ] 2.3: Default unchecked (backward compatible)
  - [ ] 2.4: Read initial state from `self._config.get("batch_validate_per_document", False)`
  - [ ] 2.5: Save toggle state to config on change
  - [ ] 2.6: Pass `validate_per_document=True/False` to `BatchWorker.__init__`
  - [ ] 2.7: Add to `retranslateUi()` for i18n

### Phase 3 — ValidationScreen Batch Mode (AC: 3, 4)

- [ ] **Task 3: Add batch mode to ValidationScreen** (AC: 3)
  - [ ] 3.1: Update `ValidationScreen.set_context()` to accept `batch_mode`, `doc_index`, `total_docs` kwargs
  - [ ] 3.2: Add `_batch_mode: bool`, `_doc_index: int`, `_total_docs: int` fields
  - [ ] 3.3: Add "Document X de Y" label — visible only in batch mode, positioned in the header area
  - [ ] 3.4: Add "Précédent" and "Suivant" navigation buttons — visible only in batch mode
  - [ ] 3.5: Change "Finaliser" button text to "Valider et continuer" when in batch mode (via `retranslateUi` check)
  - [ ] 3.6: Add accessible names/descriptions to new batch mode widgets
  - [ ] 3.7: Update `setup_focus_order_validation()` to include new batch mode widgets when visible

- [ ] **Task 4: Implement batch navigation and validation completion** (AC: 4)
  - [ ] 4.1: Define `validation_complete = Signal(object)` on ValidationScreen (or use existing signal pattern)
  - [ ] 4.2: When "Valider et continuer" is clicked, emit `validation_complete` with validated entity list
  - [ ] 4.3: "Précédent" button navigates to previously validated document (store validation results per document in BatchScreen)
  - [ ] 4.4: "Suivant" button is only enabled after current document is validated
  - [ ] 4.5: When exiting batch mode (last document validated), navigate back to BatchScreen processing phase

### Phase 4 — BatchScreen ↔ ValidationScreen Orchestration (AC: 2, 3, 4, 6)

- [ ] **Task 5: Wire batch validation signals in BatchScreen** (AC: 2, 3, 4, 6)
  - [ ] 5.1: Connect `BatchWorker.signals.validation_required` to `_on_validation_required(entities, document_text, doc_index, total_docs)`
  - [ ] 5.2: In `_on_validation_required`: navigate to ValidationScreen with batch context, pass entities and document text
  - [ ] 5.3: Connect `ValidationScreen.validation_complete` to `_on_validation_complete(validated_entities)`
  - [ ] 5.4: In `_on_validation_complete`: call `self._worker.submit_validation_result(validated_entities)`, navigate back to BatchScreen processing phase
  - [ ] 5.5: Store per-document validation results for "Précédent" navigation: `_validation_results: dict[int, list[DetectedEntity]]`
  - [ ] 5.6: Update batch progress dashboard to show "En attente de validation" status for current document during validation pause
  - [ ] 5.7: Exclude validation pause time from ETA calculation (track cumulative validation time separately)

### Phase 5 — Testing (AC: 7, 8)

- [ ] **Task 6: Write batch validation unit tests** (AC: 7)
  - [ ] 6.1: Create `tests/unit/gui/test_batch_validation.py`
  - [ ] 6.2: Test BatchWorker emits `validation_required` when `validate_per_document=True`
  - [ ] 6.3: Test BatchWorker pauses and resumes after `submit_validation_result()`
  - [ ] 6.4: Test BatchWorker skips validation when `validate_per_document=False` (default)
  - [ ] 6.5: Test ValidationScreen batch mode context (doc indicator, navigation buttons visible)
  - [ ] 6.6: Test ValidationScreen non-batch mode (doc indicator hidden, navigation buttons hidden)
  - [ ] 6.7: Test toggle persistence in config

- [ ] **Task 7: Write batch validation integration test** (AC: 7)
  - [ ] 7.1: Create `tests/integration/gui/test_batch_validation_workflow.py`
  - [ ] 7.2: Test end-to-end: 3 documents → validate each → finalize → verify all outputs written
  - [ ] 7.3: Test mixed: validate first 2 documents, skip validation for 3rd (toggle mid-batch is not supported, but auto-accept remaining if cancelled)

- [ ] **Task 8: Regression verification** (AC: 8)
  - [ ] 8.1: Run `poetry run pytest tests/unit/cli/ tests/integration/` — all pass
  - [ ] 8.2: Run `poetry run pytest tests/unit/gui/` — all pass
  - [ ] 8.3: Run quality gates (Black, Ruff, mypy) — all pass
  - [ ] 8.4: Verify coverage >= 86%
  - [ ] 8.5: Manual test: batch mode with toggle OFF — verify identical behavior to current implementation

---

## Dev Notes

### Current Batch Architecture

The batch workflow is a three-phase `QStackedWidget` in `BatchScreen`:
- **Phase 0 — Selection:** File/folder selection, output directory, start button
- **Phase 1 — Processing:** Progress dashboard, per-document table, pause/cancel
- **Phase 2 — Summary:** Result cards, per-document summary, export report

**BatchWorker** (`gui/workers/batch_worker.py`) processes documents sequentially in a background thread. It already supports:
- `pause()` / `resume()` via `threading.Event`
- `cancel()` via `_cancelled` flag
- Per-document progress emission via `DOC_DONE:{index}` messages

The validation pause mechanism should follow the same `threading.Event` pattern.

### Signal Flow (New)

```
BatchWorker (bg thread)          BatchScreen (GUI thread)           ValidationScreen
       |                                |                                |
       |--validation_required---------->|                                |
       |  (entities, text, idx, total)  |--navigate_to("validation")--->|
       |                                |  set_context(batch_mode=True)  |
       |  [BLOCKED on Event.wait()]     |                                |
       |                                |                                |
       |                                |<---validation_complete---------|
       |                                |  (validated_entities)          |
       |<--submit_validation_result-----|                                |
       |  (sets Event, unblocks)        |--navigate_to("batch")-------->|
       |                                |  (back to processing phase)    |
       |                                |                                |
       |--[continues to finalize]       |                                |
```

### ValidationScreen Current API

`ValidationScreen.set_context()` currently accepts:
- `entities: list[DetectedEntity]`
- `document_text: str`
- `document_path: str`
- `pseudonym_previews: dict[str, str]`
- `db_path: str`
- `passphrase: str`

New kwargs for batch mode:
- `batch_mode: bool` (default False)
- `doc_index: int` (0-based)
- `total_docs: int`

### UI Layout for Batch Mode

In batch mode, the ValidationScreen header should show:

```
[◀ Précédent]    Document 3 de 5    [Suivant ▶]
```

The "Finaliser" button becomes "Valider et continuer" (or "Valider et terminer" for the last document).

### Important Constraints

- **Thread safety:** `submit_validation_result()` is called from the GUI thread but modifies state read by the worker thread. The `threading.Event` provides the necessary synchronization.
- **Pseudonym preview regeneration:** When entering validation for a batch document, pseudonym previews must be generated for that document's entities. The `build_pseudonym_previews()` method on `DocumentProcessor` handles this.
- **DB session per document:** Each document's finalization opens its own `open_database` session. No shared session across the batch.
- **CODE-003:** Never use UI text for state logic. Use `self._batch_mode` boolean, not button text checks.

### Previous Story Insights

- **CODE-003 Pattern:** Never use UI text for state logic — use boolean flags or enums. [Source: Story 6.6]
- **Batch pause/cancel pattern:** `BatchWorker` already uses `threading.Event` for pause and `_cancelled` bool for cancel. Follow the same pattern for validation pause. [Source: Story 6.5]
- **Quality Gates:** Black, Ruff, mypy, pytest must all pass. [Source: Story 6.7]
- **i18n:** All new user-facing strings must go through `self.tr()` or `qarg()`. [Source: Story 6.6]
- **Accessibility:** All new widgets need `setAccessibleName()` and `setAccessibleDescription()`. [Source: Story 6.7]

### Source File Locations

| File | Role |
|------|------|
| `gdpr_pseudonymizer/gui/screens/batch.py` | Primary modification — add validation toggle, wire signals |
| `gdpr_pseudonymizer/gui/screens/validation.py` | Add batch mode context, doc indicator, navigation buttons |
| `gdpr_pseudonymizer/gui/workers/batch_worker.py` | Add validation_required signal, pause/resume mechanism |
| `gdpr_pseudonymizer/gui/workers/signals.py` | May need new signal definitions (or subclass) |
| `gdpr_pseudonymizer/gui/accessibility/focus_manager.py` | Update focus order for new batch mode widgets |
| `gdpr_pseudonymizer/gui/main_window.py` | May need signal routing between screens |
| `gdpr_pseudonymizer/core/document_processor.py` | `build_pseudonym_previews()` used for per-document previews |

### Testing

**Test File Locations:**
- `tests/unit/gui/test_batch_validation.py` — new file for batch validation unit tests
- `tests/integration/gui/test_batch_validation_workflow.py` — new file for integration tests

**Testing Framework and Patterns:**
- pytest + pytest-qt
- Mock `BatchWorker` for screen-level tests
- Use `QSignalSpy` for signal emission verification
- For integration tests: mock NLP detector, use real repos with `:memory:` DB
- Follow existing patterns in `tests/unit/gui/test_batch_screen.py` (if exists)

**Specific Testing Requirements:**
- Verify validation toggle default is OFF (backward compatibility)
- Verify batch processing is identical with toggle OFF vs current implementation
- Verify `validation_required` signal carries correct parameters
- Verify pause/resume with `submit_validation_result` unblocks the worker
- Verify "Document X de Y" indicator updates correctly
- Verify "Précédent" navigation shows previously validated state

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-25 | 1.0 | Initial story draft — extracted from Story 6.7 AC8 (FE-022, deferred from Story 6.5 DEFERRED-001) | Sarah (Product Owner) |
