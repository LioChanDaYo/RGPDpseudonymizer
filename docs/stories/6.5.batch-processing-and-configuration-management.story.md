# Story 6.5: Batch Processing & Configuration Management

## Status

**Done**

---

## Story

**As a** user with multiple documents to process,
**I want** to select a folder or multiple files and process them as a batch with a visual progress dashboard, and manage my mapping database through a dedicated screen,
**so that** I can pseudonymize entire document sets efficiently and manage entity mappings without CLI knowledge.

---

## Acceptance Criteria

### Batch Processing

1. **AC1 - Batch File Selection:** User can initiate batch processing via:
   - Folder selection ("Ouvrir un dossier" button on home screen, already wired to `navigate_to("batch")`)
   - Multi-file selection via file dialog
   - Drag-and-drop of a folder onto the home screen (already wired to `navigate_to("batch")`)
   - Discovered files listed with count and unsupported files greyed out
   - Output directory field with browse button (pre-populated from `default_output_dir` config; fallback: `{input_folder}/_pseudonymized/` subdirectory)

2. **AC2 - Batch Progress Dashboard:** During batch processing:
   - Overall progress bar shows X of Y documents (e.g., "5/12 (42%)")
   - Per-document status table with columns: #, Fichier, Entites, Statut
   - Status values: En attente, En cours, Traite, Erreur
   - Estimated time remaining displayed ("Temps estime restant : ~2 minutes")
   - Pause ("Suspendre") and Cancel ("Annuler le lot") buttons

3. **AC3 - Batch Validation Workflow:** Two modes controlled by Settings:
   - **Per-document** (`per_document`): After each document's entities are detected, pause for validation before proceeding to next document. Reuses existing `ValidationScreen`.
   - **Global** (`global`): Process all documents first, then validate all entities at once.
   - Known entities (already in mapping DB) auto-accepted in both modes.

4. **AC4 - Batch Summary Report:** On completion:
   - Summary showing: documents processed, entities detected/reused, errors encountered
   - Export summary as `.txt` report (export button)

5. **AC5 - Pause/Cancel:** User can:
   - Pause batch processing (current document finishes, next document waits)
   - Cancel batch (confirmation dialog: "Les documents deja traites seront conserves")
   - Already-processed files are preserved in output directory

### Configuration Management

6. **AC6 - Settings Screen Enhancement:** Settings screen (`settings.py`) already exists with batch section. Enhancements needed:
   - Workers slider/spinner (1-8) in "Traitement par lot" section — currently missing. This is a shared CLI/GUI config setting: persists to `.gdpr-pseudo.yaml` and controls CLI `batch --workers`; GUI batch is single-threaded (tooltip: "Nombre de workers pour le traitement en ligne de commande")
   - Default pseudonym theme selector (neutral/star_wars/lotr) — currently missing
   - Settings persist to `.gdpr-pseudo.yaml` via existing `save_gui_config()`

### Mapping Database Management

7. **AC7 - Database Management Screen:** Replace `StubScreen("Base de correspondances")` with full screen:
   - Database path display with browse button and recent databases dropdown
   - Database info summary: creation date, entity count, last operation timestamp
   - Search field for filtering entities by name or pseudonym (real-time)
   - Entity table with columns: checkbox, Type icon, Entite originale, Pseudonyme
   - Entity type filter (All, PERSON, LOCATION, ORG)

8. **AC8 - Entity Deletion (Article 17 RGPD):** From the database management screen:
   - Multi-select entities via checkboxes
   - "Supprimer la selection (N)" button with confirmation dialog listing all entities to be deleted
   - Confirmation dialog text: "Les correspondances suivantes seront supprimees de facon irreversible (Article 17 RGPD)"
   - Deletion logged as ERASURE operation in audit trail (reuses `AuditRepository.log_operation()`)
   - Toast notification on successful deletion

9. **AC9 - Database Export:** Export entity list as CSV for audit trail (entity name, type, pseudonym, first seen date)

### Quality Requirements

10. **AC10 - Unit and Integration Tests:** Tests cover:
    - Batch screen UI: file discovery, progress display, pause/cancel
    - Batch worker: signal emission, error handling, pause/cancel flags
    - Database screen: entity listing, search, filtering, deletion flow
    - Settings enhancements: workers slider persistence, theme persistence
    - Integration: batch end-to-end with mock processor

11. **AC11 - No CLI Regression:** CLI `gdpr-pseudo batch` and `gdpr-pseudo list-entities` and `gdpr-pseudo delete-mapping` commands unaffected

12. **AC12 - Performance:** Batch processing GUI responsive during processing (no main thread blocking). Progress updates smooth for batches of 50+ documents.

---

## Dev Notes

### Previous Story Insights (Story 6.4.1)

[Source: `docs/stories/6.4.1-validation-ui-visual-feedback-fixes.story.md#Dev Agent Record`]

- **GUI/CLI parity pattern**: Story 6.4.1 added `group_entity_variants()` to `DetectionWorker` to match CLI deduplication behavior. The same parity principle applies to batch processing: GUI batch must produce identical results to CLI `gdpr-pseudo batch`.
- **Global theme files**: Checkbox QSS moved to `resources/themes/light.qss` and `dark.qss` — new screens should NOT add inline stylesheets for standard widgets; instead rely on global theme QSS.
- **Worker pattern**: `QRunnable` + `WorkerSignals(QObject)` bridge is the established pattern. Batch worker should follow the same pattern as `DetectionWorker`/`FinalizationWorker`.
- **DATA-001 fix applied in 6.4**: Entity type counts now come from `detected_entities` list directly, not from `repo.find_all()`. Batch summary should count entities per-document similarly.

### Existing GUI Architecture

[Source: `gdpr_pseudonymizer/gui/app.py`, `main_window.py`]

**Screen registration pattern:**
```python
# In app.py _register_screens():
window.add_screen("batch", BatchScreen(window))      # Replace StubScreen
window.add_screen("database", DatabaseScreen(window)) # Replace StubScreen
```

**Navigation (current → modified):**
- `MainWindow.navigate_to("batch")` — already called from HomeScreen batch card and folder drop
- `MainWindow.navigate_to("database")` — already called from Outils menu "Base de correspondances..."
- Step indicator: Batch flow uses same 4-step indicator (Selection, Traitement, Validation, Resume)
- **New `set_context()` pattern:** Extend `navigate_to(name, **kwargs)` — if the target screen implements `set_context(**kwargs)`, call it before switching. This enables data passing (folder path to BatchScreen, detection result to ValidationScreen) without tight coupling. Screens that don't implement `set_context()` are unaffected.

**Configuration already available:**
- `gui/config.py`: `load_gui_config()` / `save_gui_config()` — merges defaults with YAML
- `_DEFAULT_CONFIG` already contains: `batch_validation_mode`, `continue_on_error`, `default_output_dir`, `default_db_path`
- Settings screen already has "Traitement par lot" section with validation mode radio and continue-on-error checkbox
- **New keys to add:** `default_theme` (str), `batch_workers` (int), `recent_databases` (list of paths, max 5)

### Batch Processing — CLI Implementation Reference

[Source: `gdpr_pseudonymizer/cli/commands/batch.py`]

**CLI `BatchResult` dataclass** (reuse or mirror for GUI):
```python
@dataclass
class BatchResult:
    total_files: int = 0
    successful_files: int = 0
    failed_files: int = 0
    total_entities: int = 0
    new_entities: int = 0
    reused_entities: int = 0
    total_time_seconds: float = 0.0
    errors: list[str] = field(default_factory=list)
```

**File discovery:** `collect_files()` discovers `.txt`, `.md`, `.pdf`, `.docx` files (excludes `*_pseudonymized*`). Reuse this logic or extract to shared utility.

**CLI parallel processing:** Uses `multiprocessing.Pool` with `imap_unordered()`. For GUI batch, use `QThreadPool` with sequential document processing (spaCy is NOT thread-safe, one document at a time) plus progress signals. The GUI does NOT need multiprocessing — a single background thread processing documents sequentially is sufficient (and avoids the spaCy thread-safety issue).

**Key constraint:** In CLI parallel mode (workers > 1), validation is auto-skipped because worker processes don't have stdin access. In GUI, per-document validation IS possible even in sequential mode — the worker pauses and emits a signal, the ValidationScreen handles it, then signals the worker to continue.

**Batch validation navigation flow:**
- **Per-document mode:** BatchWorker detects entities → emits `validation_needed(detection_result)` → BatchScreen calls `navigate_to("validation", detection_result=result)` → user validates in existing ValidationScreen → ValidationScreen emits completion signal → BatchScreen receives callback, calls `navigate_to("batch")`, signals worker to continue next document
- **Global mode:** BatchWorker processes all documents → emits `all_validation_needed(list[detection_results])` → BatchScreen iterates: for each result, navigates to ValidationScreen and back → after all validated, shows batch summary
- **Known entities** (already in mapping DB) are auto-accepted in both modes — no validation prompt needed

### Core Processing Integration

[Source: `gdpr_pseudonymizer/core/document_processor.py`, `docs/architecture/8-core-workflows.md`]

**`DocumentProcessor`** is the core processing engine. The GUI batch worker should:
1. Create one `DocumentProcessor` instance (with db_path, passphrase, theme, model)
2. Call `processor.process_document(input_path, output_path)` for each file sequentially
3. Emit progress signals after each document

**Existing `ProcessingWorker`** (used for single-doc in Story 6.3) creates a `DocumentProcessor` and calls `process_document()`. The batch worker follows the same pattern but loops over files.

### Mapping Repository API

[Source: `gdpr_pseudonymizer/data/repositories/mapping_repository.py`]

**Methods needed for Database Management screen:**

| Method | Purpose |
|--------|---------|
| `search_entities(search_term, entity_type)` | List entities with optional search + type filter |
| `find_all(entity_type=None)` | Get all entities, optional type filter |
| `delete_entity_by_id(entity_id)` | Delete single entity by UUID |
| `delete_entity_by_full_name(full_name)` | Delete by name |

**Database session:** Use `open_database(db_path, passphrase)` context manager from `gdpr_pseudonymizer.data.database`.

**Audit logging:** `AuditRepository.log_operation(operation_type="ERASURE", ...)` for Article 17 compliance. [Source: `docs/architecture/4-data-models.md#Operation`]

### Data Models

[Source: `gdpr_pseudonymizer/data/models.py`, `docs/architecture/4-data-models.md`]

**Entity model fields relevant for database screen table:**
- `id` (UUID string) — show truncated (8 chars) for display
- `entity_type` — PERSON/LOCATION/ORG — display as icon (matching CLI color scheme)
- `full_name` — encrypted, decrypted on read
- `pseudonym_full` — encrypted, decrypted on read
- `first_seen_timestamp` — datetime for display
- `theme` — pseudonym library used

### GUI UX Specification — Wireframes

[Source: `docs/architecture/gui-ux-specification.md#Section 4.6, 4.7, 4.8`]

**Batch Progress Dashboard wireframe (Section 4.6):**
- Step indicator at top: Selection > Traitement > Validation > Resume
- Overall progress bar with percentage
- Per-document table: #, Fichier, Entites, Statut (Traite/En cours/En attente)
- Estimated time remaining label
- Pause + Cancel buttons

**Database Management Screen wireframe (Section 4.8):**
- Database path display with browse button + recent databases
- Info line: "Creee le 10/02/2026 -- 48 entites -- Derniere operation : hier"
- Search field (real-time filtering)
- Entity table with checkboxes, type icons, entity name, pseudonym
- Action buttons: "Supprimer la selection (N)", "Exporter", "Retour"

**Delete confirmation dialog:**
- Title: "Supprimer N correspondances ?"
- Lists all selected entities with their pseudonyms
- Warns: "de facon irreversible (Article 17 RGPD)"
- Buttons: "Annuler" / "Supprimer (N)"

**Settings screen (Section 4.7) — already implemented, needs:**
- Workers slider (1-8) in "Traitement par lot" section
- Default pseudonym theme selector in "Traitement" section

### Passphrase Handling

[Source: `gdpr_pseudonymizer/gui/main_window.py`, `gui/widgets/passphrase_dialog.py`]

- `MainWindow` caches `(db_path, passphrase)` in memory for the session
- `PassphraseDialog` prompts user if not cached or if db_path changed
- Batch screen should reuse `MainWindow.get_passphrase()` or equivalent
- Database screen needs passphrase to open the mapping DB — reuse same cache

### File Locations for New Code

[Source: `docs/architecture/12-unified-project-structure.md`, existing GUI patterns]

| New File | Purpose |
|----------|---------|
| `gdpr_pseudonymizer/gui/screens/batch.py` | Batch processing screen (replaces StubScreen) |
| `gdpr_pseudonymizer/gui/screens/database.py` | Mapping database management screen (replaces StubScreen) |
| `gdpr_pseudonymizer/gui/workers/batch_worker.py` | Background worker for batch document processing |
| `tests/unit/gui/test_batch_screen.py` | Unit tests for batch screen |
| `tests/unit/gui/test_database_screen.py` | Unit tests for database management screen |
| `tests/unit/gui/test_batch_worker.py` | Unit tests for batch worker |

| Modified File | Changes |
|----------------|---------|
| `gdpr_pseudonymizer/gui/app.py` | Replace StubScreen imports with BatchScreen and DatabaseScreen |
| `gdpr_pseudonymizer/gui/config.py` | Add `default_theme` and `batch_workers` to `_DEFAULT_CONFIG` |
| `gdpr_pseudonymizer/gui/screens/settings.py` | Add workers slider + theme selector widgets |
| `gdpr_pseudonymizer/gui/main_window.py` | Wire folder selection to batch screen with folder path |

### Testing

[Source: `docs/architecture/16-testing-strategy.md`, existing test patterns in `tests/unit/gui/`]

**Test location:** `tests/unit/gui/` for unit tests, `tests/integration/gui/` for integration tests.

**Test framework:** pytest + pytest-qt (established pattern).

**Test patterns from existing GUI tests:**
- Use `qtbot` fixture from pytest-qt for widget testing
- Monkeypatch `gui.config._config_path` for settings tests
- Mock `DocumentProcessor` and `open_database` to avoid actual NLP/DB operations
- Workers tested by verifying signal emissions (progress, finished, error)
- Screens tested by verifying widget state after actions

**Coverage target:** 85%+ (maintain existing baseline).

### Technical Constraints

- **spaCy thread safety:** NOT thread-safe. Batch worker must process documents sequentially in a single thread (no multiprocessing in GUI — unlike CLI which uses `multiprocessing.Pool`)
- **PySide6 threading:** Use `QRunnable` + `QThreadPool` for batch worker (same as existing workers)
- **Passphrase security:** Never persist to config file. Session-only memory cache in `MainWindow`
- **Config shared with CLI:** `.gdpr-pseudo.yaml` is read by both GUI and CLI. New keys (`default_theme`, `batch_workers`) should be compatible with CLI `load_config()` validation (unknown keys are ignored by CLI)
- **Supported file extensions:** `.txt`, `.md`, `.pdf`, `.docx` — same as CLI (`SUPPORTED_EXTENSIONS`)
- **Exclude pattern:** Files matching `*_pseudonymized*` excluded from batch discovery (same as CLI)

---

## Tasks / Subtasks

- [x] **Task 1: Create Batch Processing Screen** (AC: 1, 2, 5, 12)
  - [x] Create `gdpr_pseudonymizer/gui/screens/batch.py` with `BatchScreen(QWidget)` class
  - [x] Implement file selection phase:
    - [x] Folder path input with browse button (pre-populated if navigated from home screen folder selection)
    - [x] Multi-file selection button ("Ajouter des fichiers")
    - [x] File discovery using supported extensions (`.txt`, `.md`, `.pdf`, `.docx`), excluding `*_pseudonymized*`
    - [x] File list display: filename, size, format — unsupported files greyed out with count
    - [x] Output directory field with browse button, pre-populated from `config["default_output_dir"]`; if empty, default to `{input_folder}/_pseudonymized/`
    - [x] "Demarrer le traitement" button to begin batch
  - [x] Implement batch progress dashboard:
    - [x] Step indicator: Selection > Traitement > Validation > Resume
    - [x] Overall `QProgressBar` with "X/Y (Z%)" label
    - [x] Per-document `QTableWidget` with columns: #, Fichier, Entites, Statut
    - [x] Status icons: En attente (circle), En cours (spinner/dot), Traite (check), Erreur (cross)
    - [x] Error row: tooltip or click-to-expand showing error detail message
    - [x] Estimated time remaining label
  - [x] Implement Pause/Cancel controls:
    - [x] "Suspendre" toggle button (pause/resume)
    - [x] "Annuler le lot" button with confirmation dialog ("Les documents deja traites seront conserves")
  - [x] Wire `MainWindow.navigate_to("batch")` with optional folder path parameter
  - [x] Passphrase prompt via existing `PassphraseDialog` before starting batch
  - [ ] Implement validation workflow navigation (AC3):
    - [ ] Per-document mode: on `validation_needed` signal from worker, call `navigate_to("validation", detection_result=result)` → ValidationScreen handles validation → on complete, emits signal → BatchScreen receives callback, calls `navigate_to("batch")` and signals worker to continue
    - [ ] Global mode: after all documents processed, iterate document-by-document through ValidationScreen (same navigation pattern, looping until all validated) → then show batch summary
    - [ ] Connect `ValidationScreen` completion signal to BatchScreen handler that resumes the worker

- [x] **Task 2: Create Batch Worker** (AC: 2, 3, 5, 12)
  - [x] Create `gdpr_pseudonymizer/gui/workers/batch_worker.py` with `BatchWorker(QRunnable)` class
  - [x] Define `BatchResult` dataclass in this module (mirror CLI's `cli.commands.batch.BatchResult` fields — do not import from CLI package)
  - [x] Implement sequential document processing loop:
    - [x] Create `DocumentProcessor` with db_path, passphrase, theme, model
    - [x] For each file: call `processor.process_document(input_path, output_path)`
    - [x] Emit `progress(int, str)` signal after each document (percentage, current filename)
    - [x] Emit `document_completed(dict)` signal with per-document result (entities count, time)
    - [x] Emit `finished(BatchResult)` on completion
    - [x] Emit `error(str)` on fatal error
  - [x] Implement pause/cancel support:
    - [x] `_paused` flag: checked between documents, blocks with `QWaitCondition` until unpaused
    - [x] `_cancelled` flag: checked between documents, breaks loop and emits partial results
  - [x] Implement continue-on-error:
    - [x] If `continue_on_error=True`: catch per-document exceptions, log error, continue to next
    - [x] If `continue_on_error=False`: stop batch on first error, emit error signal
  - [ ] Implement per-document validation mode support (AC3):
    - [ ] `validation_mode="per_document"`: after detection, emit `validation_needed(DetectionResult)` signal, wait for `validation_completed()` callback before writing output
    - [ ] `validation_mode="global"`: process all documents, emit `all_validation_needed(list[DetectionResult])` at end
  - [x] File discovery utility: extract `collect_files()` logic for reuse from CLI or reimplement

- [x] **Task 3: Implement Batch Summary Screen** (AC: 4)
  - [x] Add summary view to `BatchScreen` (shown after batch completion):
    - [x] Summary cards: documents processed, total entities, new entities, reused, errors
    - [x] Per-document results table with entity counts and timing
  - [x] Export summary as `.txt` report:
    - [x] "Exporter le rapport" button opens file save dialog
    - [x] Report includes: batch config, per-document results, entity summary, errors
  - [x] "Retour a l'accueil" button to navigate home

- [x] **Task 4: Create Database Management Screen** (AC: 7, 8, 9)
  - [x] Create `gdpr_pseudonymizer/gui/screens/database.py` with `DatabaseScreen(QWidget)` class
  - [x] Implement database connection UI:
    - [x] Database path display with browse button
    - [x] Recent databases dropdown (from config `recent_databases` list, updated on each DB open; max 5, most recent first)
    - [x] Passphrase prompt via `PassphraseDialog` when opening DB
    - [x] Info summary line: "Creee le ... -- N entites -- Derniere operation : ..."
  - [x] Implement entity listing:
    - [x] `QTableWidget` with columns: checkbox, Type (icon), Entite originale, Pseudonyme
    - [x] Type icons: person emoji/icon for PERSON, pin for LOCATION, building for ORG
    - [x] Search field with real-time filtering (calls `repo.search_entities()`)
    - [x] Entity type filter combo box (All, PERSON, LOCATION, ORG)
    - [x] Status bar: "N correspondances — M selectionnees"
  - [x] Implement entity deletion (Article 17):
    - [x] Multi-select via checkboxes
    - [x] "Supprimer la selection (N)" button — enabled only when N > 0
    - [x] Confirmation dialog listing all selected entities + pseudonyms
    - [x] Dialog text: "Les correspondances suivantes seront supprimees de facon irreversible (Article 17 RGPD)"
    - [x] On confirm: call `repo.delete_entity_by_id()` for each, log ERASURE via `AuditRepository`
    - [x] Toast notification: "N correspondance(s) supprimee(s)"
    - [x] Refresh entity table after deletion
  - [x] Implement export:
    - [x] "Exporter" button opens file save dialog (CSV format)
    - [x] CSV columns: entity_id (8-char), entity_type, full_name, pseudonym_full, first_seen
  - [x] "Retour" button navigates to home
  - [ ] Database operations run in background thread to keep GUI responsive

- [x] **Task 5: Enhance Settings Screen** (AC: 6)
  - [x] Add workers slider/spinner (1-8) to "Traitement par lot" section in `settings.py`
    - [x] Label: "Nombre de workers"
    - [x] `QSpinBox` with min=1, max=8, default from config
    - [x] Tooltip: "Nombre de workers pour le traitement en ligne de commande" (shared CLI/GUI config — GUI batch is single-threaded)
    - [x] Auto-save via existing `_save()` pattern
  - [x] Add default pseudonym theme selector to "Traitement" section
    - [x] Label: "Theme de pseudonymes par defaut"
    - [x] `QComboBox` with options: "Neutre (INSEE)", "Star Wars", "Le Seigneur des Anneaux"
    - [x] Values: `neutral`, `star_wars`, `lotr`
    - [x] Auto-save via existing `_save()` pattern
  - [x] Update `gui/config.py` `_DEFAULT_CONFIG`:
    - [x] Add `"default_theme": "neutral"`
    - [x] Add `"batch_workers": 4`
    - [x] Add `"recent_databases": []` (list of recently opened DB paths, max 5, most recent first)

- [x] **Task 6: Wire Screens into Application** (AC: 1, 7, 11)
  - [x] Update `gdpr_pseudonymizer/gui/app.py` `_register_screens()`:
    - [x] Replace `StubScreen("Traitement par lot", window)` with `BatchScreen(window)`
    - [x] Replace `StubScreen("Base de correspondances", window)` with `DatabaseScreen(window)`
    - [x] Add imports for new screen classes
  - [x] Update `MainWindow` navigation with `set_context()` pattern:
    - [x] Extend `navigate_to(name, **kwargs)`: if target screen has a `set_context(**kwargs)` method, call it with `**kwargs` before switching the stacked widget
    - [x] `BatchScreen.set_context(folder_path=...)` populates folder input field
    - [x] `ValidationScreen.set_context(detection_result=...)` accepts batch validation data
    - [x] `HomeScreen._on_folder_drop()` calls `navigate_to("batch", folder_path=path)`
    - [x] `MainWindow._on_open_folder()` calls `navigate_to("batch", folder_path=path)`
  - [x] Verify existing menu entries work:
    - [x] Outils > "Base de correspondances..." navigates to database screen
    - [x] Home screen batch card navigates to batch screen

- [x] **Task 7: Unit Tests** (AC: 10)
  - [x] Create `tests/unit/gui/test_batch_screen.py`:
    - [x] Test file discovery: finds .txt/.md/.pdf/.docx, excludes *_pseudonymized*
    - [x] Test file list display: correct count, unsupported greyed out
    - [x] Test progress bar updates on worker signals
    - [x] Test per-document table updates with status
    - [x] Test pause button toggles paused state
    - [x] Test cancel button shows confirmation dialog
    - [x] Test summary display after batch completion
    - [x] Test export report generates .txt file
  - [x] Create `tests/unit/gui/test_batch_worker.py`:
    - [x] Test worker emits progress signals for each document
    - [x] Test worker emits document_completed with correct data
    - [x] Test worker emits finished with BatchResult
    - [x] Test worker pause flag blocks between documents
    - [x] Test worker cancel flag stops processing
    - [x] Test continue-on-error: error logged, next document processed
    - [x] Test stop-on-error: batch stops on first failure
    - [x] Mock `DocumentProcessor` to avoid actual NLP/DB
  - [x] Create `tests/unit/gui/test_database_screen.py`:
    - [x] Test entity table populated from mock repository
    - [x] Test search field filters entities in real-time
    - [x] Test type filter shows only selected type
    - [x] Test checkbox selection updates "N selectionnees" count
    - [x] Test delete button disabled when nothing selected
    - [x] Test delete confirmation dialog shows selected entities
    - [x] Test deletion calls repo.delete_entity_by_id() and logs ERASURE
    - [x] Test export generates CSV with correct columns
    - [x] Test database info summary displays correctly
  - [x] Update `tests/unit/gui/test_settings.py`:
    - [x] Test workers spinner saves to config
    - [x] Test theme selector saves to config
    - [x] Test config round-trip with new keys (default_theme, batch_workers)

- [x] **Task 8: Integration Test** (AC: 10)
  - [x] Create `tests/integration/gui/test_batch_integration.py`:
    - [x] Test end-to-end: select folder > process batch > view summary
    - [x] Mock `DocumentProcessor` but verify signal flow and screen transitions
    - [x] Verify config persistence of batch settings across screen transitions

- [x] **Task 9: Quality Gates** (AC: 11, 12)
  - [x] Run full test suite: `poetry run pytest tests/`
  - [x] Verify CLI commands unaffected: `poetry run pytest tests/unit/cli/ tests/integration/cli/`
  - [x] `poetry run black --check gdpr_pseudonymizer/ tests/`
  - [x] `poetry run ruff check gdpr_pseudonymizer/`
  - [x] `poetry run mypy gdpr_pseudonymizer/`
  - [ ] Manual testing: batch flow, database management, settings enhancements

---

## Definition of Done

- [ ] **AC1:** Batch file selection works (folder, multi-file, drag-and-drop)
- [ ] **AC2:** Batch progress dashboard shows overall and per-document progress
- [ ] **AC3:** Both validation modes work (per-document and global)
- [ ] **AC4:** Batch summary report displayed and exportable
- [ ] **AC5:** Pause and cancel work correctly
- [ ] **AC6:** Settings screen has workers slider and theme selector
- [ ] **AC7:** Database management screen lists entities with search/filter
- [ ] **AC8:** Entity deletion with Article 17 confirmation and audit logging
- [ ] **AC9:** Entity list exportable as CSV
- [ ] **AC10:** Unit and integration tests pass with adequate coverage
- [ ] **AC11:** CLI functionality unaffected (no regression)
- [ ] **AC12:** GUI remains responsive during batch processing
- [ ] Code follows existing patterns and coding standards
- [ ] All quality gates pass (Black, Ruff, mypy, pytest)

---

## Risk and Compatibility Check

### Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| spaCy thread-safety in batch worker | LOW (mitigated) | HIGH | Single-thread sequential processing — no multiprocessing in GUI |
| Large batch (100+ files) overwhelms UI table | MEDIUM | LOW | Virtualized table or lazy loading; estimated time warning for large batches |
| Passphrase caching across batch + DB screens | LOW | MEDIUM | Reuse MainWindow session cache; re-prompt only when db_path changes |
| Per-document validation mode UX complexity | MEDIUM | MEDIUM | Clear step indicator; pause/resume between documents; progress persists |
| Config key compatibility CLI/GUI | LOW | LOW | CLI ignores unknown keys; GUI-only keys prefixed or in separate section |

### Compatibility Verification

- [ ] No breaking changes to CLI commands or existing APIs
- [ ] No database schema changes
- [ ] Config file additions are backward-compatible (new keys with defaults)
- [ ] Existing GUI screens (home, processing, validation, results, settings) unaffected
- [ ] New screens follow established patterns (QWidget, _build_ui, signal handlers)

---

## Validation Checklist

### Scope Validation
- [ ] Story can be completed in 1-2 weeks (per epic estimate)
- [ ] Integration approach reuses existing core processor and repository patterns
- [ ] Follows established GUI patterns exactly (screens, workers, signals, config)
- [ ] No new architecture or external dependencies required

### Clarity Check
- [ ] Story requirements are unambiguous (wireframes from UX spec provide visual targets)
- [ ] Integration points clearly specified (DocumentProcessor, MappingRepository, AuditRepository)
- [ ] Success criteria are testable (automated tests + manual verification)
- [ ] Rollback approach is simple (revert to StubScreens)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-20 | 1.0 | Initial story draft from Epic 6 requirements + architecture analysis | Bob (Scrum Master) |
| 2026-02-20 | 1.1 | PO validation fixes: added output directory to batch selection (CRIT-1), added validation workflow screen navigation with set_context() pattern (CRIT-2), clarified workers slider as shared CLI/GUI config (SHOULD-1), added recent_databases config key (SHOULD-2), specified navigate_to data-passing mechanism (SHOULD-3), removed entity frequency analysis from AC4 (SHOULD-4), added BatchResult location note, added error row detail | Sarah (Product Owner) |
| 2026-02-20 | 2.0 | Implementation complete. Tasks 1-9 done. AC3 validation workflow deferred (batch uses skip_validation=True). All quality gates pass (1356+ tests, black, ruff, mypy clean). | James (Dev) |
| 2026-02-20 | 2.1 | QA fixes applied: CODE-001 through CODE-005 resolved, 9 new tests added (1365 total). All quality gates pass. | James (Dev) |

---

## QA Results

### Review Date: 2026-02-20

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**DEEP review triggered by:**
- 12 acceptance criteria (>5 threshold)
- Diff > 500 lines across 8 new + 7 modified files
- Security-adjacent changes (Article 17 RGPD deletion, passphrase handling)
- AC3 (Batch Validation Workflow) explicitly deferred

### Code Quality Assessment

Overall quality is **good**. The implementation follows established GUI patterns (QRunnable workers, WorkerSignals bridge, screen registration, set_context navigation). All core APIs (Entity model, MappingRepository, AuditRepository, DocumentProcessor/ProcessingResult) are used correctly — verified against source definitions. No API mismatches found.

**Issues identified (ordered by priority):**

1. **DEFERRED-001 (medium)**: AC3 — Batch Validation Workflow not implemented. Batch processes all documents with `skip_validation=True`. Per-document and global validation modes are non-functional. Dev correctly identified this as requiring a separate story. Impact: Users cannot validate entities during batch processing — known entities are auto-accepted, but new entities skip validation entirely.

2. **CODE-001 (medium)**: `BatchWorkerSignals` class (batch_worker.py:86-91) is defined but never used — BatchWorker instantiates base `WorkerSignals` (line 112). Dead code.

3. **CODE-002 (medium)**: Multiple screens access `self._main_window._cached_passphrase` directly (batch.py:405, database.py:232). This is a private attribute — should be accessed via a public method/property on MainWindow for encapsulation.

4. **CODE-003 (low)**: Pause state in batch.py:573 is determined by checking `self._pause_btn.text() == "Suspendre"`. This is fragile — if text is ever changed or localized, the logic breaks. Should use a boolean flag `self._paused`.

5. **CODE-004 (low)**: `database.py:293` uses `datetime.utcnow()` which is deprecated since Python 3.12. Should use `datetime.now(datetime.timezone.utc)`.

6. **CODE-005 (low)**: `batch_worker.py:41` — `per_document_results` is typed as `list[dict[str, object]]` instead of using the `DocumentResult` dataclass. This causes multiple `str()`/`int()` casts in batch.py (lines 536, 538, 543) and loses type safety.

7. **PERF-001 (medium)**: Database screen operations (`_load_entities`, `_delete_selected`) run on the main thread. For databases with many encrypted entities, this causes UI freezes. Dev acknowledged this in completion notes — a `DatabaseWorker` would be needed for fully responsive operation.

### Requirements Traceability

| AC | Status | Tests | Gaps |
|----|--------|-------|------|
| AC1 - Batch File Selection | Implemented | `test_discover_supported_files`, `test_excludes_pseudonymized`, `test_empty_folder_disables_start`, `test_file_count_label`, `test_set_context_populates_folder` | No test for multi-file add (`_add_files`), no test for output dir pre-population |
| AC2 - Batch Progress | Implemented | `test_progress_bar_updates`, `test_eta_displayed` | No test for per-document status transitions (En attente → En cours → Traité/Erreur) |
| AC3 - Validation Workflow | **NOT IMPLEMENTED** | None | Entire AC deferred — needs separate story |
| AC4 - Summary Report | Implemented | `test_summary_displays_results`, `test_export_report` | Covered |
| AC5 - Pause/Cancel | Implemented | `test_pause_toggles_text`, `test_cancel_stops_processing` | No test for cancel confirmation dialog |
| AC6 - Settings Enhancement | Implemented | `test_default_theme_roundtrip`, `test_batch_workers_roundtrip`, `test_defaults_include_new_keys` | Covered |
| AC7 - Database Screen | Implemented | `test_populate_entity_table`, `test_search_filters_entities`, `test_type_filter`, `test_info_label_initially_empty` | No test for DB open flow with passphrase prompt |
| AC8 - Entity Deletion | Implemented | `test_delete_calls_repo`, `test_checkbox_updates_selection_count`, `test_delete_disabled_when_nothing_selected` | No test for Article 17 confirmation dialog text |
| AC9 - Database Export | Implemented | `test_export_generates_csv`, `test_export_disabled_without_entities` | Covered |
| AC10 - Tests | Implemented | 36 unit + 2 integration tests for new code | See gaps above |
| AC11 - No CLI Regression | Verified | CLI test suite passes (1117 non-GUI tests) | Covered |
| AC12 - Performance | Partially | Worker runs on QThreadPool | DB screen operations on main thread (PERF-001) |

### Refactoring Performed

None — all issues documented as advisory recommendations below.

### Compliance Check

- Coding Standards: ✓ Absolute imports, type hints on public functions, no sensitive data logged, PascalCase/snake_case conventions followed
- Project Structure: ✓ Files match `12-unified-project-structure.md` locations; new screens/workers in correct directories
- Testing Strategy: ✓ pytest + pytest-qt, mock DocumentProcessor/open_database, signal-based worker tests, conftest fixtures follow established patterns
- All ACs Met: ✗ AC3 deferred; AC12 partial (PERF-001)

### Improvements Checklist

- [x] Remove dead `BatchWorkerSignals` class from batch_worker.py (CODE-001)
- [x] Add public `cached_passphrase` property to MainWindow (CODE-002)
- [x] Replace string-based pause state check with boolean flag (CODE-003)
- [x] Replace `datetime.utcnow()` with `datetime.now(timezone.utc)` in database.py (CODE-004)
- [x] Use `DocumentResult` dataclass in `per_document_results` instead of dict (CODE-005)
- [x] Add test for `_add_files()` multi-file selection
- [x] Add test for output directory pre-population from config
- [x] Add test for per-document status transitions in progress table
- [x] Add test for cancel confirmation dialog display
- [ ] Create follow-up story for AC3 (Batch Validation Workflow)
- [ ] Create follow-up story for PERF-001 (Database background thread operations)

### Security Review

- **Passphrase handling**: Passphrase is cached in `MainWindow._cached_passphrase` (session-only, never persisted). Database screen also stores `self._passphrase` as an instance attribute during the screen's lifetime. Both are in-memory only, cleared on app exit. Acceptable for desktop application.
- **Article 17 RGPD deletion**: Correctly logs ERASURE operation via `AuditRepository.log_operation()`. Confirmation dialog includes appropriate warning text. Entity deletion is properly committed within a database context manager.
- **No sensitive data logging**: Logger calls use structured fields (`error=str(e)`) without leaking entity names or passphrases.

### Performance Considerations

- **Batch worker**: Runs on `QThreadPool` background thread — GUI stays responsive during processing. Sequential document processing (no multiprocessing) avoids spaCy thread-safety issues.
- **Database screen**: Entity loading, deletion, and audit log queries run on the main thread (PERF-001). For databases with hundreds of encrypted entities, `_load_entities()` could cause noticeable UI freezes during decryption. Recommended: background worker for DB operations.
- **ETA calculation**: Simple linear extrapolation based on average time per document — adequate for batch sizes up to 50+.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/6.5-batch-processing-and-configuration-management.yml

### Recommended Status

✗ Changes Required — See unchecked items above.

Primary blocker rationale: AC3 deferral is acknowledged but should have a follow-up story created before this story moves to Done. CODE-001 through CODE-005 are advisory improvements that should be addressed but are not blocking.

(Story owner decides final status)

---

### Re-Review Date: 2026-02-20

### Reviewed By: Quinn (Test Architect)

### Re-Review Summary

Dev addressed **all 5 code quality issues** (CODE-001 through CODE-005) and **all 4 test gaps** identified in the initial review. Verified fixes:

| Issue | Fix Verified |
|-------|-------------|
| CODE-001 (dead `BatchWorkerSignals`) | Class removed from batch_worker.py |
| CODE-002 (private `_cached_passphrase`) | Public `cached_passphrase` property added to MainWindow (getter + setter). All callers updated. |
| CODE-003 (string-based pause state) | `self._is_paused` boolean flag added; `_toggle_pause()` uses flag instead of button text |
| CODE-004 (deprecated `datetime.utcnow()`) | Now uses `datetime.now(timezone.utc)` with proper import |
| CODE-005 (untyped `per_document_results`) | `BatchResult.per_document_results` typed as `list[DocumentResult]`; attribute access throughout |

**9 new tests added:**
- `TestAddFiles`: 3 tests (add, exclude pseudonymized, no duplicates)
- `TestOutputDirPrePopulation`: 2 tests (from config, default subfolder)
- `TestProgressStatusTransitions`: 2 tests (initial En cours, doc done transitions)
- `TestPauseCancel`: 2 additional tests (cancel dialog shown, cancel confirmed calls worker)

### Remaining Items (Unchanged)

- **DEFERRED-001**: AC3 (Batch Validation Workflow) — still deferred, needs follow-up story
- **PERF-001**: Database screen main-thread operations — still present, needs follow-up story

### Updated Gate Status

Gate: CONCERNS → docs/qa/gates/6.5-batch-processing-and-configuration-management.yml
Quality Score: 80/100 (improved from 70)

### Updated Recommended Status

✓ Conditionally Ready for Done — All code quality issues resolved. Create follow-up stories for AC3 and PERF-001 before closing.

(Story owner decides final status)

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### File List

**New Files:**
- `gdpr_pseudonymizer/gui/screens/batch.py` — Batch processing screen (3-phase QStackedWidget: selection, processing, summary)
- `gdpr_pseudonymizer/gui/screens/database.py` — Database management screen (entity listing, search, Article 17 deletion, CSV export)
- `gdpr_pseudonymizer/gui/workers/batch_worker.py` — Batch worker (QRunnable with pause/cancel, BatchResult/DocumentResult dataclasses, collect_files utility)
- `tests/unit/gui/test_batch_screen.py` — 19 unit tests for batch screen
- `tests/unit/gui/test_batch_worker.py` — 10 unit tests for batch worker
- `tests/unit/gui/test_database_screen.py` — 9 unit tests for database screen
- `tests/integration/gui/test_batch_integration.py` — 2 integration tests for batch end-to-end flow

**Modified Files:**
- `gdpr_pseudonymizer/gui/app.py` — Replaced StubScreen imports with BatchScreen and DatabaseScreen
- `gdpr_pseudonymizer/gui/config.py` — Added `default_theme`, `batch_workers`, `recent_databases` to _DEFAULT_CONFIG; added `add_recent_database()` helper
- `gdpr_pseudonymizer/gui/screens/settings.py` — Added QSpinBox workers spinner (1-8), QComboBox theme selector (neutral/star_wars/lotr)
- `gdpr_pseudonymizer/gui/screens/home.py` — Updated `_on_folder_selected()` to pass `folder_path` kwarg
- `gdpr_pseudonymizer/gui/main_window.py` — Extended `navigate_to()` with `**kwargs` + `set_context()` pattern; fixed `_on_open_folder()`
- `tests/unit/gui/conftest.py` — Replaced StubScreen with BatchScreen/DatabaseScreen in main_window fixture
- `tests/integration/gui/conftest.py` — Same replacement in integration_window fixture
- `tests/unit/gui/test_settings.py` — Added TestNewConfigKeys (4 tests) and TestRecentDatabases (3 tests)

### Debug Log References

- PySide6 rejects MagicMock as QWidget parent — test fixtures initially used MagicMock for MainWindow but PySide6's C-level type checking requires a real QWidget. Fixed by using the existing `main_window` conftest fixture pattern.
- Lazy imports defeat `@patch` at module-level — `DocumentProcessor`, `init_database`, `open_database` are lazy-imported inside methods. Patching at `gdpr_pseudonymizer.gui.workers.batch_worker.DocumentProcessor` fails because the attribute doesn't exist at module level. Fixed by patching at source: `gdpr_pseudonymizer.core.document_processor.DocumentProcessor`.
- mypy unused `type: ignore` comments — `per_document_results` was `list[dict[str, object]]`, initial ignore comments were overzealous. Resolved by CODE-005 (switched to `list[DocumentResult]` with attribute access).

### QA Fix Notes

- **CODE-001**: Removed dead `BatchWorkerSignals` class and empty `if TYPE_CHECKING: pass` block from batch_worker.py.
- **CODE-002**: Added `cached_passphrase` property + setter to `MainWindow`. Updated all consumers (batch.py, database.py, home.py, test_batch_integration.py) to use public property.
- **CODE-003**: Added `self._is_paused: bool` flag to `BatchScreen.__init__()`. `_toggle_pause()` now uses boolean flag instead of checking button text. Reset to `False` at start of each batch.
- **CODE-005**: Changed `BatchResult.per_document_results` from `list[dict[str, object]]` to `list[DocumentResult]`. Worker now appends `DocumentResult` directly. All consumers in batch.py (`_on_finished`, `_show_summary`, `_export_report`) updated to use dataclass attribute access. Test data updated from dicts to `DocumentResult` instances.
- **New tests added** (9 tests): `TestAddFiles` (3 tests), `TestOutputDirPrePopulation` (2 tests), `TestProgressStatusTransitions` (2 tests), cancel dialog tests (2 tests in `TestPauseCancel`).
- **Test count**: 240 GUI unit + 8 GUI integration + 1117 non-GUI = 1365 total. All pass.

### Completion Notes

- **AC3 (Batch Validation Workflow) NOT IMPLEMENTED**: Per-document and global validation modes are deferred. The batch worker processes documents with `skip_validation=True`. Implementing AC3 requires: (1) new signals on BatchWorker for validation_needed/validation_completed, (2) complex bi-directional navigation between BatchScreen and ValidationScreen, (3) worker pause/resume coordinated with validation completion. This is a substantial feature that should be its own story.
- **Task 4 Database Background Thread**: DB operations (load entities, delete) run on the main thread. For large databases this could cause momentary UI freezes. A DatabaseWorker (similar to DetectionWorker) would be needed for fully responsive operation.
- **Test Count**: 240 GUI unit tests (all pass), 8 GUI integration tests (all pass), 1117 non-GUI tests (all pass). Total: 1365 tests.
- **DATA-001 carry-forward**: The existing issue from Story 6.3 (ProcessingWorker entity type count) remains open and is unrelated to this story.
