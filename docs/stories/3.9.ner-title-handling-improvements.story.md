# Story 3.9: NER & Title Handling Improvements

## Status

**Draft**

---

## Story

**As a** user processing French legal documents with professional titles and organizations,
**I want** accurate entity detection and complete title preservation throughout the pseudonymization process,
**so that** professional titles (Maître, Me) are not lost and organization patterns (Cabinet X) are correctly detected as ORG entities.

---

## Context

This story addresses two critical bugs discovered during testing after Story 3.0 completion:

**Bug #3: "Cabinet" Pattern Misdetection**
- **Current Behavior:** "Cabinet Mercier & Associés" is detected as PERSON entity with "Cabinet" treated as a first name
- **Expected Behavior:** Should be detected as ORGANIZATION entity
- **Example:** In `tests/test_corpus/interview_transcripts/interview_05.txt`, "Antoine Mercier" is correctly detected as PERSON, but "Cabinet Mercier & Associés" on line 2 is incorrectly split with "Cabinet Mercier" as PERSON
- **Impact:** Legal document processing produces incorrect entity types, leading to confusion in validation and incorrect pseudonym selection

**Bug #4: Professional Title Stripping**
- **Current Behavior:** Professional titles "Maître" and "Me" (attorney titles in French) are stripped from final output
- **Expected Behavior:** Titles should be preserved in pseudonymized output (e.g., "Maître Dubois" → "Maître Rousseau")
- **Impact:** Loss of professional context in pseudonymized documents, which may be required for legal/academic use cases

**Root Cause Analysis:**
- Bug #3: NER model (spaCy `fr_core_news_lg`) struggles with French organization patterns, particularly "Cabinet" (law firm)
- Bug #4: Title detection and preservation logic (added in earlier stories) does not recognize "Maître"/"Me" as valid titles

**Dependencies:**
- No blocking dependencies - can be implemented independently
- Related to Story 3.2 (Interactive Validation Mode) for user experience improvements

---

## Acceptance Criteria

### AC1: Cabinet Pattern Detection
- Add pattern matching rules to detect "Cabinet [Name]" as ORGANIZATION entity
- Pattern should match:
  - `Cabinet [LastName]` (e.g., "Cabinet Mercier")
  - `Cabinet [LastName] & Associés` (e.g., "Cabinet Mercier & Associés")
  - `Cabinet [Name1] et [Name2]` (e.g., "Cabinet Dupont et Martin")
  - `Cabinet [Name1], [Name2] & Associés`
- Patterns should NOT match person names containing "Cabinet" as part of their actual name
- Implementation should use entity ruler or pattern matching before NER pipeline

### AC2: Organization Pattern Testing
- Unit tests for "Cabinet" pattern detection:
  - `test_cabinet_pattern_single_name()`: "Cabinet Mercier" → ORG
  - `test_cabinet_pattern_with_associates()`: "Cabinet Mercier & Associés" → ORG
  - `test_cabinet_pattern_multiple_names()`: "Cabinet Dupont et Martin" → ORG
  - `test_cabinet_pattern_not_person()`: Verify "Cabinet Mercier" is NOT detected as PERSON
- Integration test using `interview_05.txt` from test corpus:
  - Verify "Antoine Mercier" detected as PERSON
  - Verify "Cabinet Mercier & Associés" detected as ORG (not PERSON)

### AC3: Professional Title Recognition
- Extend title recognition to include:
  - "Maître" (full form)
  - "Me" (abbreviated form)
  - Support both with and without period: "Me." and "Me"
- Titles should be detected and preserved in same manner as existing titles (M., Mme, Mlle, Dr, Pr, etc.)
- Titles should be preserved in both:
  - Final pseudonymized output
  - Validation UI display (addresses Bug #2 from separate update)

### AC4: Title Preservation Testing
- Unit tests for title recognition:
  - `test_maitre_title_detection()`: "Maître Dubois" → PERSON with title "Maître"
  - `test_me_title_detection()`: "Me Dubois" → PERSON with title "Me"
  - `test_me_with_period_detection()`: "Me. Dubois" → PERSON with title "Me."
- Unit tests for title preservation in output:
  - `test_maitre_title_preserved_in_output()`: "Maître Dubois" → "Maître [Pseudonym]"
  - `test_me_title_preserved_in_output()`: "Me Dubois" → "Me [Pseudonym]"
- Integration test: Process document with professional titles, verify titles appear in final output

### AC5: Regression Testing
- All existing tests continue to pass
- No breaking changes to existing title detection (M., Mme, Dr, etc.)
- No breaking changes to existing PERSON/LOCATION/ORG detection

### AC6: Test Corpus Validation
- Update or add test corpus documents with:
  - "Cabinet" organization patterns
  - "Maître"/"Me" professional titles
- Verify end-to-end processing produces correct results

---

## Tasks / Subtasks

- [ ] **Task 3.9.1: Investigate Current NER & Title Detection Logic** (AC: 1, 3)
  - [ ] Read NER pipeline configuration to understand current entity detection
  - [ ] Read title detection/preservation logic to understand where titles are handled
  - [ ] Identify where "Cabinet" pattern should be added (entity ruler vs custom logic)
  - [ ] Identify where "Maître"/"Me" titles should be added to title list
  - [ ] Document findings for implementation

- [ ] **Task 3.9.2: Implement Cabinet Pattern Detection** (AC: 1)
  - [ ] Add entity ruler patterns for "Cabinet [Name]" variations
  - [ ] Implement pattern matching before NER pipeline to catch organization patterns
  - [ ] Ensure patterns do not interfere with legitimate PERSON entity detection
  - [ ] Add logging for detected Cabinet patterns (DEBUG level, no PII)

- [ ] **Task 3.9.3: Implement Professional Title Recognition** (AC: 3)
  - [ ] Extend title list to include "Maître", "Me", "Me." in title detection logic
  - [ ] Update title preservation logic to handle new titles
  - [ ] Ensure titles are preserved in final output generation
  - [ ] Verify titles work with compositional pseudonym logic (existing PERSON handling)

- [ ] **Task 3.9.4: Add Unit Tests for Cabinet Patterns** (AC: 2)
  - [ ] `test_cabinet_pattern_single_name()`: Verify "Cabinet Mercier" detected as ORG
  - [ ] `test_cabinet_pattern_with_associates()`: Verify "Cabinet Mercier & Associés" detected as ORG
  - [ ] `test_cabinet_pattern_multiple_names()`: Verify "Cabinet Dupont et Martin" detected as ORG
  - [ ] `test_cabinet_pattern_not_person()`: Verify "Cabinet Mercier" NOT detected as PERSON
  - [ ] Tests should cover edge cases (capitalization, spacing, etc.)

- [ ] **Task 3.9.5: Add Unit Tests for Professional Titles** (AC: 4)
  - [ ] `test_maitre_title_detection()`: Verify "Maître Dubois" detected with title
  - [ ] `test_me_title_detection()`: Verify "Me Dubois" detected with title
  - [ ] `test_me_with_period_detection()`: Verify "Me. Dubois" detected with title
  - [ ] `test_maitre_title_preserved_in_output()`: Verify title appears in pseudonymized output
  - [ ] `test_me_title_preserved_in_output()`: Verify title appears in pseudonymized output

- [ ] **Task 3.9.6: Add Integration Tests** (AC: 2, 4, 6)
  - [ ] Create or update test document with "Cabinet" patterns and professional titles
  - [ ] `test_cabinet_pattern_integration()`: Process document with "Cabinet Mercier & Associés", verify ORG detection
  - [ ] `test_professional_titles_integration()`: Process document with "Maître"/"Me" titles, verify preservation
  - [ ] Test using `interview_05.txt` from test corpus: Verify "Cabinet Mercier & Associés" detected as ORG

- [ ] **Task 3.9.7: Regression Testing** (AC: 5)
  - [ ] Run full test suite to verify no breaking changes
  - [ ] Verify existing title detection (M., Mme, Dr, etc.) still works
  - [ ] Verify existing PERSON/LOCATION/ORG detection unaffected
  - [ ] Address any test failures or regressions

- [ ] **Task 3.9.8: Update Test Corpus** (AC: 6)
  - [ ] Add or update test corpus documents with Cabinet patterns
  - [ ] Add or update test corpus documents with Maître/Me titles
  - [ ] Verify end-to-end processing on updated corpus

---

## Dev Notes

### Relevant Architecture Context

#### NER Pipeline & Entity Detection
**[Source: To be determined during Task 3.9.1]**

The NER pipeline uses spaCy's `fr_core_news_lg` model for French entity recognition. Current implementation likely includes:
- spaCy NER pipeline for base entity detection
- Custom entity ruler (if exists) for pattern-based detection
- Post-processing for entity validation

**Implementation Approach:**
- **Cabinet Pattern:** Use spaCy's EntityRuler to add patterns BEFORE NER pipeline
- **Title Recognition:** Extend existing title detection list (likely in entity parsing or validation logic)

#### Title Detection & Preservation
**[Source: To be determined during Task 3.9.1]**

Current title handling logic:
- Title detection: Identifies prefixes like "M.", "Mme", "Dr" before names
- Title preservation: Stores title separately, reconstructs in final output
- Existing titles supported: M., Mme, Mlle, Dr, Pr (to be confirmed)

**Bug #4 Root Cause:** "Maître" and "Me" not in title list

#### Entity Type Handling
**[Source: Story 3.0]**

Entity types currently supported:
- PERSON: Has titles, compositional logic (first_name + last_name)
- LOCATION: No titles, atomic entity
- ORGANIZATION: No titles, atomic entity

**Bug #3 Impact:** "Cabinet Mercier" detected as PERSON means it gets compositional pseudonym logic applied incorrectly

#### Project Structure
**[Source: architecture/12-unified-project-structure.md]**

Relevant file locations:
- **NER Pipeline:** `gdpr_pseudonymizer/ner/` (exact files TBD in Task 3.9.1)
- **Entity Validation:** `gdpr_pseudonymizer/validation/` or `gdpr_pseudonymizer/ner/`
- **Title Logic:** Likely in entity parsing/validation
- **Unit Tests:** `tests/unit/ner/` (create if needed)
- **Integration Tests:** `tests/integration/`
- **Test Corpus:** `tests/test_corpus/interview_transcripts/interview_05.txt` (existing)

#### Tech Stack & Coding Standards
**[Source: architecture/3-tech-stack.md]**

- **Python:** 3.9-3.11 supported
- **NLP:** spaCy 3.7+, model `fr_core_news_lg`
- **Build System:** Poetry - ALWAYS use `poetry run pytest`, `poetry run ruff`, etc.
- **Testing:** pytest 7.4+, pytest-cov for coverage (target: ≥85% for Epic 3)

**[Source: architecture/19-coding-standards.md]**

**CRITICAL COMMANDS:**
```bash
# Run tests
poetry run pytest tests/

# Run linting
poetry run ruff check gdpr_pseudonymizer/

# Run type checking
poetry run mypy gdpr_pseudonymizer/
```

**Coding Standards:**
- Absolute imports only
- Type hints required on all public methods
- No sensitive data logging (log entity_type only, never actual names)

---

## Testing

**[Source: architecture/16-testing-strategy.md]**

### Testing Standards

**Test File Locations:**
- Unit tests: `tests/unit/ner/test_cabinet_patterns.py`, `tests/unit/ner/test_professional_titles.py`
- Integration tests: `tests/integration/test_ner_title_improvements.py`

**Coverage Target:** ≥85% for Epic 3

**Test Execution:**
```bash
# Run all tests
poetry run pytest tests/

# Run specific test file
poetry run pytest tests/unit/ner/test_cabinet_patterns.py

# Run with coverage report
poetry run pytest tests/ --cov=gdpr_pseudonymizer --cov-report=term-missing
```

### Test Categories for Story 3.9

**Unit Tests (Primary Focus):**
- Cabinet pattern detection (4+ tests)
- Professional title detection (3+ tests)
- Title preservation in output (2+ tests)
- Edge cases (capitalization, spacing, punctuation)

**Integration Tests:**
- End-to-end with Cabinet patterns
- End-to-end with professional titles
- Test corpus validation (interview_05.txt)

**Regression Tests:**
- All existing tests must pass
- Verify no breaking changes to title/entity detection

---

## Change Log

| Date       | Version | Description                          | Author         |
|------------|---------|--------------------------------------|----------------|
| 2026-02-02 | 1.0     | Initial story draft created from user bug report | Sarah (PO Agent) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used

TBD

### Debug Log References

TBD

### Completion Notes

TBD

### File List

TBD

---

## QA Results

*This section will be populated by the QA agent during review.*
