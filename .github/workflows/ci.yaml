name: CI - Test Matrix

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

permissions:
  contents: read

jobs:
  # ── Lint (runs once, fast) ──────────────────────────────────────────
  lint:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry>=1.7.0

      - name: Configure in-project virtualenv
        run: poetry config virtualenvs.in-project true

      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-lint-py3.11-${{ hashFiles('**/poetry.lock') }}
          restore-keys: venv-lint-py3.11-

      - name: Install dependencies
        run: poetry install --no-interaction --extras "formats gui"

      - name: Ruff
        run: poetry run ruff check .

      - name: Black
        run: poetry run black --check .

      - name: Mypy
        run: poetry run mypy gdpr_pseudonymizer

  # ── Tests (reduced matrix: 4 jobs instead of 9) ────────────────────
  # - Ubuntu 3.11: primary (full coverage + Codecov)
  # - Ubuntu 3.10: oldest supported Python
  # - macOS 3.12:  cross-platform + newest Python
  # - Windows 3.12: cross-platform, non-spaCy tests only
  test:
    needs: lint
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            python-version: '3.11'
            coverage: true
          - os: ubuntu-22.04
            python-version: '3.10'
            coverage: false
          - os: macos-latest
            python-version: '3.12'
            coverage: false
          - os: windows-latest
            python-version: '3.12'
            coverage: false

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc

      - name: Install Qt system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libegl1 libxkbcommon0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry>=1.7.0

      - name: Configure in-project virtualenv
        run: poetry config virtualenvs.in-project true

      # Cache the full virtualenv (includes spaCy model after first run)
      - name: Cache virtualenv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: venv-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Install dependencies
        run: poetry install --no-interaction --extras "formats gui"

      # Poetry installs both typer 0.9.4 (our dep) and typer-slim 0.21.1
      # (spaCy → weasel dep). Both write to the typer/ namespace and
      # typer-slim can overwrite typer 0.9.4's _typing.py, causing
      # IndentationError. Re-install typer to ensure 0.9.4 files win.
      - name: Fix typer/typer-slim namespace conflict
        run: poetry run pip install --force-reinstall --no-deps typer==0.9.4

      - name: Download spaCy model
        if: runner.os != 'Windows'
        run: poetry run python -m spacy download fr_core_news_lg

      - name: Run tests with coverage and benchmarks
        if: ${{ matrix.coverage }}
        env:
          OMP_NUM_THREADS: 1
          QT_QPA_PLATFORM: offscreen
        run: poetry run pytest --cov=gdpr_pseudonymizer --cov-report=xml --cov-report=term --cov-branch -v --benchmark-json=benchmark-results.json --benchmark-max-time=60

      - name: Run tests (Linux/macOS)
        if: ${{ !matrix.coverage && runner.os != 'Windows' }}
        env:
          OMP_NUM_THREADS: 1
          QT_QPA_PLATFORM: offscreen
        run: poetry run pytest -v

      # Windows: skip spaCy-dependent tests due to access violations
      # See: https://github.com/explosion/spaCy/issues/12659
      # Tests marked with @pytest.mark.spacy are excluded automatically.
      - name: Run non-spaCy tests (Windows)
        if: runner.os == 'Windows'
        env:
          QT_QPA_PLATFORM: offscreen
        run: poetry run pytest -m "not spacy" -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: ${{ matrix.coverage }}
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-ubuntu-py3.11
          fail_ci_if_error: false

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        if: ${{ matrix.coverage && always() }}
        with:
          name: coverage-ubuntu-py3.11
          path: coverage.xml
          retention-days: 7

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: ${{ matrix.coverage && always() }}
        with:
          name: benchmark-results
          path: benchmark-results.json
          retention-days: 30
